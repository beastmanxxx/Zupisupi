<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="applogo.png" sizes="32x32" type="image/png">
    <link rel="icon" href="applogo.png" sizes="16x16" type="image/png">

    <title>Zupisupi</title>
    <link href="https://fonts.googleapis.com/css2?family=Honk&family=Macondo&family=Mrs+Sheppards&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Hide all scrollbars globally */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        
        *::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Full responsive design - 100% width on all devices */
        .container {
            width: 100%;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 0 24px;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                padding: 0 32px;
            }
        }

        /* Login Screen Styles - Hidden by default */
        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logo-section {
            margin-bottom: 30px;
        }

        .logo-section img {
            height: 80px;
            width: auto;
            margin-bottom: 20px;
        }

        .logo-section h1 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .logo-section p {
            color: #718096;
            font-size: 16px;
        }

        /* Authentication Form Styles */
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 30px;
        }

        .form-group {
            position: relative;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: #f8f9fa;
            box-sizing: border-box;
            line-height: 1.5;
        }

        .form-group input:focus {
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input::placeholder {
            color: #a0aec0;
        }

        .auth-btn {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .form-switch {
            text-align: center;
            margin-top: 20px;
        }

        .form-switch p {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }

        .form-switch a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }

        .form-switch a:hover {
            text-decoration: underline;
        }

        /* Main App Styles (Show by default) */
        .main-app {
            display: block;
        }

        @media (min-width: 1024px) {
            .main-app {
                max-width: 70vw;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            }
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid #7c3aed;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        /* Full width navbar for all devices */
        .navbar {
            width: 100%;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .location-info {
            color: white;
        }

        .work-label {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.9;
        }

        .location-text {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown-arrow {
            font-size: 10px;
            opacity: 0.8;
        }

        @media (min-width: 1024px) {
            .nav-container {
                padding: 0 32px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo img {
            height: 55px;
            width: auto;
            object-fit: contain;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4a5568;
            position: relative;
        }

        .icon-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .icon-btn svg {
            width: 28px;
            height: 28px;
        }

        .cart-btn {
            position: relative;
        }

        .cart-icon-container {
            position: relative;
            display: inline-block;
        }

        .cart-icon {
            filter: brightness(0.6);
            font-size: 24px;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }


        .profile-btn {
            background: white !important;
            color: black !important;
            border: none !important;
            padding: 12px !important;
            border-radius: 50% !important;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            width: 48px !important;
            height: 48px !important;
        }

        .profile-btn:hover {
            background: #f8f9fa !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }

        .profile-btn svg {
            width: 24px;
            height: 24px;
        }

        .main-content {
            margin-top: 72px;
            padding: 0;
            background: white;
            min-height: calc(100vh - 72px);
        }
        
        @media (min-width: 768px) {
            .main-content {
                margin-top: 80px;
                min-height: calc(100vh - 80px);
            }
        }

        .welcome-message {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        /* Modern Hero Banner Styles - Flipkart Style */
        .slideshow-container {
            position: relative;
            margin: 10px auto 20px;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e6ed;
            height: 250px;
        }
        
        .slides-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        
        .container .slideshow-container {
            max-width: none;
            margin: 0 0 20px;
        }
        
        @media (min-width: 768px) {
            .slideshow-container {
                margin: 10px auto 20px;
            }
            
            .container .slideshow-container {
                margin: 0 0 20px;
            }
        }

        .slides {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
        }
        
        .slides img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.4s ease;
        }
        
        .slides:hover img {
            transform: scale(1.05);
        }
        
        /* Flipkart-style navigation arrows */
        .slideshow-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #2874f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .slideshow-nav:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }
        
        .slideshow-nav.prev {
            left: 15px;
        }
        
        .slideshow-nav.next {
            right: 15px;
        }
        
        @media (max-width: 768px) {
            .slideshow-nav {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .slideshow-nav.prev {
                left: 10px;
            }
            
            .slideshow-nav.next {
                right: 10px;
            }
        }


        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateX(30px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Slideshow indicators */
        .dots-container {
            text-align: center;
            margin-top: 8px;
        }

        .dot {
            height: 8px;
            width: 8px;
            margin: 0 3px;
            background: #c2c8d0;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot.active {
            background: #2874f0;
            transform: scale(1.3);
        }
        
        .dot:hover {
            background: #2874f0;
            opacity: 0.7;
        }

        /* Modern Categories Section */
        .categories-section {
            background: transparent;
            margin: 0px;
            border-radius: 15px;
            padding: 0px;
            margin-bottom: 0px;
            width: 100%;
        }

        .section-title {
            text-align: center;
            font-size: 22px;
            color: #1a202c;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 10px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .categories-section .section-title {
            color: black;
        }
        
        
        @media (min-width: 768px) {
            .section-title {
                font-size: 26px;
                margin-bottom: 16px;
            }
        }

        .categories-row {
            display: flex;
            gap: 0px;
            overflow-x: auto;
            scroll-behavior: smooth;
            border-radius: 0px 0px 25px 25px;
        }
        
        @media (min-width: 640px) {
            .categories-grid {
                gap: 0px;
            }
        }
        
        @media (min-width: 1024px) {
            .categories-grid {
                gap: 0px;
            }
        }

        .categories-grid::-webkit-scrollbar {
            height: 6px;
        }
        
        .categories-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        .categories-grid::-webkit-scrollbar-thumb {
            background: rgba(251, 191, 36, 0.5);
            border-radius: 3px;
        }
        
        .categories-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 191, 36, 0.8);
        }

        .category-item {
            background: transparent;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            width: 70px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            transform: translateZ(0);
        }

        .category-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #e2e8f0;
        }

        .category-image {
            width: 100%;
            height: 60px;
            object-fit: cover;
            background: transparent;
            border-radius: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        @media (min-width: 640px) {
            .category-image {
                height: 70px;
            }
        }

        .category-info {
            padding: 12px 8px;
            text-align: center;
        }

        .category-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin: 4px 0 0 0;
            line-height: 1.2;
            width: 100%;
        }
        
        @media (min-width: 640px) {
            .category-name {
                font-size: 15px;
            }
        }

        /* Modern Products Section */
        .products-section {
            margin: 5px 0;
            background: white;
            padding: 8px 0;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: #fbbf24;
            border-radius: 30px;
        }
        
        .products-grid .section-title {
            color: #1f2937;
            grid-column: 1 / -1;
            margin-bottom: 16px;
            font-weight: 700;
            text-align: center;
            font-size: 28px;
        }
        
        @media (min-width: 640px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
            }
        }
        
        @media (min-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 28px;
            }
        }
        
        @media (min-width: 1024px) {
            .products-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 30px;
            }
        }
        
        @media (min-width: 1280px) {
            .products-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 32px;
            }
        }


        .product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-card:hover {
            transform: translateY(-2px);
            border-color: #3b82f6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .product-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            display: block;
            background: #f8fafc;
        }
        
        @media (min-width: 640px) {
            .product-image {
                height: 140px;
            }
        }
        
        @media (min-width: 1024px) {
            .product-image {
                height: 160px;
            }
        }

        .product-info {
            padding: 12px;
        }
        
        @media (min-width: 640px) {
            .product-info {
                padding: 16px;
            }
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Better styling for event product cards */
        .event-products .product-card {
            height: 240px !important;
            display: flex;
            flex-direction: column;
        }
        
        .event-products .product-card .product-image {
            height: 120px;
            flex-shrink: 0;
        }
        
        .event-products .product-card .product-info {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .event-products .product-card .product-name {
            -webkit-line-clamp: 2;
            line-clamp: 2;
            font-size: 13px;
            line-height: 1.3;
            height: auto;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        .event-products .product-card .product-price {
            font-size: 14px;
            margin-bottom: 0;
            margin-top: auto;
        }
        
        /* Discount styling for event product cards */
        .event-products .product-card .product-price-container {
            margin-top: auto;
        }
        
        .event-products .product-card .special-price-label {
            color: #27ae60 !important;
            font-size: 10px !important;
            font-weight: 600 !important;
            margin-bottom: 2px !important;
        }
        
        .event-products .product-card .price-row {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            flex-wrap: wrap !important;
        }
        
        .event-products .product-card .current-price {
            color: #27ae60 !important;
            font-size: 14px !important;
            font-weight: 700 !important;
        }
        
        .event-products .product-card .original-price {
            color: #999 !important;
            font-size: 11px !important;
            text-decoration: line-through !important;
        }
        
        .event-products .product-card .discount-badge {
            background: #27ae60 !important;
            color: white !important;
            padding: 1px 4px !important;
            border-radius: 3px !important;
            font-size: 9px !important;
            font-weight: 600 !important;
        }
        
        .event-products .product-card .product-rating {
            color: #fbbf24 !important;
            font-size: 11px !important;
            margin: 2px 0 !important;
        }
        
        @media (min-width: 640px) {
            .product-name {
                font-size: 15px;
            }
        }
        
        @media (min-width: 1024px) {
            .product-name {
                font-size: 16px;
            }
        }

        .product-description {
            display: none;
        }

        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 12px;
        }
        
        @media (min-width: 640px) {
            .product-price {
                font-size: 18px;
                margin-bottom: 16px;
            }
        }

        .product-buttons {
            display: none;
        }

        /* Product cards no longer show buttons */

        /* Full Viewport Product Modal */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 0;
            overflow-y: auto;
        }

        .product-modal-content {
            background: white;
            border-radius: 0;
            width: 100vw;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: none;
        }

        .product-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
            background: #fafbfc;
            border-radius: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .product-modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .product-modal-body {
            padding: 24px;
            box-sizing: border-box;
        }

        .product-modal-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .product-modal-name {
            font-size: 22px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .product-modal-price {
            font-size: 24px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 16px;
        }

        .product-modal-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .product-modal-quantity {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .quantity-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #3498db;
            color: white;
        }

        .quantity-input {
            width: 50px;
            height: 30px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .total-price {
            font-size: 16px;
            font-weight: 700;
            color: #27ae60;
            margin-left: auto;
        }

        .product-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .product-modal-buttons .btn-cart,
        .product-modal-buttons .btn-order {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quantity-input {
            width: 50px;
            height: 30px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .total-price {
            font-size: 16px;
            font-weight: 700;
            color: #27ae60;
            margin-left: auto;
        }

        /* Related Products Styles */
        .related-products-section,
        .cart-related-products {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .related-products-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            text-align: center;
        }

        .related-products-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
        }

        .related-products-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .related-products-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .related-products-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 3px;
        }

        .related-product-card {
            flex: 0 0 320px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .related-product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #f59e0b;
        }

        .related-product-image {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .related-product-name {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }

        .related-product-price {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
        }

        @media (max-width: 768px) {
            .related-product-card {
                flex: 0 0 260px;
                padding: 18px;
            }
            
            .related-product-image {
                height: 140px;
            }
            
            .related-products-title {
                font-size: 16px;
            }
        }

        /* Zupisupi Footer Styles */
        .zupisupi-footer {
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            background: white;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .footer-logo {
            height: 24px;
            width: auto;
        }

        .footer-text {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .footer-reserved {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .zupisupi-footer {
                margin-top: 15px;
                padding: 12px 0;
            }
            
            .footer-text {
                font-size: 13px;
            }
            
            .footer-reserved {
                font-size: 11px;
            }
        }

        /* Category Modal Styles */
        .category-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .category-modal.open {
            display: flex;
        }

        .category-modal-content {
            background: white;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .category-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #fbbf24;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            transition: transform 0.3s ease;
        }

        .category-modal-header.hidden {
            transform: translateY(-100%);
        }

        .category-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .category-back-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #1f2937;
            transition: all 0.3s ease;
            gap: 8px;
        }

        .category-back-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateX(-2px);
        }

        .category-search-section {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: top 0.3s ease;
        }

        .category-search-section.sticky {
            top: 0;
        }

        .category-search-wrapper {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .category-search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #000000;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .category-search-input-wrapper:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .category-search-container input {
            width: 100%;
            padding: 16px 60px 16px 24px;
            border: none;
            border-radius: 23px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            color: #000000;
            font-weight: 500;
            box-shadow: none;
        }

        .category-search-container input:focus {
            background: #ffffff;
            color: #000000;
        }

        .category-search-container input::placeholder {
            color: #666666;
            font-weight: 400;
        }

        .category-search-icon-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #000000;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            font-size: 16px;
            transition: all 0.3s ease;
            color: white;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .category-search-icon-btn:hover {
            transform: translateY(-50%) scale(1.05);
            background: #333333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .category-search-icon-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Category Banner Section Styling */
        .category-banner-section {
            padding: 0;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            height: 150px;
            overflow: hidden;
            margin-top: 15px;
            transition: all 0.3s ease;
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        .category-banner-section.hidden {
            opacity: 0;
            transform: translateY(-100%);
            height: 0;
            margin-top: 0;
        }

        .category-banner-image {
            width: calc(100% - 20px);
            height: 100%;
            object-fit: cover;
            margin: 0 10px;
            border-radius: 30px;
        }

        /* Category Modal Content Layout */
        .category-modal-body {
            display: flex;
            height: calc(100vh - 140px);
            margin-top: 20px;
            transition: height 0.3s ease, margin-top 0.3s ease;
        }
        
        .category-modal-body.banner-visible {
            margin-top: 350px;
        }

        .category-modal-body.sticky-mode {
            height: calc(100vh - 70px);
        }

        .category-sidebar {
            width: 20%;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            padding: 15px;
            max-height: calc(100vh - 400px);
            transition: padding-top 0.3s ease, max-height 0.3s ease;
        }

        .category-sidebar.sticky-mode {
            padding-top: 100px;
            max-height: calc(100vh - 70px);
        }

        .category-products-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 10px 20px;
            transition: padding-top 0.3s ease;
        }

        .category-products-area.sticky-mode {
            padding-top: 180px;
        }

        /* Subcategories Sidebar Styling */
        .subcategories-sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #fbbf24;
        }

        .subcategories-list {
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

        .subcategory-sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin-bottom: 0px;
            border-radius: 15px;
            background: transparent;
        }

        .subcategory-sidebar-item:hover {
            transform: translateY(-5px);
        }

        .subcategory-sidebar-item:hover .subcategory-sidebar-image {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .subcategory-sidebar-item.active .subcategory-sidebar-image {
            border: 3px solid #fbbf24;
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
        }

        .subcategory-sidebar-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .subcategory-sidebar-name {
            font-size: 11px;
            font-weight: 500;
            color: #374151;
            line-height: 1.2;
            max-width: 80px;
            word-wrap: break-word;
            text-align: center;
        }

        .subcategory-sidebar-item.active .subcategory-sidebar-name {
            color: #fbbf24;
            font-weight: 600;
        }

        /* Subcategories Section Styling */
        .subcategories-section {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .subcategories-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: thin;
            scrollbar-color: #fbbf24 #f3f4f6;
        }

        .subcategories-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .subcategories-scroll::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 3px;
        }

        .subcategories-scroll::-webkit-scrollbar-thumb {
            background: #fbbf24;
            border-radius: 3px;
        }

        /* Subcategory Cards Styling */
        .subcategory-card {
            flex-shrink: 0;
            width: 60px;
            height: 70px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 12px;
            padding: 6px;
            transition: all 0.3s ease;
        }

        .subcategory-card:hover {
            transform: translateY(-2px);
        }

.subcategory-image {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.subcategory-card:hover .subcategory-image {
    border-color: #fbbf24;
    box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
}

.subcategory-card.active .subcategory-image {
    border-color: #fbbf24;
    box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
}

.subcategory-name {
    font-size: 9px;
    color: #6b7280;
    text-align: center;
    margin-top: 2px;
    font-weight: 500;
    line-height: 1.1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

        .subcategory-card.active .subcategory-name {
            color: #1f2937;
            font-weight: 600;
        }

        .subcategory-card.active {
            transform: translateY(-2px);
        }

        .category-products-container {
            background: #fbbf24;
            border-radius: 40px;
            margin: 10px;
            min-height: auto;
        }

        .category-products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* Mobile: 2 cards per row */
        @media (max-width: 768px) {
            .category-products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .category-products-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 10px;
            }
        }

        /* Tablet: 3 cards per row */
        @media (min-width: 769px) and (max-width: 1024px) {
            .category-products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 18px;
                padding: 18px;
            }
        }

        /* Desktop: 4+ cards per row */
        @media (min-width: 1025px) {
            .category-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
                padding: 20px;
            }
        }

        /* Small mobile: still 2 cards per row but smaller */
        @media (max-width: 360px) {
            .category-products-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                padding: 10px;
            }
        }

        /* Tablet: 3-4 cards per row */
        @media (min-width: 481px) and (max-width: 1024px) {
            .category-products-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
            }
        }

        .category-product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Extra small mobile: 320px and below */
        @media (max-width: 320px) {
            .category-product-card {
                border-radius: 8px;
                min-height: 200px;
            }
            
            .category-product-image {
                height: 80px !important;
            }
            
            .category-product-info {
                padding: 6px !important;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .category-product-name {
                font-size: 11px !important;
                line-height: 1.2 !important;
                margin-bottom: 4px !important;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            .category-product-price {
                font-size: 12px !important;
                margin: 2px 0 !important;
            }
            
            .category-view-btn {
                padding: 4px 8px !important;
                font-size: 10px !important;
                margin-top: auto;
            }
        }

        /* Small mobile: 321px to 480px */
        @media (min-width: 321px) and (max-width: 480px) {
            .category-product-card {
                border-radius: 12px;
                min-height: 220px;
            }
            
            .category-product-image {
                height: 100px !important;
            }
            
            .category-product-info {
                padding: 8px !important;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .category-product-name {
                font-size: 12px !important;
                line-height: 1.3 !important;
                margin-bottom: 6px !important;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            .category-product-price {
                font-size: 13px !important;
                margin: 4px 0 !important;
            }
            
            .category-view-btn {
                padding: 6px 10px !important;
                font-size: 11px !important;
                margin-top: auto;
            }
        }

        /* Medium mobile/small tablet: 481px to 768px */
        @media (min-width: 481px) and (max-width: 768px) {
            .category-product-card {
                border-radius: 12px;
                min-height: 260px;
            }
            
            .category-product-image {
                height: 140px !important;
            }
            
            .category-product-info {
                padding: 10px !important;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .category-product-name {
                font-size: 14px !important;
                line-height: 1.3 !important;
                margin-bottom: 8px !important;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            .category-product-price {
                font-size: 15px !important;
                margin: 6px 0 !important;
            }
            
            .category-view-btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                margin-top: auto;
            }
        }

        /* Tablet: 769px to 1024px */
        @media (min-width: 769px) and (max-width: 1024px) {
            .category-product-card {
                min-height: 300px;
            }
            
            .category-product-image {
                height: 160px !important;
            }
            
            .category-product-info {
                padding: 12px !important;
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .category-product-name {
                font-size: 15px !important;
                margin-bottom: 8px !important;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            .category-view-btn {
                margin-top: auto;
            }
        }

        /* Desktop: 1025px and above */
        @media (min-width: 1025px) {
            .category-product-card {
                min-height: 320px;
            }
            
            .category-product-info {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .category-product-name {
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            .category-view-btn {
                margin-top: auto;
            }
        }

        .category-product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }

        .category-product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f8fafc;
        }

        .category-product-info {
            padding: 15px;
        }

        .category-product-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 6px 0;
            line-height: 1.3;
        }

        .category-product-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .category-product-price {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .category-current-price {
            font-size: 13px;
            font-weight: 700;
            color: #27ae60;
        }

        .category-original-price {
            font-size: 10px;
            color: #6b7280;
            text-decoration: line-through;
        }

        .category-discount-badge {
            background: #27ae60;
            color: white;
            padding: 1px 4px;
            border-radius: 6px;
            font-size: 8px;
            font-weight: 600;
            text-align: center;
        }

        .category-view-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1f2937;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .no-products-message {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .category-modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .category-products-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
                padding: 15px !important;
            }

            .category-modal-title {
                font-size: 20px;
            }
        }

        /* Cart Section Styles */

        .cart-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .cart-item-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: white;
            margin-right: 12px;
            border: 1px solid #e5e7eb;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 2px;
            font-size: 14px;
            line-height: 1.3;
        }

        .cart-item-price {
            color: #059669;
            font-weight: 600;
            font-size: 13px;
        }

        .cart-item-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .cart-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .cart-total {
            padding: 20px;
            border-top: 2px solid #eee;
            background: #f8f9fa;
        }

        .cart-total-amount {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .cart-checkout {
            width: 100%;
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        @media (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
            }
        }

        /* Modern Bottom Navigation */
        .app-bottom-nav {
            position: fixed;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 8000;
            height: 70px;
            border-radius: 20px;
            .main-app {
                display: none;
                min-height: 100vh;
                background: #f8fafc;
                padding-top: 80px;
            }

            @media (min-width: 1024px) {
                .main-app {
                    max-width: 60vw;
                    margin: 0 auto;
                    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                }
            }
            border-top: 1px solid #e5e7eb;
        }

        /* Full width bottom nav for all devices */
        @media (min-width: 768px) {
            .app-bottom-nav {
                padding: 16px 24px;
                height: 84px;
                bottom: 5px;
                left: 5px;
                right: 5px;
                border-radius: 20px;
            }
        }

        /* Hide navbar by default */
        .app-bottom-nav.hidden {
            display: none !important;
        }

        .app-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 16px;
            min-width: 64px;
            position: relative;
            flex: 1;
            max-width: 80px;
        }

        .app-nav-item:hover {
            background: rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .app-nav-item.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }

        .app-nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }

        .app-nav-item.active .app-nav-icon {
            transform: scale(1.15);
        }

        .app-nav-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            letter-spacing: -0.01em;
        }

        /* Cart count badge in bottom navbar */
        .cart-nav-item .app-nav-icon {
            position: relative;
        }

        .cart-nav-item .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-width: 18px;
        }

        /* Add bottom padding to main content to avoid overlap */
        .main-app {
            padding-bottom: 96px; /* Space for new navbar */
        }

        /* Desktop responsive design with bottom navbar */
        @media (min-width: 769px) {
            .main-app {
                padding-bottom: 100px; /* Space for new navbar */
            }
            
            .login-container {
                max-width: 400px;
            }
        }

        /* App Sections Styles */
        .app-section {
            display: none;
        }

        .app-section.active {
            display: block;
        }

        /* Search Section Styles */
        .search-page {
            width: 100%;
            margin: 0 auto;
            padding: 0;
            max-width: 1400px;
            overflow-x: hidden;
        }
        
        .search-results {
            width: 100%;
            overflow-x: hidden;
        }

        .search-header {
            margin-bottom: 30px;
        }

        .navbar {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            padding: 16px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .search-categories-container {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            padding: 20px 0 0 0;
            margin: 80px 0 0 0;
        }

        .search-bar-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            height: 20px;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .search-input-wrapper:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .search-input {
            width: 100%;
            padding: 12px 60px 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            color: #000000;
            font-weight: 500;
            box-shadow: none;
        }

        .search-input:focus {
            background: #ffffff;
            color: #000000;
        }

        .search-input::placeholder {
            color: #666666;
            font-weight: 400;
        }

        .search-icon-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: #000000;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            font-size: 16px;
            transition: all 0.3s ease;
            color: white;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .search-icon-btn:hover {
            transform: translateY(-50%) scale(1.05);
            background: #333333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .search-icon-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-btn {
            padding: 16px 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .search-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        /* Modern Page Sections */
        .orders-page, .profile-page, .cart-page {
            background: white;
            margin: 24px 0;
            padding: 32px 0;
        }
        
        /* Events Section Styles */
        .events-section {
            margin: 20px 0;
        }
        
        .event-card {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 20px;
            margin: 20px 18px;
            padding: 10px;
            min-height: 300px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Extra small mobile: 320px and below */
        @media (max-width: 320px) {
            .event-card {
                margin: 10px 8px;
                padding: 8px;
                min-height: 200px;
                border-radius: 12px;
            }
            
            .event-title {
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }
        }

        /* Small mobile: 321px to 480px */
        @media (min-width: 321px) and (max-width: 480px) {
            .event-card {
                margin: 12px 10px;
                padding: 8px;
                min-height: 220px;
                border-radius: 15px;
            }
            
            .event-title {
                font-size: 18px !important;
                margin-bottom: 12px !important;
            }
        }

        /* Medium mobile/small tablet: 481px to 768px */
        @media (min-width: 481px) and (max-width: 768px) {
            .event-card {
                margin: 15px 12px;
                padding: 10px;
                min-height: 250px;
                border-radius: 18px;
            }
            
            .event-title {
                font-size: 20px !important;
                margin-bottom: 15px !important;
            }
        }

        /* Tablet: 769px to 1024px */
        @media (min-width: 769px) and (max-width: 1024px) {
            .event-card {
                margin: 18px 15px;
                padding: 12px;
                min-height: 280px;
            }
            
            .event-title {
                font-size: 22px !important;
                margin-bottom: 18px !important;
            }
        }

        /* Desktop: 1025px and above */
        @media (min-width: 1025px) {
            .event-card {
                margin: 20px 18px;
                padding: 15px;
                min-height: 300px;
            }
        }
        
        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }
        
        .event-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .event-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        
        .categories-grid {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 0px 10px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            transform: translateZ(0);
            will-change: scroll-position;
        }
        
        .categories-grid .subcategory-card {
            flex-shrink: 0;
            width: 80px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        .categories-grid .subcategory-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid transparent;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            transform: translateZ(0);
        }
        
        .categories-grid .subcategory-card:hover .subcategory-image {
            border-color: #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        
        .categories-grid .subcategory-name {
            font-size: 10px;
            padding: 5px 2px 0px 2px;
            text-align: center;
            color: #374151;
            font-weight: 500;
            line-height: 1.2;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .event-products {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 0px 0;
            scroll-behavior: smooth;
        }
        
        .event-products.template-1 {
            display: flex;
            gap: 12px;
        }
        
        .event-products.template-1 .product-card {
            flex-shrink: 0;
            min-width: 180px;
            max-width: 180px;
            width: 180px;
        }
        
        .event-products.template-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            overflow-x: visible;
        }
        
        .event-products.template-2 .product-card {
            width: 100%;
            min-width: auto;
            max-width: none;
        }
        
        .event-products.template-3 {
            display: flex;
            gap: 20px;
        }
        
        .event-products.template-3 .product-card {
            flex-shrink: 0;
            min-width: 250px;
            max-width: 250px;
            width: 250px;
        }
        
        .event-products.template-4 {
            display: flex;
            gap: 8px;
        }
        
        .event-products.template-4 .product-card {
            flex-shrink: 0;
            min-width: 140px;
            max-width: 140px;
            width: 140px;
        }
        
        
        
        .event-products .product-card {
            flex-shrink: 0;
            min-width: 200px;
            max-width: 200px;
            width: 200px;
            height: 220px;
        }
        
        @media (min-width: 640px) {
            .event-products .product-card {
                min-width: 200px;
                max-width: 200px;
                width: 200px;
                height: 240px;
            }
        }
        
        @media (min-width: 1024px) {
            .event-products .product-card {
                min-width: 220px;
                max-width: 220px;
                width: 220px;
                height: 260px;
            }
        }
        
        .event-products::-webkit-scrollbar {
            height: 6px;
        }
        
        .event-products::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .event-products::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
        }
        

        /* Featured Products Wrapper */
        .featured-products-wrapper {
            background: yellow;
            padding: 20px 0;
            margin: 20px 0;
            border-radius: 50px;
        }
        
        /* Profile Styles */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 16px 0;
            margin-bottom: 16px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 16px;
            border: 3px solid #e2e8f0;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 2px 0;
        }
        
        .profile-email {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }
        
        .edit-profile-btn {
            background: #1f2937;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .profile-menu {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #f1f5f9;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .profile-menu-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: white;
            cursor: pointer;
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            color: #6b7280;
        }
        
        .menu-content {
            flex: 1;
        }
        
        .menu-title {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .menu-subtitle {
            font-size: 13px;
            color: #6b7280;
        }
        
        .menu-arrow {
            color: #9ca3af;
            font-size: 18px;
        }

        /* Cart Section Main Page Styles */
        .cart-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-top: 20px;
        }

        .cart-items-main {
            margin-bottom: 20px;
        }

        .cart-item-main {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        .cart-item-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #e2e8f0;
        }

        .cart-item-image-main {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 12px;
            background: #f8fafc;
            margin-right: 16px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .cart-item-info-main {
            flex: 1;
            cursor: pointer;
        }

        .cart-item-name-main {
            font-weight: 500;
            color: #111827;
            margin-bottom: 4px;
            font-size: 15px;
            line-height: 1.4;
        }

        .cart-item-price-main {
            color: #059669;
            font-weight: 600;
            font-size: 14px;
        }

        .cart-item-remove-main {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .cart-item-remove-main:hover {
            background: #c0392b;
        }

        .cart-total-main {
            border-top: 2px solid #eee;
            padding-top: 20px;
            text-align: center;
        }

        .cart-total-amount-main {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .cart-checkout-main {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .cart-checkout-main:hover {
            background: #229954;
        }

        .cart-empty-main {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 18px;
            line-height: 1.5;
        }

        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .coming-soon-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .coming-soon h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Cart Section Styles */
        .cart-page {
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .cart-content {
            width: 100%;
            margin: 0 auto;
        }

        .cart-items-main {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .cart-item-main {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cart-item-main:last-child {
            border-bottom: none;
        }

        .cart-item-image-main {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
            background: #f8f9fa;
            margin-right: 15px;
            cursor: pointer;
        }

        .cart-item-info-main {
            flex: 1;
            cursor: pointer;
        }

        .cart-item-name-main {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .cart-item-price-main {
            color: #27ae60;
            font-weight: 700;
            font-size: 14px;
        }

        .cart-item-remove-main {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;

.cart-item-remove-main:hover {
    background: #c0392b;
}

.cart-empty-main {
    text-align: center;
    color: #666;
    padding: 60px 20px;
    font-size: 16px;
}

.cart-total-main {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.cart-total-amount-main {
    font-size: 24px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 20px;
}
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .cart-checkout-main {
            width: 100%;
            max-width: 300px;
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .cart-checkout-main:hover {
            background: #229954;
        }

        /* Custom Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .notification {
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 350px;
            word-wrap: break-word;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            float: right;
            margin-left: 10px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Edit Category Modal Styles */
        .edit-category-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }

        .edit-category-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .edit-category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .edit-category-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .edit-category-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .edit-category-close-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .edit-category-modal-body {
            padding: 20px;
        }

        .edit-category-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .edit-category-form input {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .edit-category-form input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .edit-subcategory-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .edit-subcategory-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .edit-subcategory-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .edit-subcategory-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-add-subcategory-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .edit-save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .edit-cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }


        /* Admin Button Styles */
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Profile Section Styles */
        .profile-content {
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .profile-avatar {
            margin-bottom: 20px;
        }

        .profile-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
            font-size: 16px;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .profile-btn:hover {
            background: #c0392b;
        }

        /* Admin Panel Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .admin-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
        }

        .admin-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close-btn {
            background: #f3f4f6;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            transition: all 0.3s ease;
            gap: 8px;
        }

        .close-btn:hover {
            background: #e5e7eb;
            color: #374151;
            transform: translateX(-2px);
        }

        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .slide-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .slide-form input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .slide-form button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .slide-form button:hover {
            background: #2980b9;
        }

        .slide-item, .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .slide-info, .user-info {
            flex: 1;
        }

        .slide-title-admin, .user-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .slide-url, .user-email {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-success:hover {
            background: #229954;
        }

        .admin-badge {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 10px;
        }

        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            padding: 30px 20px 20px;
            text-align: left;
        }

        .slide-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .slide-description {
            font-size: 16px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 30px 20px;
            }

            .nav-container {
                padding: 0 15px;
            }

            .nav-actions {
                gap: 15px;
            }

            .slides img {
                width: 100%;
                height: 100%;
                max-width: 100%;
                object-fit: cover;
            }

            .slideshow-container {
                margin: 10px 5px 0;
            }

            .categories-grid {
                gap: 15px;
                padding: 10px 15px;
            }

            .category-item {
                min-width: 70px;
            }

            .category-image {
                height: 60px;
            }

            .category-name {
                font-size: 13px;
                color: #2c3e50;
                font-weight: 600;
            }

            .category-info {
                padding: 8px;
            }

            /* Admin Panel Mobile Styles */
            .admin-modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 20px;
            }

            .admin-header {
                padding: 15px 20px;
            }

            .admin-header h2 {
                font-size: 20px;
            }

            .admin-tabs {
                flex-wrap: wrap;
            }

            .tab-btn {
                padding: 12px 8px;
                font-size: 14px;
                min-width: 0;
                flex: 1;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .slide-form {
                flex-direction: column;
                gap: 15px;
            }

            .slide-form input {
                min-width: auto;
                width: 100%;
            }

            .slide-form button {
                width: 100%;
                padding: 12px;
            }

            .slide-item, .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .action-buttons {
                width: 100%;
                justify-content: flex-end;
            }

            .slide-info, .user-info {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Custom Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Edit Category Modal -->
    <div class="edit-category-modal" id="editCategoryModal">
        <div class="edit-category-modal-content">
            <div class="edit-category-modal-header">
                <h2 class="edit-category-modal-title">Edit Category</h2>
                <button class="edit-category-modal-close" onclick="closeEditCategoryModal()">&times;</button>
            </div>
            <div class="edit-category-modal-body">
                <form id="editCategoryForm">
                    <input type="text" id="editCategoryName" placeholder="Category Name" required>
                    <input type="url" id="editCategoryImageUrl" placeholder="Category Image URL" required>
                    <input type="url" id="editCategoryBannerUrl" placeholder="Category Banner Image URL" required>
                    
                    <div class="edit-subcategory-section">
                        <div class="edit-subcategory-title">Subcategories</div>
                        <div id="editSubcategoriesContainer">
                            <!-- Subcategories will be populated here -->
                        </div>
                        <button type="button" class="edit-add-subcategory-btn" onclick="addEditSubcategory()">+ Add Subcategory</button>
                    </div>
                    
                    <div class="edit-category-modal-buttons">
                        <button type="button" class="edit-save-btn" onclick="saveEditCategory()">Save Changes</button>
                        <button type="button" class="edit-cancel-btn" onclick="closeEditCategoryModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Subcategory Modal -->
    <div class="add-subcategory-modal" id="addSubcategoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="add-subcategory-modal-content" style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="add-subcategory-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e74c3c; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Add Subcategory</h2>
                <button onclick="closeAddSubcategoryModal()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div class="add-subcategory-modal-body">
                <form id="addSubcategoryForm">
                    <input type="text" id="newSubcategoryName" placeholder="Subcategory Name" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    <input type="url" id="newSubcategoryImage" placeholder="Subcategory Image URL (optional)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    <input type="url" id="newSubcategoryBanner" placeholder="Subcategory Banner URL (optional)" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeAddSubcategoryModal()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">Cancel</button>
                        <button type="button" onclick="saveNewSubcategory()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">Add Subcategory</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Modal (Hidden by default) -->
    <div class="login-modal" id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; justify-content: center; align-items: center;">
        <div class="login-container" style="display: flex; position: relative;">
            <button onclick="closeLoginModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            
            <div class="logo-section">
                <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
                <h1>Welcome</h1>
                <p>Login or register to use app features</p>
            </div>

            <!-- Login Form -->
            <form class="auth-form" id="loginForm" style="display: block !important;">
                <div class="form-group">
                    <input type="text" id="loginEmailOrPhone" placeholder="Email or Phone Number" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
                <div class="form-switch">
                    <p>Don't have an account? <a href="#" onclick="switchToRegister()">Register here</a></p>
                </div>
            </form>

            <!-- Register Form -->
            <form class="auth-form" id="registerForm" style="display: none !important;">
                <div class="form-group">
                    <input type="text" id="registerName" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="tel" id="registerPhone" placeholder="Phone Number" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" required>
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                </div>
                <button type="submit" class="auth-btn">Register</button>
                <div class="form-switch">
                    <p>Already have an account? <a href="#" onclick="switchToLogin()">Login here</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div class="main-app" id="mainApp">
        <nav class="navbar">
            <div class="nav-container">
                <a href="#" class="logo">
                    <img src="logo.png" alt="Logo">
                </a>

                <div class="nav-actions">
                    <button class="icon-btn admin-btn" id="adminBtn" style="display: none;" onclick="openAdminPanel()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </button>

                    <button class="icon-btn profile-btn" id="profileBtn" onclick="showSection('profile')">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <!-- Home Section -->
            <div id="homeSection" class="app-section active">
                <!-- Search Bar and Categories Container -->
                <div class="search-categories-container">
                    <div class="container">
                        <div class="search-bar-container">
                            <div class="search-input-wrapper" onclick="redirectToSearch()" style="cursor: pointer;">
                                <input type="text" id="mainSearchInput" placeholder="Search products..." class="search-input" onclick="redirectToSearch()" onfocus="redirectToSearch()" onkeyup="handleMainSearchKeyup(event)">
                                <button class="search-icon-btn" onclick="redirectToSearch()">🔍</button>
                            </div>
                        </div>
                        
                        <!-- Categories Section -->
                        <div class="categories-row" id="categoriesGrid">
                            <!-- Categories will be dynamically added -->
                        </div>
                    </div>
                </div>

                <!-- Hero Banner -->
                <div class="container" style="margin-top: 30px;">
                    <div class="slideshow-container" id="slideshowContainer">
                        <!-- Slides will be dynamically added by admin -->
                        <button class="slideshow-nav prev" onclick="changeSlide(-1)">‹</button>
                        <button class="slideshow-nav next" onclick="changeSlide(1)">›</button>
                    </div>
                    
                    <!-- Slideshow Dots -->
                    <div class="dots-container" id="dotsContainer" style="margin: 0;">
                        <!-- Dots will be dynamically added based on slides -->
                    </div>
                </div>

                <!-- Events Section (replacing Featured Products) -->
                <div class="events-section" id="eventsSection">
                    <!-- Events will be populated here -->
                </div>
                
                <!-- Zupisupi Footer -->
                <div class="zupisupi-footer">
                    <div class="container">
                        <div class="footer-content">
                            <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                            <span class="footer-text">Zupisupi</span>
                        </div>
                        <div class="footer-reserved">All Rights Reserved</div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div id="searchSection" class="app-section">
                <div class="search-page">
                    <div class="container">
                        <div class="search-header">
                            <h2 class="section-title">Search Products</h2>
                            <div class="search-bar-container">
                                <div class="search-input-wrapper">
                                    <input type="text" id="searchInput" placeholder="Search products..." class="search-input" onkeyup="performSearch()">
                                    <button class="search-icon-btn" onclick="performSearch()">🔍</button>
                                </div>
                            </div>
                        </div>
                        <div class="search-results">
                            <div class="products-grid" id="searchProductsGrid">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zupisupi Footer -->
                    <div class="zupisupi-footer">
                        <div class="container">
                            <div class="footer-content">
                                <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                                <span class="footer-text">Zupisupi</span>
                            </div>
                            <div class="footer-reserved">All Rights Reserved</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="app-section">
                <div class="orders-page">
                    <div class="container">
                        <h2 class="section-title">My Orders</h2>
                        <div class="orders-content" id="ordersContent">
                            <p style="text-align: center; color: #666; padding: 40px;" id="noOrdersMessage">No orders yet. Place your first order!</p>
                        </div>
                    </div>
                    
                    <!-- Zupisupi Footer -->
                    <div class="zupisupi-footer">
                        <div class="container">
                            <div class="footer-content">
                                <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                                <span class="footer-text">Zupisupi</span>
                            </div>
                            <div class="footer-reserved">All Rights Reserved</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div id="cartSection" class="app-section">
                <div class="cart-page">
                    <div class="container">
                        <h2 class="section-title">Shopping Cart</h2>
                        <div class="cart-content">
                            <div class="cart-items-main" id="cartItemsMain">
                                <!-- Cart items will be populated here -->
                            </div>
                            <div class="cart-total-main" id="cartTotalMain" style="display: none;">
                                <div class="cart-total-amount-main" id="cartTotalAmountMain">Total: ₹0</div>
                                <button class="cart-checkout-main" onclick="openConfirmOrderModalForAllCartItems()">Order All</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zupisupi Footer -->
                    <div class="zupisupi-footer">
                        <div class="container">
                            <div class="footer-content">
                                <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                                <span class="footer-text">Zupisupi</span>
                            </div>
                            <div class="footer-reserved">All Rights Reserved</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="app-section">
                <div class="profile-page">
                    <div class="container">
                        <!-- Profile Header -->
                        <div class="profile-header">
                            <div class="profile-info">
                                <h3 class="profile-name" id="profileName">User Name</h3>
                                <p class="profile-email" id="profileEmail">user@example.com</p>
                            </div>
                        </div>
                        
                        <!-- Profile Menu -->
                        <div class="profile-menu">
                            <div class="profile-menu-item" onclick="showAddressForm()">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Address</div>
                                    <div class="menu-subtitle">Manage delivery address</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item" onclick="setActiveTab('orders')">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">My Orders</div>
                                    <div class="menu-subtitle">Track your orders</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item" onclick="openTermsModal()">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Terms & Conditions</div>
                                    <div class="menu-subtitle">App terms and policies</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item" onclick="openPrivacyModal()">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Privacy Policy</div>
                                    <div class="menu-subtitle">Data protection and privacy</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item" onclick="openFAQModal()">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Help & Support</div>
                                    <div class="menu-subtitle">Frequently asked questions</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Contact Us</div>
                                    <div class="menu-subtitle">moghaeashu@gmail.com • +91 7000842463</div>
                                </div>
                                <div class="menu-arrow">›</div>
                            </div>
                            
                            <div class="profile-menu-item logout-item" onclick="logout()">
                                <div class="menu-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="menu-content">
                                    <div class="menu-title">Log out</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Your Delivery Address Display in Profile -->
                    <div id="profileAddressDisplay" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; border: 1px solid #dee2e6; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                                <span style="color: #28a745;">📍</span> Your Delivery Address
                            </h3>
                            <button onclick="openAddressModal()" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ✏️ Edit Address
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #e74c3c;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 3px;">STATE</div>
                                <div id="profileDisplayState" style="font-weight: 600; color: #2c3e50; font-size: 13px;"></div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #f39c12;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 3px;">CITY</div>
                                <div id="profileDisplayCity" style="font-weight: 600; color: #2c3e50; font-size: 13px;"></div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #27ae60;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 3px;">PINCODE</div>
                                <div id="profileDisplayPincode" style="font-weight: 600; color: #2c3e50; font-size: 13px;"></div>
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #9b59b6;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 3px;">FULL ADDRESS</div>
                            <div id="profileDisplayAddress" style="font-weight: 600; color: #2c3e50; font-size: 13px; line-height: 1.3;"></div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #1abc9c;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 3px;">NEARBY LOCATION</div>
                            <div id="profileDisplayNearby" style="font-weight: 600; color: #2c3e50; font-size: 13px;"></div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #28a745; font-weight: 500;">✓ This address will be used for all your orders</div>
                        </div>
                    </div>
                    
                    <!-- Address Form Modal -->
                    <div id="addressModal" class="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; justify-content: center; align-items: center;">
                        <div class="login-container" style="display: flex; position: relative; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px;">
                            <button onclick="closeAddressModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 10;">×</button>
                            
                            <div style="padding: 20px 20px 10px 20px; text-align: center;">
                                <h2 style="margin: 0; color: #2c3e50; font-size: 20px;">Address</h2>
                            </div>
                            
                            <form class="auth-form" id="addressForm" onsubmit="event.preventDefault(); saveUserAddress();" style="display: block !important; padding: 0 20px 20px 20px;">
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <input type="tel" id="userPhone" placeholder="Phone Number (10 digits)" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <div class="form-group">
                                        <select id="userState" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;" required>
                                            <option value="">Select State</option>
                                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                                <option value="Assam">Assam</option>
                                                <option value="Bihar">Bihar</option>
                                                <option value="Chhattisgarh">Chhattisgarh</option>
                                                <option value="Goa">Goa</option>
                                                <option value="Gujarat">Gujarat</option>
                                                <option value="Haryana">Haryana</option>
                                                <option value="Himachal Pradesh">Himachal Pradesh</option>
                                                <option value="Jharkhand">Jharkhand</option>
                                                <option value="Karnataka">Karnataka</option>
                                                <option value="Kerala">Kerala</option>
                                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                                <option value="Maharashtra">Maharashtra</option>
                                                <option value="Manipur">Manipur</option>
                                                <option value="Meghalaya">Meghalaya</option>
                                                <option value="Mizoram">Mizoram</option>
                                                <option value="Nagaland">Nagaland</option>
                                                <option value="Odisha">Odisha</option>
                                                <option value="Punjab">Punjab</option>
                                                <option value="Rajasthan">Rajasthan</option>
                                                <option value="Sikkim">Sikkim</option>
                                                <option value="Tamil Nadu">Tamil Nadu</option>
                                                <option value="Telangana">Telangana</option>
                                                <option value="Tripura">Tripura</option>
                                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                <option value="Uttarakhand">Uttarakhand</option>
                                                <option value="West Bengal">West Bengal</option>
                                                <option value="Delhi">Delhi</option>
                                                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                                <option value="Ladakh">Ladakh</option>
                                                <option value="Puducherry">Puducherry</option>
                                                <option value="Chandigarh">Chandigarh</option>
                                                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                                <option value="Lakshadweep">Lakshadweep</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <select id="userCity" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;" required>
                                                <option value="">Select City</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 8px;">
                                        <textarea id="userAddress" placeholder="Full Address (House no, Street, Area)" rows="2" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; resize: none; min-height: 40px;"></textarea>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                                        <div class="form-group">
                                            <input type="text" id="userPincode" placeholder="Pincode (6 digits)" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                        </div>
                                        <div class="form-group">
                                            <input type="text" id="userNearby" placeholder="Nearby Landmark" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                        </div>
                                    </div>
                                    <button type="submit" class="auth-btn" style="padding: 8px 16px; font-size: 12px; width: 100%;">Save Address</button>
                                </form>
                                <div id="currentAddressDisplay" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e8f5e8, #f0f8ff); border-radius: 10px; border: 1px solid #d4edda; display: none;">
                                    <h4 style="margin: 0 0 12px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                                        <span style="color: #28a745;">📍</span> Your Current Saved Address
                                    </h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #3498db;">
                                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">STATE</div>
                                            <div id="displayState" style="font-weight: 600; color: #2c3e50; font-size: 12px;"></div>
                                        </div>
                                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">CITY</div>
                                            <div id="displayCity" style="font-weight: 600; color: #2c3e50; font-size: 12px;"></div>
                                        </div>
                                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #f39c12;">
                                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PINCODE</div>
                                            <div id="displayPincode" style="font-weight: 600; color: #2c3e50; font-size: 12px;"></div>
                                        </div>
                                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #27ae60;">
                                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PHONE</div>
                                            <div id="displayPhone" style="font-weight: 600; color: #2c3e50; font-size: 12px;"></div>
                                        </div>
                                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #1abc9c;">
                                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">NEARBY</div>
                                            <div id="displayNearby" style="font-weight: 600; color: #2c3e50; font-size: 12px;"></div>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #9b59b6;">
                                        <div style="font-size: 10px; color: #666; margin-bottom: 2px;">FULL ADDRESS</div>
                                        <div id="displayAddress" style="font-weight: 600; color: #2c3e50; font-size: 12px; line-height: 1.3;"></div>
                                    </div>
                                    <div style="margin-top: 10px; padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; color: #28a745; font-weight: 500;">✓ You can edit any field above to update your address</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Terms & Conditions Modal -->
                    <div id="termsModal" class="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; justify-content: center; align-items: center;">
                        <div class="login-container" style="display: flex; position: relative; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px;">
                            <button onclick="closeTermsModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 1;">×</button>
                            
                            <div class="logo-section">
                                <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
                                <h1>Terms & Conditions</h1>
                                <p>Zupisupi App Terms of Service</p>
                            </div>

                            <div class="auth-form" style="display: block !important; padding: 10px; text-align: left; font-size: 12px; height: 100%; overflow-y: auto;">
                                <div style="color: #2c3e50; line-height: 1.3; padding-bottom: 20px;">
                                    <p style="margin-bottom: 8px; font-weight: 600; font-size: 13px;">Welcome to Zupisupi, an online shopping platform designed to provide you with a smooth and secure shopping experience. By using our app, you agree to the following Terms and Conditions:</p>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #3498db;">
                                        <h5 style="color: #3498db; margin: 0 0 3px 0; font-size: 12px;">1. Acceptance of Terms</h5>
                                        <p style="margin: 0; font-size: 11px;">By accessing or using Zupisupi, you agree to comply with these Terms. If you do not agree, please do not use the app.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e74c3c;">
                                        <h5 style="color: #e74c3c; margin: 0 0 3px 0; font-size: 12px;">2. Account Registration</h5>
                                        <p style="margin: 0; font-size: 11px;">• Users must provide accurate and complete details during registration.<br>• You are responsible for maintaining the confidentiality of your login credentials.<br>• You agree not to share your account with others.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin: 0 0 3px 0; font-size: 12px;">3. Eligibility</h5>
                                        <p style="margin: 0; font-size: 11px;">You must be at least 18 years old or have the consent of a legal guardian to use this app.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin: 0 0 3px 0; font-size: 12px;">4. Orders and Payments</h5>
                                        <p style="margin: 0; font-size: 11px;">• All orders placed through Zupisupi are subject to availability and confirmation.<br>• Prices listed on the app include all applicable taxes unless stated otherwise.<br>• We accept payments through UPI, Debit/Credit Card, Net Banking, and COD.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #9b59b6;">
                                        <h5 style="color: #9b59b6; margin: 0 0 3px 0; font-size: 12px;">5. Shipping and Delivery</h5>
                                        <p style="margin: 0; font-size: 11px;">• Delivery timelines may vary based on your location.<br>• Delays caused by logistics or unforeseen circumstances are beyond our control.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #1abc9c;">
                                        <h5 style="color: #1abc9c; margin: 0 0 3px 0; font-size: 12px;">6. Returns and Refunds</h5>
                                        <p style="margin: 0; font-size: 11px;">• Returns are accepted only if the product is damaged, defective, or incorrect.<br>• Refunds will be processed as per our Refund Policy within 5-7 business days.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e67e22;">
                                        <h5 style="color: #e67e22; margin: 0 0 3px 0; font-size: 12px;">7. Prohibited Activities</h5>
                                        <p style="margin: 0; font-size: 11px;">You agree not to:<br>• Use the app for any fraudulent activity.<br>• Post harmful or offensive content.<br>• Interfere with the app's security.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #34495e;">
                                        <h5 style="color: #34495e; margin: 0 0 3px 0; font-size: 12px;">8. Limitation of Liability</h5>
                                        <p style="margin: 0; font-size: 11px;">Zupisupi is not liable for any indirect, incidental, or consequential damages arising from the use of our app.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #16a085;">
                                        <h5 style="color: #16a085; margin: 0 0 3px 0; font-size: 12px;">9. Privacy Policy</h5>
                                        <p style="margin: 0; font-size: 11px;">Your personal information will be handled according to our Privacy Policy. We value your privacy and ensure your data is secure.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #8e44ad;">
                                        <h5 style="color: #8e44ad; margin: 0 0 3px 0; font-size: 12px;">10. Changes to Terms</h5>
                                        <p style="margin: 0; font-size: 11px;">We reserve the right to modify these Terms anytime. Users will be notified of major changes.</p>
                                    </div>
                                    
                                    <p style="margin-top: 10px; font-size: 10px; color: #7f8c8d; text-align: center;">Last updated: January 2024<br>For questions, contact us through the app.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy Policy Modal -->
                    <div id="privacyModal" class="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; justify-content: center; align-items: center;">
                        <div class="login-container" style="display: flex; position: relative; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px;">
                            <button onclick="closePrivacyModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 1;">×</button>
                            
                            <div class="logo-section">
                                <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
                                <h1>Privacy Policy</h1>
                                <p>Data protection and privacy</p>
                            </div>

                            <div class="auth-form" style="display: block !important; padding: 10px; text-align: left; font-size: 12px; height: 100%; overflow-y: auto;">
                                <div style="color: #2c3e50; line-height: 1.3; padding-bottom: 20px;">
                                    <p style="margin-bottom: 8px; font-weight: 600; font-size: 13px;">✅ Privacy Policy for Zupisupi</p>
                                    <p style="margin-bottom: 8px; font-size: 11px;">Last Updated: [Insert Date]</p>
                                    <p style="margin-bottom: 8px; font-size: 11px;">Zupisupi respects your privacy and is committed to protecting your personal information. This Privacy Policy explains how we collect, use, and protect your data when you use our app.</p>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin: 0 0 3px 0; font-size: 12px;">1. Information We Collect</h5>
                                        <p style="margin: 0; font-size: 11px;">We may collect:<br>
                                        • Personal Information: Name, email address, phone number, and shipping address (when you place an order).<br>
                                        • Usage Data: App activity, browsing behavior, and device information to improve the user experience.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #3498db;">
                                        <h5 style="color: #3498db; margin: 0 0 3px 0; font-size: 12px;">2. How We Use Your Information</h5>
                                        <p style="margin: 0; font-size: 11px;">We use your information to:<br>
                                        • Process and deliver your orders.<br>
                                        • Provide customer support.<br>
                                        • Improve our services and app experience.<br>
                                        • Send updates, offers, and promotions (only if you allow).</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e74c3c;">
                                        <h5 style="color: #e74c3c; margin: 0 0 3px 0; font-size: 12px;">3. Sharing of Information</h5>
                                        <p style="margin: 0; font-size: 11px;">• We do not sell, rent, or trade your personal information.<br>
                                        • We may share limited data with delivery partners to fulfill your order.<br>
                                        • We may disclose information if required by law.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin: 0 0 3px 0; font-size: 12px;">4. Data Security</h5>
                                        <p style="margin: 0; font-size: 11px;">We take reasonable measures to protect your data against unauthorized access, loss, or misuse. However, no method is 100% secure.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #9b59b6;">
                                        <h5 style="color: #9b59b6; margin: 0 0 3px 0; font-size: 12px;">5. Cookies & Tracking</h5>
                                        <p style="margin: 0; font-size: 11px;">We may use cookies or similar technologies to improve app functionality. You can disable them in your device settings.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #1abc9c;">
                                        <h5 style="color: #1abc9c; margin: 0 0 3px 0; font-size: 12px;">6. Your Rights</h5>
                                        <p style="margin: 0; font-size: 11px;">You can:<br>
                                        • Access or update your account details anytime.<br>
                                        • Request account deletion by contacting us.<br>
                                        • Opt out of promotional messages.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #34495e;">
                                        <h5 style="color: #34495e; margin: 0 0 3px 0; font-size: 12px;">7. Third-Party Links</h5>
                                        <p style="margin: 0; font-size: 11px;">Our app may contain links to third-party websites. We are not responsible for their privacy practices.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e67e22;">
                                        <h5 style="color: #e67e22; margin: 0 0 3px 0; font-size: 12px;">8. Policy Updates</h5>
                                        <p style="margin: 0; font-size: 11px;">We may update this Privacy Policy from time to time. Changes will be posted in the app.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FAQ Modal -->
                    <div id="faqModal" class="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; justify-content: center; align-items: center;">
                        <div class="login-container" style="display: flex; position: relative; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px;">
                            <button onclick="closeFAQModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; z-index: 1;">×</button>
                            
                            <div class="logo-section">
                                <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
                                <h1>FAQ</h1>
                                <p>Frequently Asked Questions</p>
                            </div>

                            <div class="auth-form" style="display: block !important; padding: 10px; text-align: left; font-size: 12px; height: 100%; overflow-y: auto;">
                                <div style="color: #2c3e50; line-height: 1.3; padding-bottom: 20px;">
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #3498db;">
                                        <h5 style="color: #3498db; margin: 0 0 3px 0; font-size: 12px;">1. What is Zupisupi?</h5>
                                        <p style="margin: 0; font-size: 11px;">Zupisupi is an online shopping app that offers a wide range of products at affordable prices with easy payment options.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e74c3c;">
                                        <h5 style="color: #e74c3c; margin: 0 0 3px 0; font-size: 12px;">2. How can I place an order?</h5>
                                        <p style="margin: 0; font-size: 11px;">• Browse the products.<br>• Add your favorite items to the cart.<br>• Proceed to checkout and make payment.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #f39c12;">
                                        <h5 style="color: #f39c12; margin: 0 0 3px 0; font-size: 12px;">3. What payment methods do you accept?</h5>
                                        <p style="margin: 0; font-size: 11px;">We currently accept UPI, Debit/Credit Cards, Net Banking, and Cash on Delivery (COD).</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #27ae60;">
                                        <h5 style="color: #27ae60; margin: 0 0 3px 0; font-size: 12px;">4. How long does delivery take?</h5>
                                        <p style="margin: 0; font-size: 11px;">Delivery usually takes 3-7 business days, depending on your location.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #9b59b6;">
                                        <h5 style="color: #9b59b6; margin: 0 0 3px 0; font-size: 12px;">5. Can I return a product?</h5>
                                        <p style="margin: 0; font-size: 11px;">Yes, if:<br>• The product is damaged or defective.<br>• You received the wrong item.<br>Return requests must be raised within 7 days of delivery.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #1abc9c;">
                                        <h5 style="color: #1abc9c; margin: 0 0 3px 0; font-size: 12px;">6. How can I track my order?</h5>
                                        <p style="margin: 0; font-size: 11px;">Go to My Orders section in the app to track your shipment.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #e67e22;">
                                        <h5 style="color: #e67e22; margin: 0 0 3px 0; font-size: 12px;">7. Is my payment secure?</h5>
                                        <p style="margin: 0; font-size: 11px;">Yes! We use secure payment gateways and end-to-end encryption to protect your transactions.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #34495e;">
                                        <h5 style="color: #34495e; margin: 0 0 3px 0; font-size: 12px;">8. Do you offer refunds?</h5>
                                        <p style="margin: 0; font-size: 11px;">Refunds are processed to your original payment method within 5-7 business days after the return is approved.</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #16a085;">
                                        <h5 style="color: #16a085; margin: 0 0 3px 0; font-size: 12px;">9. How can I contact customer support?</h5>
                                        <p style="margin: 0; font-size: 11px;">You can contact us via:<br>• Email: [your email]<br>• Phone/WhatsApp: [your number]<br>• In-app Chat Support</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #8e44ad;">
                                        <h5 style="color: #8e44ad; margin: 0 0 3px 0; font-size: 12px;">10. Do I need an account to shop?</h5>
                                        <p style="margin: 0; font-size: 11px;">Yes, you need to create an account to place orders, track them, and avail offers.</p>
                                    </div>
                                    
                                    <p style="margin-top: 10px; font-size: 10px; color: #7f8c8d; text-align: center;">Still have questions? Contact our customer support team!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zupisupi Footer -->
                    <div class="zupisupi-footer">
                        <div class="container">
                            <div class="footer-content">
                                <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                                <span class="footer-text">Zupisupi</span>
                            </div>
                            <div class="footer-reserved">All Rights Reserved</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminPanel" class="admin-modal" style="display: none;">
        <div class="admin-modal-content">
            <div class="admin-header">
                <h2>Admin Panel</h2>
                <button class="close-btn" onclick="closeAdminPanel()">← Back</button>
            </div>
            
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="showTab('slides')">Slides</button>
                <button class="tab-btn" onclick="showTab('categories')">Categories</button>
                <button class="tab-btn" onclick="showTab('products')">Products</button>
                <button class="tab-btn" onclick="showTab('events')">Events</button>
                <button class="tab-btn" onclick="showTab('users')">Users</button>
                <button class="tab-btn" onclick="showTab('ordersAdmin')">Orders</button>
            </div>

            <!-- Slides Section -->
            <div id="slidesTab" class="tab-content active">
                <h3>Slideshow Management</h3>
{{ ... }}
                <div class="slide-form">
                    <input type="text" id="slideTitle" placeholder="Image Title" />
                    <input type="url" id="slideUrl" placeholder="Image Link" />
                    <button onclick="addSlide()">Add Slide</button>
                </div>
                <div class="slides-list" id="slidesList">
                    <!-- Current slides will be populated here -->
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categoriesTab" class="tab-content">
                <h3>Category Management</h3>
                <div class="slide-form">
                    <input type="text" id="categoryName" placeholder="Category Name" />
                    <input type="url" id="categoryImageUrl" placeholder="Category Image URL" />
                    <input type="url" id="categoryBannerUrl" placeholder="Category Banner Image URL" style="margin-top: 10px;" />
                    
                    <!-- Subcategories Section -->
                    <div style="margin: 15px 0; padding: 15px; border: 2px solid #e74c3c; border-radius: 8px; background: #fdf2f2;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #c0392b; font-size: 16px;">🏷️ Subcategories</label>
                        <div id="subcategoriesContainer" style="margin-bottom: 10px;">
                            <div class="subcategory-input-group" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" class="subcategory-name" placeholder="Subcategory Name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <button type="button" onclick="removeSubcategoryInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">Remove</button>
                                </div>
                                <input type="url" class="subcategory-image" placeholder="Subcategory Image URL" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <input type="url" class="subcategory-banner" placeholder="Subcategory Banner Image URL" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        <button type="button" onclick="addSubcategoryInput()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 5px;">+ Add Subcategory</button>
                    </div>
                    
                    <button onclick="addCategory()">Add Category</button>
                </div>
                
                <!-- Search Bar for Categories -->
                <div class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="adminCategorySearchInput" placeholder="Search categories..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" oninput="filterCategoriesAdmin()">
                </div>
                
                <div class="categories-list" id="categoriesAdminList">
                    <!-- Current categories will be populated here -->
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsTab" class="tab-content">
                <h3>Product Management</h3>
                <form class="admin-form" onsubmit="event.preventDefault(); addProduct();">
                    <input type="text" id="productName" placeholder="Product Name" required>
                    
                    <!-- Main Product Image -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Main Product Image:</label>
                        <input type="url" id="productImageUrl" placeholder="Main Product Image URL" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <!-- Additional Product Images -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Additional Product Images:</label>
                        <div id="additionalImagesContainer">
                            <div class="image-input-group" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="url" class="additional-image-url" placeholder="Additional Image URL" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <button type="button" onclick="removeImageInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">Remove</button>
                            </div>
                        </div>
                        <button type="button" onclick="addImageInput()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 5px;">+ Add More Images</button>
                    </div>
                    
                    <textarea id="productDescription" placeholder="Product Description" required></textarea>
                    
                    <!-- Pricing Section -->
                    <div style="margin-bottom: 15px; padding: 15px; border: 2px solid #f39c12; border-radius: 8px; background: #fef9e7;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #e67e22; font-size: 16px;">💰 Pricing & Discount</label>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 14px;">Original Price (₹):</label>
                                <input type="number" id="productOriginalPrice" placeholder="Original/Cut Price" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 14px;">Discount (%):</label>
                                <input type="number" id="productDiscount" placeholder="Discount %" min="0" max="99" step="1" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #27ae60; font-size: 14px;">Final Price (₹):</label>
                            <input type="number" id="productFinalPrice" placeholder="Auto-calculated" step="0.01" readonly style="width: 100%; padding: 10px; border: 1px solid #27ae60; border-radius: 5px; background: #e8f5e8; color: #27ae60; font-weight: 600;">
                        </div>
                    </div>
                    
                    <input type="number" id="deliveryCharge" placeholder="Delivery Charge (₹)" step="0.01" value="0">
                    
                    <!-- Star Rating Field -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Product Rating:</label>
                        <select id="productRating" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            <option value="">Select Rating</option>
                            <option value="1">⭐ 1 Star</option>
                            <option value="2">⭐⭐ 2 Stars</option>
                            <option value="3">⭐⭐⭐ 3 Stars</option>
                            <option value="4">⭐⭐⭐⭐ 4 Stars</option>
                            <option value="5">⭐⭐⭐⭐⭐ 5 Stars</option>
                        </select>
                    </div>
                    <input type="text" id="productSubImages" placeholder="Sub Images URLs (comma separated)" style="display: none;">
                    <!-- Main Categories Selection Section -->
                    <div id="productCategoriesSection" style="margin: 15px 0; padding: 15px; border: 2px solid #e67e22; border-radius: 8px; background: #fef5e7;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #d35400; font-size: 16px;">🏪 Select Main Categories (Multiple Selection Allowed)</label>
                        <div id="productCategoriesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Category checkboxes will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Subcategories Selection Section -->
                    <div id="productSubcategoriesSection" style="margin: 15px 0; padding: 15px; border: 2px solid #9b59b6; border-radius: 8px; background: #f8f4ff; display: none;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #8e44ad; font-size: 16px;">🏷️ Select Subcategories (Multiple Selection Allowed)</label>
                        <div id="productSubcategoriesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Subcategory checkboxes will be loaded here -->
                        </div>
                    </div>
                    <!-- Size & Weight Based Pricing Section -->
                    <div style="margin: 15px 0; padding: 15px; border: 2px solid #3498db; border-radius: 8px; background: #f8f9fa;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #2980b9; font-size: 16px;">📏 Available Sizes & Weight-Based Pricing</label>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Regular Sizes -->
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                <label style="display: flex; align-items: center; gap: 5px; min-width: 70px; font-weight: 600;"><input type="checkbox" value="S" class="size-checkbox"> S</label>
                                <input type="number" id="priceS" placeholder="Price for S" step="0.01" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                <label style="display: flex; align-items: center; gap: 5px; min-width: 70px; font-weight: 600;"><input type="checkbox" value="M" class="size-checkbox"> M</label>
                                <input type="number" id="priceM" placeholder="Price for M" step="0.01" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                <label style="display: flex; align-items: center; gap: 5px; min-width: 70px; font-weight: 600;"><input type="checkbox" value="L" class="size-checkbox"> L</label>
                                <input type="number" id="priceL" placeholder="Price for L" step="0.01" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                <label style="display: flex; align-items: center; gap: 5px; min-width: 70px; font-weight: 600;"><input type="checkbox" value="XL" class="size-checkbox"> XL</label>
                                <input type="number" id="priceXL" placeholder="Price for XL" step="0.01" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                <label style="display: flex; align-items: center; gap: 5px; min-width: 70px; font-weight: 600;"><input type="checkbox" value="XXL" class="size-checkbox"> XXL</label>
                                <input type="number" id="priceXXL" placeholder="Price for XXL" step="0.01" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            
                            <!-- Weight-Based Options -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e74c3c;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #c0392b; font-size: 14px;">⚖️ Weight-Based Pricing Options</label>
                                
                                <!-- ML Options -->
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #c0392b;">Milliliters (ml):</label>
                                    <div id="mlContainer">
                                        <div class="weight-input-group" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                            <input type="number" class="weight-quantity" placeholder="Quantity (ml)" min="1" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <input type="number" class="weight-price" placeholder="Price (₹)" step="0.01" min="0" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <button type="button" onclick="removeWeightInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                                        </div>
                                    </div>
                                    <button type="button" onclick="addWeightInput('mlContainer', 'ml')" style="background: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Add ML Option</button>
                                </div>
                                
                                <!-- Grams Options -->
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #c0392b;">Grams (g):</label>
                                    <div id="gContainer">
                                        <div class="weight-input-group" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                            <input type="number" class="weight-quantity" placeholder="Quantity (g)" min="1" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <input type="number" class="weight-price" placeholder="Price (₹)" step="0.01" min="0" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <button type="button" onclick="removeWeightInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                                        </div>
                                    </div>
                                    <button type="button" onclick="addWeightInput('gContainer', 'g')" style="background: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Add Gram Option</button>
                                </div>
                                
                                <!-- Kilograms Options -->
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #c0392b;">Kilograms (kg):</label>
                                    <div id="kgContainer">
                                        <div class="weight-input-group" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                            <input type="number" class="weight-quantity" placeholder="Quantity (kg)" min="1" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <input type="number" class="weight-price" placeholder="Price (₹)" step="0.01" min="0" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                                            <button type="button" onclick="removeWeightInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                                        </div>
                                    </div>
                                    <button type="button" onclick="addWeightInput('kgContainer', 'kg')" style="background: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Add KG Option</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Add Product</button>
                </form>
                
                <!-- Search Bar for Products -->
                <div class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="productSearchInput" placeholder="Search products..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" oninput="loadProductsAdminData()">
                </div>
                
                <div id="productsAdminList" style="max-height: 600px; overflow-y: auto;">
                    <!-- Products will be populated here -->
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersTab" class="tab-content">
                <h3>User Management</h3>
                <div class="users-list" id="usersList">
                    <!-- Registered users will be populated here -->
                </div>
            </div>

            <!-- Admin Events Section -->
            <div id="eventsTab" class="tab-content">
                <h3>Event Management</h3>
                
                <!-- Event Form -->
                <div class="event-form">
                    <input type="text" id="eventName" placeholder="Event Name" />
                    <input type="url" id="eventNameImage" placeholder="Event Name Image URL (will show instead of text)" />
                    <input type="url" id="eventBackgroundImage" placeholder="Background Image URL" />
                    
                    <!-- Title Color Selection -->
                    <div style="margin: 15px 0;">
                        <h4>Select Title Color:</h4>
                        <select id="eventTitleColor" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                            <option value="white">⚪ White - Best for dark backgrounds</option>
                            <option value="black">⚫ Black - Best for light backgrounds</option>
                        </select>
                    </div>
                    
                    <!-- Template Selection -->
                    <div style="margin: 15px 0;">
                        <h4>Select Card Template:</h4>
                        <select id="eventTemplate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                            <option value="template-1">🎯 Modern Scroll - Horizontal cards with smooth scrolling</option>
                            <option value="template-2">📱 Smart Grid - Responsive grid layout</option>
                            <option value="template-4">💎 Compact Pro - Space-efficient premium cards</option>
                        </select>
                        
                        <!-- Template Preview -->
                        <div style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Template Preview:</h5>
                            <div id="templatePreview" style="font-size: 14px; color: #6c757d;">
                                <strong>Template 1:</strong> Horizontal scrolling cards (180px width)
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <h4>Select Products:</h4>
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="eventProductSearch" placeholder="Search products..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div id="eventProductSelection" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                    <button onclick="addEvent()">Add Event</button>
                </div>
                
                <!-- Events List -->
                <div class="events-list" id="eventsList">
                    <!-- Current events will be populated here -->
                </div>
            </div>

            <!-- Admin Orders Section -->
            <div id="ordersAdminTab" class="tab-content">
                <h3>Order Management</h3>
                
                <!-- Filter and Search Controls -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="orderStatusFilter" onchange="filterOrders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                        <option value="all">All Orders</option>
                        <option value="Pending">Pending Orders</option>
                        <option value="Shipped">Shipped Orders</option>
                    </select>
                    
                    <input type="text" id="orderSearchInput" placeholder="Search by email or phone..." onkeyup="searchOrders()" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                    
                    <button onclick="clearFilters()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; font-size: 13px; cursor: pointer;">Clear</button>
                </div>
                
                <div class="admin-list" id="adminOrdersList">
                    <!-- Orders will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h2>Product Details</h2>
                <button class="close-btn" onclick="closeProductModal()">← Back</button>
            </div>
            <div class="product-modal-body" id="productModalBody">
                <!-- Product details will be populated here -->
            </div>
            
            <!-- Zupisupi Footer -->
            <div class="zupisupi-footer">
                <div class="container">
                    <div class="footer-content">
                        <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                        <span class="footer-text">Zupisupi</span>
                    </div>
                    <div class="footer-reserved">All Rights Reserved</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Order Modal -->
    <div id="confirmOrderModal" class="product-modal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h2>Confirm Order</h2>
                <button class="close-btn" onclick="closeConfirmOrderModal()">← Back</button>
            </div>
            <div class="product-modal-body" id="confirmOrderModalBody">
                <!-- Order confirmation details will be populated here -->
            </div>
            
            <!-- Zupisupi Footer -->
            <div class="zupisupi-footer">
                <div class="container">
                    <div class="footer-content">
                        <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                        <span class="footer-text">Zupisupi</span>
                    </div>
                    <div class="footer-reserved">All Rights Reserved</div>
                </div>
            </div>
        </div>
    </div>


    <!-- Update Categories Modal -->
    <div id="updateCategoriesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1a202c; font-size: 20px;">Update Product Categories</h3>
                <button onclick="closeUpdateCategoriesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
            </div>
            
            <div id="updateProductInfo" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Product info will be displayed here -->
            </div>
            
            <!-- Main Categories Selection -->
            <div style="margin: 20px 0; padding: 15px; border: 2px solid #e67e22; border-radius: 8px; background: #fef5e7;">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #d35400; font-size: 16px;">🏪 Select Main Categories (Multiple Selection Allowed)</label>
                <div id="updateCategoriesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <!-- Category checkboxes will be loaded here -->
                </div>
            </div>
            
            <!-- Subcategories Selection -->
            <div id="updateSubcategoriesSection" style="margin: 20px 0; padding: 15px; border: 2px solid #9b59b6; border-radius: 8px; background: #f8f4ff;">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; color: #8e44ad; font-size: 16px;">🏷️ Select Subcategories (Multiple Selection Allowed)</label>
                <div id="updateSubcategoriesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <!-- Subcategory checkboxes will be loaded here -->
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="closeUpdateCategoriesModal()" style="background: #6b7280; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button onclick="updateProductCategories()" style="background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Update Categories</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="category-modal">
        <div class="category-modal-content">
            <div class="category-modal-header">
                <h2 id="categoryModalTitle" class="category-modal-title">Category Products</h2>
                <button class="category-back-btn" onclick="window.closeCategoryModal()">← Back</button>
            </div>
            <div class="category-search-section">
                <div class="category-search-container">
                    <div class="category-search-input-wrapper">
                        <input type="text" id="categorySearchInput" placeholder="Search products in this category..." oninput="window.searchCategoryProducts()">
                        <button class="category-search-icon-btn" onclick="window.searchCategoryProducts()">🔍</button>
                    </div>
                    <!-- Category Banner Section -->
                    <div class="category-banner-section" id="categoryBannerSection">
                        <img id="categoryBannerImage" src="" alt="Category Banner" class="category-banner-image">
                    </div>
                </div>
            </div>
            <!-- Category Modal Body with Sidebar and Products -->
            <div class="category-modal-body">
                <!-- Subcategories Sidebar -->
                <div class="category-sidebar">
                    <h3 class="subcategories-sidebar-title">Filter</h3>
                    <div class="subcategories-list" id="categoryModalSubcategories">
                        <!-- Subcategories will be loaded here -->
                    </div>
                </div>
                <!-- Products Area -->
                <div class="category-products-area">
                    <div class="category-products-grid" id="categoryProductsGrid">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Zupisupi Footer -->
        <div class="zupisupi-footer">
            <div class="container">
                <div class="footer-content">
                    <img src="logo.png" alt="Zupisupi Logo" class="footer-logo" onerror="this.style.display='none'">
                    <span class="footer-text">Zupisupi</span>
                </div>
                <div class="footer-reserved">All Rights Reserved</div>
            </div>
        </div>

        <!-- App Bottom Navigation -->
        <div class="app-bottom-nav">
            <div class="app-nav-item active" onclick="setActiveTab('home')">
                <div class="app-nav-icon">🏠</div>
                <div class="app-nav-label">Home</div>
            </div>
            <div class="app-nav-item" onclick="setActiveTab('search')">
                <div class="app-nav-icon">🔍</div>
                <div class="app-nav-label">Search</div>
            </div>
            <div class="cart-nav-item app-nav-item" onclick="checkAuthAndSetTab('cart')">
                <div class="app-nav-icon">
                    🛒
                    <span class="cart-count" id="cartCountBottom" style="display: none;">0</span>
                </div>
                <div class="app-nav-label">Cart</div>
            </div>
            <div class="app-nav-item" onclick="checkAuthAndSetTab('orders')">
                <div class="app-nav-icon">📦</div>
                <div class="app-nav-label">Orders</div>
            </div>
            <div class="app-nav-item" onclick="checkAuthAndSetTab('profile')">
                <div class="app-nav-icon">👤</div>
                <div class="app-nav-label">Profile</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, setDoc, getDoc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_H9jJwyhfUrFoYCWZERf8R8W1o2TmqO0",
            authDomain: "desi-cart-wuaze.firebaseapp.com",
            projectId: "desi-cart-wuaze",
            storageBucket: "desi-cart-wuaze.firebasestorage.app",
            messagingSenderId: "891883106075",
            appId: "1:891883106075:web:c66fa32fe6fa8e8c36edbe"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Login modal functions
        window.showLoginModal = function() {
            if (currentUser) {
                logout();
                return;
            }
            document.getElementById('loginModal').style.display = 'flex';
        };

        window.closeLoginModal = function() {
            document.getElementById('loginModal').style.display = 'none';
        };

        // Form switching functions
        window.switchToRegister = function() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            loginForm.style.setProperty('display', 'none', 'important');
            registerForm.style.setProperty('display', 'block', 'important');
            
            // Clear login form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        };

        window.switchToLogin = function() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            registerForm.style.setProperty('display', 'none', 'important');
            loginForm.style.setProperty('display', 'block', 'important');
            
            // Clear register form
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        };

        // Helper function to check if input is email or phone
        function isEmail(input) {
            return input.includes('@') && input.includes('.');
        }

        // Find user by phone number in Firestore
        async function findUserByPhone(phone) {
            try {
                const usersQuery = query(
                    collection(db, 'users'),
                    where('phone', '==', phone)
                );
                const querySnapshot = await getDocs(usersQuery);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    return userDoc.data();
                }
                return null;
            } catch (error) {
                console.error('Error finding user by phone:', error);
                return null;
            }
        }

        // Updated login function to handle both email and phone
        window.loginWithEmailOrPhone = async function(emailOrPhone, password) {
            const loginBtn = document.querySelector('#loginForm .auth-btn');
            const originalText = loginBtn.textContent;
            
            try {
                // Show loading state
                loginBtn.textContent = 'Logging in...';
                loginBtn.disabled = true;
                
                let userCredential;
                
                if (isEmail(emailOrPhone)) {
                    // Login with email
                    userCredential = await signInWithEmailAndPassword(auth, emailOrPhone, password);
                } else {
                    // Login with phone - first find the email associated with this phone
                    const userData = await findUserByPhone(emailOrPhone);
                    if (!userData || !userData.email) {
                        throw new Error('No account found with this phone number.');
                    }
                    userCredential = await signInWithEmailAndPassword(auth, userData.email, password);
                }
                
                const user = userCredential.user;
                console.log('User logged in successfully:', user.email);
                
                showNotification(`Welcome back! Loading your data...`, 'success', 1000);
                closeLoginModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please check your credentials.';
                
                if (error.message === 'No account found with this phone number.') {
                    errorMessage = error.message;
                } else {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = isEmail(emailOrPhone) ? 'No account found with this email.' : 'No account found with this phone number.';
                            break;
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = 'Incorrect credentials. Please check your details.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many failed attempts. Try again later.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Network error. Please check your connection.';
                            break;
                    }
                }
                
                showNotification(errorMessage, 'error');
                
                // Reset button
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        };

        window.registerWithEmailAndPhone = async function(name, email, phone, password) {
            const registerBtn = document.querySelector('#registerForm .auth-btn');
            const originalText = registerBtn.textContent;
            
            try {
                // Show loading state
                registerBtn.textContent = 'Creating Account...';
                registerBtn.disabled = true;
                
                // Check if phone number already exists
                const existingUser = await findUserByPhone(phone);
                if (existingUser) {
                    throw new Error('An account with this phone number already exists.');
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Update user profile with display name
                await updateProfile(user, {
                    displayName: name
                });
                
                // Save user data to Firestore with phone number
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    phone: phone,
                    createdAt: new Date(),
                    displayName: name
                });
                
                console.log('User registered successfully:', user.email);
                showNotification(`Welcome ${name}! Account created successfully.`, 'success', 1000);
                closeLoginModal();
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                if (error.message === 'An account with this phone number already exists.') {
                    errorMessage = error.message;
                } else {
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'An account with this email already exists.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password should be at least 6 characters.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Network error. Please check your connection.';
                            break;
                    }
                }
                
                showNotification(errorMessage, 'error');
                
                // Reset button
                registerBtn.textContent = originalText;
                registerBtn.disabled = false;
            }
        };

        // Function to completely clear all user data
        function clearAllUserData() {
            // Clear all global variables
            cartItems = [];
            userAddressData = null;
            currentUser = null;
            welcomeMessageShown = false;
            productsData = [];
            categoriesData = [];
            slidesData = [];
            
            // Clear localStorage completely
            localStorage.clear();
            
            // Clear sessionStorage
            sessionStorage.clear();
            
            // Reset UI elements
            const cartCount = document.getElementById('cartCountBottom');
            if (cartCount) {
                cartCount.textContent = '0';
                cartCount.style.display = 'none';
            }
            
            // Clear any cached DOM elements
            const cartItems = document.getElementById('cartItems');
            if (cartItems) cartItems.innerHTML = '';
            
            const cartItemsMain = document.getElementById('cartItemsMain');
            if (cartItemsMain) cartItemsMain.innerHTML = '';
            
            const ordersContent = document.getElementById('ordersContent');
            if (ordersContent) ordersContent.innerHTML = '';
            
            console.log('All user data cleared completely');
        }

        window.logout = async function() {
            try {
                console.log('Starting logout process...');
                
                // Redirect to home page immediately on click
                setActiveTab('home');
                
                // Firebase logout
                await signOut(auth);
                console.log('User signed out successfully');
                
                // Clear all user data
                clearAllUserData();
                
                // Show logout notification
                showNotification('Logged out successfully! 👋', 'success', 1000);
                
                // Reload after 1 second - same as login
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error during sign-out:', error);
                
                // Redirect to home even on error
                setActiveTab('home');
                clearAllUserData();
                showNotification('Logged out! 👋', 'success', 1000);
                
                // Same reload pattern as login
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        };

        // Track if welcome message has been shown
        let welcomeMessageShown = false;

        // Show main app after login
        function showMainApp(user) {
            console.log('showMainApp called with user:', user);
            currentUser = user;
            document.body.style.background = 'white';
            
            // Fix: Use correct element IDs
            const loginContainer = document.getElementById('loginContainer');
            const mainApp = document.querySelector('.main-app');
            
            console.log('loginContainer:', loginContainer);
            console.log('mainApp:', mainApp);
            
            if (loginContainer) {
                loginContainer.style.display = 'none';
            }
            if (mainApp) {
                mainApp.style.display = 'block';
            }
            
            // Show welcome notification only once per session
            if (!welcomeMessageShown) {
                showNotification(`Welcome, ${user.displayName || 'User'}! 🎉<br>You have successfully logged in.`, 'success', 5000);
                welcomeMessageShown = true;
            }
            
            // Update auth button to show "Logout" when user is logged in
            const authBtn = document.getElementById('authBtn');
            if (authBtn) {
                authBtn.textContent = 'Logout';
                authBtn.onclick = logout;
            }
            
            // Bottom navbar is always visible - no need to show/hide
            
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg && user.displayName) {
                welcomeMsg.textContent = `Welcome, ${user.displayName}!`;
            }
            
            // Add user to registered users and update admin visibility
            addRegisteredUser(user);
            updateAdminVisibility(user);
            
            // Initialize slideshow
            initializeSlideshow();
            
            // Load data from Firebase
            loadSlidesFromFirebase();
            loadCategoriesFromFirebase();
            loadProductsFromFirebase();
            
            // Check and schedule existing completed/rejected orders for deletion
            checkAndScheduleExistingOrders();
            
            setTimeout(async () => {
                await loadCartFromFirebase();
                await loadUserAddressFromFirebase();
                
                // Setup real-time cart listener for authenticated users
                setupCartRealTimeListener();
                
                // Update cart display after loading cart data
                updateCartCount();
                updateCartDisplayMain();
            }, 1000);
        }

        // Show login screen
        function showLoginScreen() {
            document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            // Reset welcome message flag when user logs out
            welcomeMessageShown = false;
            
            // Fix: Use correct element IDs
            const loginContainer = document.getElementById('loginContainer');
            const mainApp = document.querySelector('.main-app');
            
            if (loginContainer) {
                loginContainer.style.display = 'flex';
            }
            if (mainApp) {
                mainApp.style.display = 'none';
            }
            
            // Bottom navbar is always visible - no need to hide
        }

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
            if (user) {
                // User is signed in
                console.log('User details:', user.displayName, user.email);
                showMainApp(user);
            } else {
                // User is signed out - but don't show login screen, show main app for guest browsing
                console.log('Guest mode - showing main app without login');
                currentUser = null;
                document.body.style.background = 'white';
                
                const loginContainer = document.getElementById('loginContainer');
                const mainApp = document.querySelector('.main-app');
                
                if (loginContainer) {
                    loginContainer.style.display = 'none';
                }
                if (mainApp) {
                    mainApp.style.display = 'block';
                }
                
                // Update auth button to show "Login"
                const authBtn = document.getElementById('authBtn');
                if (authBtn) {
                    authBtn.textContent = 'Login';
                    authBtn.onclick = showLoginModal;
                }
                
                // Load public data for guest browsing
                setTimeout(async () => {
                    await loadSlidesFromFirebase();
                    await loadCategoriesFromFirebase();
                    await loadProductsFromFirebase();
                }, 500);
            }
        });

        // Slideshow functionality
        let slideIndex = 0;
        let slideInterval;

        function showSlide(index) {
            const slidesWrapper = document.querySelector('.slides-wrapper');
            const dots = document.querySelectorAll('.dot');
            
            if (slidesWrapper && slidesData.length > 0) {
                // Move the wrapper to show the current slide
                const translateX = -index * 100;
                slidesWrapper.style.transform = `translateX(${translateX}%)`;
                
                // Update dots
                dots.forEach(dot => dot.classList.remove('active'));
                if (dots[index]) {
                    dots[index].classList.add('active');
                }
            }
        }

        function nextSlide() {
            if (slidesData.length > 0) {
                slideIndex = (slideIndex + 1) % slidesData.length;
                showSlide(slideIndex);
            }
        }

        function startSlideshow() {
            slideInterval = setInterval(nextSlide, 5000); // Change every 5 seconds
        }

        function stopSlideshow() {
            if (slideInterval) {
                clearInterval(slideInterval);
            }
        }

        // Manual slide navigation
        window.currentSlide = function(index) {
            slideIndex = index - 1; // Convert to 0-based index
            showSlide(slideIndex);
            stopSlideshow();
            startSlideshow(); // Restart auto-scroll
        };

        // Navigation arrow functions
        window.changeSlide = function(direction) {
            if (slidesData.length === 0) return;
            
            slideIndex += direction;
            
            if (slideIndex >= slidesData.length) {
                slideIndex = 0;
            } else if (slideIndex < 0) {
                slideIndex = slidesData.length - 1;
            }
            
            showSlide(slideIndex);
            stopSlideshow();
            startSlideshow(); // Restart auto-scroll
        };

        // Admin and User Management
        let currentUser = null;
        let adminUsers = ['moghaeashu@gmail.com']; // Permanent admin
        let registeredUsers = [];
        let slidesData = [];
        let categoriesData = [];
        let productsData = [];
        let selectedCategory = '';
        let cartItems = [];
        let userAddressData = null;

        // Load data from Firebase and localStorage
        async function loadData() {
            // Load admin and user data from localStorage
            const savedAdmins = localStorage.getItem('adminUsers');
            const savedUsers = localStorage.getItem('registeredUsers');
            
            if (savedAdmins) adminUsers = JSON.parse(savedAdmins);
            if (savedUsers) registeredUsers = JSON.parse(savedUsers);
            
            // Load slides from Firebase Firestore
            await loadSlidesFromFirebase();
            
            // Load categories from Firebase Firestore
            await loadCategoriesFromFirebase();
            
            // Load products from Firebase Firestore
            await loadProductsFromFirebase();
        }

        // Firebase User Address Functions
        async function saveUserAddressToFirebase(addressData) {
            try {
                if (!currentUser) return false;
                
                const userDocRef = doc(db, 'users', currentUser.uid);
                await setDoc(userDocRef, {
                    email: currentUser.email,
                    name: currentUser.displayName,
                    phone: addressData.phone,
                    state: addressData.state,
                    city: addressData.city,
                    address: addressData.address,
                    pincode: addressData.pincode,
                    nearby: addressData.nearby,
                    updatedAt: new Date()
                }, { merge: true });
                
                console.log('User address saved to Firebase');
                return true;
            } catch (error) {
                console.error('Error saving user address:', error);
                return false;
            }
        }

        async function loadUserAddressFromFirebase() {
            try {
                if (!currentUser) return null;
                
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userAddressData = {
                        phone: userData.phone || '',
                        state: userData.state || '',
                        city: userData.city || '',
                        address: userData.address || '',
                        pincode: userData.pincode || '',
                        nearby: userData.nearby || ''
                    };
                    return userAddressData;
                }
                return null;
            } catch (error) {
                console.error('Error loading user address:', error);
                return null;
            }
        }

        // Firebase Cart Functions
        async function saveCartToFirebase() {
            try {
                if (!currentUser) return;
                
                const cartDocRef = doc(db, 'carts', currentUser.uid);
                if (cartItems.length === 0) {
                    // If cart is empty, delete the document
                    await deleteDoc(cartDocRef);
                    console.log('Empty cart removed from Firebase');
                } else {
                    await setDoc(cartDocRef, {
                        userId: currentUser.uid,
                        items: cartItems,
                        updatedAt: new Date()
                    });
                    console.log('Cart saved to Firebase');
                }
            } catch (error) {
                console.error('Error saving cart:', error);
            }
        }

        async function loadCartFromFirebase() {
            try {
                if (!currentUser) {
                    // If no user is logged in, clear cart and show empty state
                    cartItems = [];
                    updateCartCount();
                    updateCartDisplay();
                    updateCartDisplayMain();
                    return;
                }
                
                const cartDocRef = doc(db, 'carts', currentUser.uid);
                const cartDoc = await getDoc(cartDocRef);
                
                if (cartDoc.exists()) {
                    const cartData = cartDoc.data();
                    cartItems = cartData.items || [];
                    console.log('Cart loaded from Firebase:', cartItems.length, 'items');
                } else {
                    // No cart document exists, initialize empty cart
                    cartItems = [];
                    console.log('No cart found in Firebase, initialized empty cart');
                }
                
                // Always update displays after loading
                updateCartCount();
                updateCartDisplay();
                updateCartDisplayMain();
                
            } catch (error) {
                console.error('Error loading cart:', error);
                // On error, initialize empty cart
                cartItems = [];
                updateCartCount();
                updateCartDisplay();
                updateCartDisplayMain();
            }
        }

        // Real-time cart synchronization using Firebase onSnapshot
        let cartUnsubscribe = null;
        
        function setupCartRealTimeListener() {
            try {
                if (!currentUser) {
                    if (cartUnsubscribe) {
                        cartUnsubscribe();
                        cartUnsubscribe = null;
                    }
                    return;
                }
                
                // Clean up existing listener
                if (cartUnsubscribe) {
                    cartUnsubscribe();
                }
                
                const cartDocRef = doc(db, 'carts', currentUser.uid);
                cartUnsubscribe = onSnapshot(cartDocRef, (doc) => {
                    if (doc.exists()) {
                        const cartData = doc.data();
                        cartItems = cartData.items || [];
                        console.log('Cart updated from Firebase real-time:', cartItems.length, 'items');
                    } else {
                        cartItems = [];
                        console.log('Cart document deleted, cleared local cart');
                    }
                    
                    // Update displays in real-time
                    updateCartCount();
                    updateCartDisplay();
                    updateCartDisplayMain();
                }, (error) => {
                    console.error('Error in cart real-time listener:', error);
                });
                
                console.log('Cart real-time listener setup complete');
                
            } catch (error) {
                console.error('Error setting up cart real-time listener:', error);
            }
        }

        // Firebase Orders Functions
        async function saveOrderToFirebase(orderData) {
            try {
                if (!currentUser) return false;
                
                const orderDocRef = await addDoc(collection(db, 'orders'), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    ...orderData,
                    createdAt: new Date()
                });
                
                console.log('Order saved to Firebase with ID:', orderDocRef.id);
                return orderDocRef.id;
            } catch (error) {
                console.error('Error saving order:', error);
                return false;
            }
        }

        async function cancelOrderFromFirebase(orderId) {
            try {
                await deleteDoc(doc(db, 'orders', orderId));
                console.log('Order cancelled and removed from Firebase');
                return true;
            } catch (error) {
                console.error('Error cancelling order:', error);
                return false;
            }
        }

        async function loadOrdersFromFirebase() {
            try {
                if (!currentUser) return [];
                
                const ordersQuery = query(
                    collection(db, 'orders'),
                    where('userId', '==', currentUser.uid)
                );
                
                const querySnapshot = await getDocs(ordersQuery);
                const orders = [];
                
                querySnapshot.forEach((doc) => {
                    orders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date (newest first)
                orders.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                
                console.log('Orders loaded from Firebase:', orders.length, 'orders');
                return orders;
            } catch (error) {
                console.error('Error loading orders:', error);
                return [];
            }
        }

        // Store all orders for filtering
        let allAdminOrders = [];

        // Admin: Load all pending and shipped orders across users
        async function loadPendingOrdersForAdmin() {
            try {
                const adminOrdersList = document.getElementById('adminOrdersList');
                if (!adminOrdersList) return;
                
                adminOrdersList.innerHTML = '<p style="text-align:center; color:#666; padding: 20px;">Loading orders...</p>';
                
                const ordersQuery = query(
                    collection(db, 'orders'),
                    where('status', 'in', ['Pending', 'Shipped'])
                );
                const snapshot = await getDocs(ordersQuery);

                allAdminOrders = [];
                snapshot.forEach(d => allAdminOrders.push({ id: d.id, ...d.data() }));

                // Sort newest first if createdAt exists
                allAdminOrders.sort((a, b) => {
                    const aTime = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
                    const bTime = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
                    return bTime - aTime;
                });

                displayFilteredOrders(allAdminOrders);
            } catch (error) {
                console.error('Error loading orders for admin:', error);
                const adminOrdersList = document.getElementById('adminOrdersList');
                if (adminOrdersList) adminOrdersList.innerHTML = '<p style="text-align:center; color:#e74c3c; padding: 20px;">Failed to load orders.</p>';
            }
        }

        // Display filtered orders
        function displayFilteredOrders(orders) {
            const adminOrdersList = document.getElementById('adminOrdersList');
            if (!adminOrdersList) return;

            adminOrdersList.innerHTML = '';
            if (orders.length === 0) {
                adminOrdersList.innerHTML = '<p style="text-align:center; color:#666; padding: 20px;">No orders found.</p>';
                return;
            }

            orders.forEach(order => {
                const el = document.createElement('div');
                el.className = 'admin-item';
                el.style.border = order.status === 'Shipped' ? '2px solid #3498db' : '1px solid #ddd';
                el.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:flex-start;">
                        <img src="${order.productImage || ''}" alt="${order.productName || ''}" style="width:60px;height:60px;object-fit:contain;border-radius:6px;background:#f8f9fa;border:1px solid #e9ecef;" onerror="this.style.display='none'">
                        <div style="flex:1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="font-weight:700; color:#2c3e50;">${order.productName || 'Product'}</div>
                                <span style="background: ${order.status === 'Pending' ? '#fff3cd' : '#d1ecf1'}; color: ${order.status === 'Pending' ? '#856404' : '#0c5460'}; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                                    ${order.status === 'Pending' ? '⏳' : '🚚'} ${order.status}
                                </span>
                            </div>
                            <div style="font-size:12px; color:#666;">Qty: ${order.quantity || 1} • Total: ₹${order.totalAmount || 0}</div>
                            <div style="font-size:12px; color:#666;">User: ${order.userName || ''} (${order.userEmail || ''})</div>
                            <div style="font-size:12px; color:#666;">📞 ${order.userPhone || ''} • 📍 ${order.userAddress || ''}</div>
                            <div style="font-size:12px; color:#666;">ID: <span style="font-family:monospace;">${order.id}</span></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button class="btn-invoice" style="flex:1; background:#3498db; border:none; padding:8px; border-radius:5px; color:white; font-size:12px;" onclick="showInvoice('${order.id}')">📄 Invoice</button>
                        ${order.status === 'Pending' ? `
                        <button class="btn-primary" style="flex:1; background:#3498db; border:none; padding:8px; border-radius:5px; color:white; font-size:12px;" onclick="adminShipOrder('${order.id}')">Ship</button>
                        ` : ''}
                        <button class="btn-success" style="flex:1; background:#27ae60; border:none; padding:8px; border-radius:5px; color:white; font-size:12px;" onclick="adminCompleteOrder('${order.id}')">Complete</button>
                        <button class="btn-danger" style="flex:1; background:#e74c3c; border:none; padding:8px; border-radius:5px; color:white; font-size:12px;" onclick="adminRejectOrder('${order.id}')">Reject</button>
                    </div>
                `;
                adminOrdersList.appendChild(el);
            });
        }

        // Filter orders by status
        window.filterOrders = function() {
            const filterValue = document.getElementById('orderStatusFilter').value;
            const searchValue = document.getElementById('orderSearchInput').value.toLowerCase();
            
            let filteredOrders = allAdminOrders;
            
            // Apply status filter
            if (filterValue !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === filterValue);
            }
            
            // Apply search filter
            if (searchValue) {
                filteredOrders = filteredOrders.filter(order => 
                    (order.userEmail && order.userEmail.toLowerCase().includes(searchValue)) ||
                    (order.userPhone && order.userPhone.includes(searchValue))
                );
            }
            
            displayFilteredOrders(filteredOrders);
        }

        // Search orders by email or phone
        window.searchOrders = function() {
            filterOrders(); // Use the same filtering logic
        }

        // Clear all filters
        window.clearFilters = function() {
            document.getElementById('orderStatusFilter').value = 'all';
            document.getElementById('orderSearchInput').value = '';
            displayFilteredOrders(allAdminOrders);
        }

        // Admin: update order status to Shipped
        window.adminShipOrder = async function(orderId) {
            try {
                await updateDoc(doc(db, 'orders', orderId), { 
                    status: 'Shipped',
                    shippedAt: new Date()
                });
                
                showNotification('Order marked as shipped! 🚚', 'success');
                
                // Don't schedule deletion for shipped orders - keep them in admin panel
                // Only delete when admin marks as Complete or Reject
                
                loadPendingOrdersForAdmin();
                loadOrdersDataFromFirebase();
            } catch (e) {
                console.error('Error shipping order:', e);
                showNotification('Failed to ship order', 'error');
            }
        }

        // Admin: update order status to Completed
        window.adminCompleteOrder = async function(orderId) {
            try {
                await updateDoc(doc(db, 'orders', orderId), { 
                    status: 'Completed',
                    completedAt: new Date()
                });
                showNotification('Order marked as Completed ✅', 'success');
                
                // Schedule automatic deletion after 30 minutes
                scheduleOrderDeletion(orderId, 30 * 60 * 1000); // 30 minutes in milliseconds
                
                loadPendingOrdersForAdmin();
                // Also refresh user orders if currently viewing
                loadOrdersDataFromFirebase();
            } catch (e) {
                console.error('Error completing order:', e);
                showNotification('Failed to complete order', 'error');
            }
        }

        // Admin: update order status to Rejected
        window.adminRejectOrder = async function(orderId) {
            try {
                await updateDoc(doc(db, 'orders', orderId), { 
                    status: 'Rejected',
                    rejectedAt: new Date()
                });
                showNotification('Order marked as Rejected ❌', 'success');
                
                // Schedule automatic deletion after 30 minutes
                scheduleOrderDeletion(orderId, 30 * 60 * 1000); // 30 minutes in milliseconds
                
                loadPendingOrdersForAdmin();
                loadOrdersDataFromFirebase();
            } catch (e) {
                console.error('Error rejecting order:', e);
                showNotification('Failed to reject order', 'error');
            }
        }

        // Schedule order deletion after specified time
        function scheduleOrderDeletion(orderId, delayMs) {
            console.log(`Scheduling deletion of order ${orderId} in ${delayMs / 1000 / 60} minutes`);
            
            setTimeout(async () => {
                try {
                    await deleteDoc(doc(db, 'orders', orderId));
                    console.log(`Order ${orderId} automatically deleted after completion/rejection`);
                    
                    // Refresh orders display if user is currently viewing orders
                    if (currentUser) {
                        loadOrdersDataFromFirebase();
                    }
                    
                    // Refresh admin orders if admin panel is open
                    loadPendingOrdersForAdmin();
                    
                } catch (error) {
                    console.error(`Error auto-deleting order ${orderId}:`, error);
                }
            }, delayMs);
        }

        // Start countdown timer for order deletion
        function startCountdownTimer(orderId, statusChangeTime) {
            const countdownElement = document.getElementById(`countdown-${orderId}`);
            if (!countdownElement) return;
            
            const statusDate = statusChangeTime?.toDate ? statusChangeTime.toDate() : new Date(statusChangeTime);
            const thirtyMinutes = 30 * 60 * 1000; // 30 minutes in milliseconds
            
            function updateTimer() {
                const now = new Date();
                const timeSinceStatusChange = now.getTime() - statusDate.getTime();
                const remainingTime = thirtyMinutes - timeSinceStatusChange;
                
                if (remainingTime <= 0) {
                    countdownElement.textContent = 'Deleting...';
                    const timerDiv = document.getElementById(`timer-${orderId}`);
                    if (timerDiv) {
                        timerDiv.style.background = '#f8d7da';
                        timerDiv.style.color = '#721c24';
                        timerDiv.innerHTML = '🗑️ Order will be deleted shortly...';
                    }
                    
                    // Actually delete the order when timer reaches 0
                    setTimeout(async () => {
                        try {
                            await deleteDoc(doc(db, 'orders', orderId));
                            console.log(`Order ${orderId} deleted by timer`);
                            
                            // Refresh orders display
                            if (currentUser) {
                                loadOrdersDataFromFirebase();
                            }
                            
                            showNotification('Order automatically deleted 🗑️', 'info', 3000);
                        } catch (error) {
                            console.error(`Error deleting order ${orderId} by timer:`, error);
                        }
                    }, 2000); // Delete after 2 seconds of showing "deleting" message
                    
                    return;
                }
                
                const minutes = Math.floor(remainingTime / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Update immediately
            updateTimer();
            
            // Update every second
            const interval = setInterval(() => {
                updateTimer();
                
                // Stop timer when time is up
                const now = new Date();
                const timeSinceStatusChange = now.getTime() - statusDate.getTime();
                if (timeSinceStatusChange >= thirtyMinutes) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        // Check for existing completed/rejected orders on app load and schedule their deletion
        async function checkAndScheduleExistingOrders() {
            try {
                const completedQuery = query(
                    collection(db, 'orders'),
                    where('status', 'in', ['Completed', 'Rejected', 'Shipped'])
                );
                
                const snapshot = await getDocs(completedQuery);
                
                snapshot.forEach((doc) => {
                    const orderData = doc.data();
                    const completedAt = orderData.completedAt?.toDate();
                    const rejectedAt = orderData.rejectedAt?.toDate();
                    const shippedAt = orderData.shippedAt?.toDate();
                    const statusChangeTime = completedAt || rejectedAt || shippedAt;
                    
                    if (statusChangeTime) {
                        const timeSinceStatusChange = Date.now() - statusChangeTime.getTime();
                        const thirtyMinutes = 30 * 60 * 1000;
                        
                        if (timeSinceStatusChange >= thirtyMinutes) {
                            // Order is already past 30 minutes, delete immediately
                            deleteDoc(doc.ref).then(() => {
                                console.log(`Expired order ${doc.id} deleted immediately`);
                            }).catch(error => {
                                console.error(`Error deleting expired order ${doc.id}:`, error);
                            });
                        } else {
                            // Schedule deletion for remaining time
                            const remainingTime = thirtyMinutes - timeSinceStatusChange;
                            scheduleOrderDeletion(doc.id, remainingTime);
                        }
                    }
                });
            } catch (error) {
                console.error('Error checking existing orders for deletion:', error);
            }
        }

        // Save admin/user data to localStorage
        function saveData() {
            localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
        }

        // Load slides from Firebase Firestore
        async function loadSlidesFromFirebase() {
            try {
                console.log('Loading slides from Firebase...');
                const querySnapshot = await getDocs(collection(db, 'slides'));
                slidesData = [];
                querySnapshot.forEach((doc) => {
                    console.log('Found slide:', doc.id, doc.data());
                    slidesData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                // Sort slides by order if available, otherwise by creation time
                slidesData.sort((a, b) => (a.order || 0) - (b.order || 0));
                console.log('Total slides loaded:', slidesData.length);
                
                // Add fallback slides if no slides found
                if (slidesData.length === 0) {
                    console.log('No slides found, adding fallback slides');
                    slidesData = [
                        {
                            id: 'fallback1',
                            title: 'Welcome to Zupisupi',
                            url: 'https://via.placeholder.com/800x400/3498db/ffffff?text=Welcome+to+Zupisupi',
                            order: 0
                        },
                        {
                            id: 'fallback2', 
                            title: 'Shop Amazing Products',
                            url: 'https://via.placeholder.com/800x400/27ae60/ffffff?text=Shop+Amazing+Products',
                            order: 1
                        }
                    ];
                }
                
                updateSlideshow();
            } catch (error) {
                console.error('Error loading slides from Firebase:', error);
                // Fallback slides for error case
                slidesData = [
                    {
                        id: 'fallback1',
                        title: 'Welcome to Zupisupi',
                        url: 'https://via.placeholder.com/800x400/3498db/ffffff?text=Welcome+to+Zupisupi',
                        order: 0
                    }
                ];
                updateSlideshow();
            }
        }

        // Convert Google Drive sharing URL to direct image URL
        function convertGoogleDriveUrl(url) {
            if (url.includes('drive.google.com/file/d/')) {
                const fileId = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (fileId && fileId[1]) {
                    // Try multiple formats for better compatibility
                    return `https://lh3.googleusercontent.com/d/${fileId[1]}=w800-h400-c`;
                }
            }
            return url; // Return original URL if not a Google Drive link
        }

        // Add event to Firebase Firestore
        async function addEventToFirebase(eventData) {
            try {
                // Remove any existing local ID before sending to Firebase
                delete eventData.id;
                
                const docRef = await addDoc(collection(db, 'events'), eventData);
                console.log('Event added with Firebase ID: ', docRef.id);
                
                // Create new event object with Firebase ID
                const firebaseEvent = {
                    id: docRef.id,
                    ...eventData
                };
                
                console.log('Event with Firebase ID:', firebaseEvent);
                eventsData.push(firebaseEvent);
                return true;
            } catch (error) {
                console.error('Error adding event: ', error);
                return false;
            }
        }

        // Remove event from Firebase Firestore
        async function removeEventFromFirebase(eventId) {
            try {
                console.log('Attempting to delete event with ID:', eventId);
                console.log('Current eventsData before deletion:', eventsData);
                
                // Create document reference
                const eventDocRef = doc(db, 'events', eventId);
                console.log('Document reference created for:', eventId);
                
                // Delete from Firebase with await and error checking
                const deleteResult = await deleteDoc(eventDocRef);
                console.log('Firebase deleteDoc completed. Result:', deleteResult);
                
                // Verify deletion by trying to get the document
                try {
                    const deletedDoc = await getDoc(eventDocRef);
                    if (deletedDoc.exists()) {
                        console.error('ERROR: Document still exists in Firebase after deletion!');
                        return false;
                    } else {
                        console.log('SUCCESS: Document confirmed deleted from Firebase');
                    }
                } catch (verifyError) {
                    console.log('Document verification failed (expected for deleted doc):', verifyError.message);
                }
                
                // Remove from local array only after Firebase deletion is confirmed
                eventsData = eventsData.filter(event => event.id !== eventId);
                console.log('Event removed from local array. New eventsData:', eventsData);
                
                return true;
            } catch (error) {
                console.error('Error removing event from Firebase:', error);
                console.error('Event ID that failed to delete:', eventId);
                console.error('Full error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                return false;
            }
        }

        // Load events from Firebase
        async function loadEventsFromFirebase() {
            try {
                const querySnapshot = await getDocs(collection(db, 'events'));
                eventsData = [];
                querySnapshot.forEach((doc) => {
                    eventsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                console.log('Events loaded:', eventsData);
                return true;
            } catch (error) {
                console.error('Error loading events: ', error);
                return false;
            }
        }

        // Add slide to Firebase Firestore
        async function addSlideToFirebase(title, url) {
            try {
                // Convert Google Drive URL to direct image URL
                const convertedUrl = convertGoogleDriveUrl(url);
                console.log('Original URL:', url);
                console.log('Converted URL:', convertedUrl);
                
                const docRef = await addDoc(collection(db, 'slides'), {
                    title: title,
                    url: convertedUrl,
                    originalUrl: url,
                    order: slidesData.length,
                    createdAt: new Date(),
                    createdBy: currentUser?.email || 'unknown'
                });
                console.log('Slide added with ID: ', docRef.id);
                await loadSlidesFromFirebase(); // Refresh slides
                return true;
            } catch (error) {
                console.error('Error adding slide to Firebase:', error);
                return false;
            }
        }

        // Remove slide from Firebase Firestore
        async function removeSlideFromFirebase(slideId) {
            try {
                await deleteDoc(doc(db, 'slides', slideId));
                console.log('Slide removed from Firebase');
                await loadSlidesFromFirebase(); // Refresh slides
                return true;
            } catch (error) {
                console.error('Error removing slide from Firebase:', error);
                return false;
            }
        }

        // Load categories from Firebase Firestore
        async function loadCategoriesFromFirebase() {
            try {
                console.log('Loading categories from Firebase...');
                const querySnapshot = await getDocs(collection(db, 'categories'));
                categoriesData = [];
                querySnapshot.forEach((doc) => {
                    console.log('Found category:', doc.id, doc.data());
                    categoriesData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                // Sort categories by order if available, otherwise by creation time
                categoriesData.sort((a, b) => (a.order || 0) - (b.order || 0));
                console.log('Total categories loaded:', categoriesData.length);
                
                // Add fallback categories if no categories found
                if (categoriesData.length === 0) {
                    console.log('No categories found, adding fallback categories');
                    categoriesData = [
                        {
                            id: 'clothing',
                            name: 'Clothing',
                            imageUrl: 'https://via.placeholder.com/200x150/e74c3c/ffffff?text=Clothing',
                            order: 0
                        },
                        {
                            id: 'footwear',
                            name: 'Footwear',
                            imageUrl: 'https://via.placeholder.com/200x150/3498db/ffffff?text=Footwear',
                            order: 1
                        },
                        {
                            id: 'accessories',
                            name: 'Accessories',
                            imageUrl: 'https://via.placeholder.com/200x150/27ae60/ffffff?text=Accessories',
                            order: 2
                        }
                    ];
                }
                
                updateCategoriesDisplay();
            } catch (error) {
                console.error('Error loading categories from Firebase:', error);
                // Fallback categories for error case
                categoriesData = [
                    {
                        id: 'general',
                        name: 'General',
                        imageUrl: 'https://via.placeholder.com/200x150/95a5a6/ffffff?text=General',
                        order: 0
                    }
                ];
                updateCategoriesDisplay();
            }
        }

        // Add category to Firebase Firestore
        async function addCategoryToFirebase(name, imageUrl, bannerUrl, subcategories = []) {
            try {
                const convertedUrl = convertGoogleDriveUrl(imageUrl);
                const convertedBannerUrl = convertGoogleDriveUrl(bannerUrl);
                console.log('Adding category:', name, convertedUrl, 'with banner:', convertedBannerUrl, 'and subcategories:', subcategories);
                
                const categoryData = {
                    name: name,
                    imageUrl: convertedUrl,
                    bannerUrl: convertedBannerUrl,
                    subcategories: subcategories,
                    createdAt: new Date()
                };
                
                const docRef = await addDoc(collection(db, 'categories'), categoryData);
                console.log('Category added with ID:', docRef.id);
                return true;
            } catch (error) {
                console.error('Error adding category:', error);
                return false;
            }
        }

        // Remove category from Firebase Firestore
        async function removeCategoryFromFirebase(categoryId) {
            try {
                await deleteDoc(doc(db, 'categories', categoryId));
                console.log('Category removed from Firebase');
                await loadCategoriesFromFirebase();
                return true;
            } catch (error) {
                console.error('Error removing category from Firebase:', error);
                return false;
            }
        }

        // Update categories display on main page
        function updateCategoriesDisplay() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            if (!categoriesGrid) return;
            
            // Preserve the title and clear only category items
            const title = categoriesGrid.querySelector('.section-title');
            categoriesGrid.innerHTML = '';
            if (title) {
                categoriesGrid.appendChild(title);
            }
            
            categoriesData.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.onclick = () => openCategoryModal(category.name);
                categoryItem.innerHTML = `
                    <img src="${category.imageUrl}" alt="${category.name}" class="subcategory-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTIwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjYwIiB5PSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5YWEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPgo='">
                    <div class="subcategory-name">${category.name}</div>
                `;
                categoriesGrid.appendChild(categoryItem);
            });
            
            // Update category dropdown in admin panel
            updateCategoryDropdown();
        }

        // Update category checkboxes in admin panel
        function updateCategoryDropdown() {
            const categoriesContainer = document.getElementById('productCategoriesContainer');
            if (!categoriesContainer) return;
            
            categoriesContainer.innerHTML = '';
            categoriesData.forEach(category => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="cat_${category.name}" value="${category.name}" class="category-checkbox" onchange="loadSubcategoriesForProduct()">
                    <label for="cat_${category.name}" style="flex: 1; cursor: pointer; font-weight: 500;">${category.name}</label>
                `;
                categoriesContainer.appendChild(checkboxDiv);
            });
        }

        // Filter products by category
        function filterProductsByCategory(categoryName) {
            selectedCategory = categoryName;
            updateProductsDisplay();
        }

        // Category Modal Functions
        let currentCategoryProducts = [];
        let currentCategoryName = '';

        let currentSelectedSubcategory = 'All Products';

        window.openCategoryModal = function(categoryName) {
            console.log('Opening category modal for:', categoryName);
            currentCategoryName = categoryName;
            currentSelectedSubcategory = 'All Products';
            
            // Add to modal stack
            modalStack.push('category');
            
            // Add to browser history so back button works
            history.pushState({modal: 'category', categoryName: categoryName}, '', `#category-${categoryName}`);
            
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const searchInput = document.getElementById('categorySearchInput');
            
            title.textContent = categoryName;
            if (searchInput) {
                searchInput.value = '';
            }
            modal.style.display = 'flex';
            modal.classList.add('open');
            
            // Load and display category banner image
            loadCategoryBanner(categoryName);
            
            // Load subcategories for this category
            loadCategorySubcategories(categoryName);
            
            // Load products for this category
            loadCategoryProducts(categoryName);
            
            // Setup scroll behavior for category modal
            setupCategoryModalScroll();
        }

        // Load category banner image
        function loadCategoryBanner(categoryName) {
            console.log('Loading banner for category:', categoryName);
            const bannerSection = document.getElementById('categoryBannerSection');
            const bannerImage = document.getElementById('categoryBannerImage');
            const modalBody = document.querySelector('.category-modal-body');
            
            console.log('Banner section:', bannerSection);
            console.log('Banner image:', bannerImage);
            
            if (!bannerSection || !bannerImage || !modalBody) {
                console.log('Banner elements not found');
                return;
            }
            
            // Find the category data
            const category = categoriesData.find(cat => cat.name === categoryName);
            console.log('Found category:', category);
            
            if (category && category.bannerUrl) {
                console.log('Using banner URL:', category.bannerUrl);
                bannerImage.src = category.bannerUrl;
                bannerImage.alt = `${categoryName} Banner`;
                bannerSection.style.display = 'block';
                bannerSection.classList.remove('hidden');
                modalBody.classList.add('banner-visible');
            } else if (category && category.imageUrl) {
                console.log('Using category image URL:', category.imageUrl);
                bannerImage.src = category.imageUrl;
                bannerImage.alt = `${categoryName} Banner`;
                bannerSection.style.display = 'block';
                bannerSection.classList.remove('hidden');
                modalBody.classList.add('banner-visible');
            } else {
                console.log('No banner or image URL found, using default banner');
                // Use a default banner with category name
                bannerImage.src = `https://via.placeholder.com/800x200/3498db/ffffff?text=${encodeURIComponent(categoryName)}`;
                bannerImage.alt = `${categoryName} Banner`;
                bannerSection.style.display = 'block';
                bannerSection.classList.remove('hidden');
                modalBody.classList.add('banner-visible');
            }
        }

        window.closeCategoryModal = function() {
            console.log('Closing category modal');
            
            // Remove from modal stack if present
            const categoryIndex = modalStack.lastIndexOf('category');
            if (categoryIndex !== -1) {
                modalStack.splice(categoryIndex, 1);
            }
            
            const modal = document.getElementById('categoryModal');
            if (modal) {
                modal.classList.remove('open');
                modal.style.display = 'none';
            }
            currentCategoryProducts = [];
            currentCategoryName = '';
            
            // Reset header, search bar, banner and sidebar positions
            const header = document.querySelector('.category-modal-header');
            const searchSection = document.querySelector('.category-search-section');
            const bannerSection = document.querySelector('.category-banner-section');
            const sidebar = document.querySelector('.category-sidebar');
            const modalBody = document.querySelector('.category-modal-body');
            if (header) {
                header.classList.remove('hidden');
            }
            if (searchSection) {
                searchSection.classList.remove('sticky');
            }
            if (bannerSection) {
                bannerSection.classList.remove('hidden');
            }
            if (sidebar) {
                sidebar.classList.remove('sticky-mode');
            }
            if (document.querySelector('.category-products-area')) {
                document.querySelector('.category-products-area').classList.remove('sticky-mode');
            }
            if (modalBody) {
                modalBody.classList.remove('sticky-mode');
            }
        }

        function setupCategoryModalScroll() {
            const productsArea = document.querySelector('.category-products-area');
            const header = document.querySelector('.category-modal-header');
            const searchSection = document.querySelector('.category-search-section');
            const bannerSection = document.querySelector('.category-banner-section');
            const sidebar = document.querySelector('.category-sidebar');
            
            if (!productsArea || !header || !searchSection || !bannerSection || !sidebar) return;
            
            let lastScrollTop = 0;
            let isScrolling = false;
            
            productsArea.addEventListener('scroll', function() {
                if (isScrolling) return;
                
                isScrolling = true;
                requestAnimationFrame(() => {
                    const scrollTop = productsArea.scrollTop;
                    const scrollDirection = scrollTop > lastScrollTop ? 'down' : 'up';
                    
                    const modalBody = document.querySelector('.category-modal-body');
                    
                    if (scrollTop > 10) { // Start hiding banner immediately on scroll
                        // Hide banner when scrolling
                        bannerSection.classList.add('hidden');
                        if (modalBody) modalBody.classList.remove('banner-visible');
                    } else {
                        // Show banner when at top
                        bannerSection.classList.remove('hidden');
                        if (modalBody) modalBody.classList.add('banner-visible');
                    }
                    
                    if (scrollTop > 50) { // Start hiding header after 50px scroll
                        if (scrollDirection === 'down') {
                            // Hide header and make search bar sticky
                            header.classList.add('hidden');
                            searchSection.classList.add('sticky');
                            sidebar.classList.add('sticky-mode');
                            productsArea.classList.add('sticky-mode');
                            document.querySelector('.category-modal-body').classList.add('sticky-mode');
                        }
                    } else {
                        // Show header and remove sticky search bar
                        header.classList.remove('hidden');
                        searchSection.classList.remove('sticky');
                        sidebar.classList.remove('sticky-mode');
                        productsArea.classList.remove('sticky-mode');
                        document.querySelector('.category-modal-body').classList.remove('sticky-mode');
                    }
                    
                    if (scrollDirection === 'up' && scrollTop < 100) {
                        // Show header when scrolling up near top
                        header.classList.remove('hidden');
                        searchSection.classList.remove('sticky');
                        sidebar.classList.remove('sticky-mode');
                        productsArea.classList.remove('sticky-mode');
                        document.querySelector('.category-modal-body').classList.remove('sticky-mode');
                    }
                    
                    lastScrollTop = scrollTop;
                    isScrolling = false;
                });
            });
        }

        function loadCategorySubcategories(categoryName) {
            const subcategoriesContainer = document.getElementById('categoryModalSubcategories');
            const bannerImage = document.getElementById('categoryBannerImage');
            if (!subcategoriesContainer) return;
            
            // Find the category
            const category = categoriesData.find(cat => cat.name === categoryName);
            
            // Set banner image
            if (category && category.bannerUrl) {
                bannerImage.src = category.bannerUrl;
                bannerImage.style.display = 'block';
            } else {
                bannerImage.src = category ? category.imageUrl : 'https://via.placeholder.com/800x200/fbbf24/ffffff?text=' + encodeURIComponent(categoryName);
                bannerImage.style.display = 'block';
            }
            
            // Clear container
            subcategoriesContainer.innerHTML = '';
            
            // Add "All Products" item
            const allItem = document.createElement('div');
            allItem.className = 'subcategory-sidebar-item active';
            const categoryImage = category ? category.imageUrl : 'https://via.placeholder.com/60x45/fbbf24/ffffff?text=All';
            allItem.innerHTML = `
                <img src="${categoryImage}" alt="All Products" class="subcategory-sidebar-image">
                <div class="subcategory-sidebar-name">All Products</div>
            `;
            allItem.onclick = () => filterBySubcategory('All Products');
            subcategoriesContainer.appendChild(allItem);
            
            // Add subcategory items
            if (category && category.subcategories && category.subcategories.length > 0) {
                category.subcategories.forEach(subcategory => {
                    const item = document.createElement('div');
                    item.className = 'subcategory-sidebar-item';
                    item.innerHTML = `
                        <img src="${subcategory.imageUrl || 'https://via.placeholder.com/60x45/e5e7eb/374151?text=' + encodeURIComponent(subcategory.name.charAt(0))}" alt="${subcategory.name}" class="subcategory-sidebar-image">
                        <div class="subcategory-sidebar-name">${subcategory.name}</div>
                    `;
                    item.onclick = () => filterBySubcategory(subcategory.name);
                    subcategoriesContainer.appendChild(item);
                });
            }
        }

        function filterBySubcategory(subcategoryName) {
            currentSelectedSubcategory = subcategoryName;
            
            // Update sidebar item states
            const items = document.querySelectorAll('.subcategory-sidebar-item');
            items.forEach(item => {
                item.classList.remove('active');
                const nameElement = item.querySelector('.subcategory-sidebar-name');
                if (nameElement && nameElement.textContent === subcategoryName) {
                    item.classList.add('active');
                }
            });
            
            // Update banner image based on selected subcategory
            updateBannerForSubcategory(subcategoryName);
            
            // Filter products
            filterCategoryProducts();
        }
        
        function updateBannerForSubcategory(subcategoryName) {
            const bannerImage = document.getElementById('categoryBannerImage');
            if (!bannerImage) return;
            
            // Find the current category
            const category = categoriesData.find(cat => cat.name === currentCategoryName);
            if (!category) return;
            
            if (subcategoryName === 'All Products') {
                // Show main category banner
                if (category.bannerUrl) {
                    bannerImage.src = category.bannerUrl;
                } else {
                    bannerImage.src = category.imageUrl;
                }
            } else {
                // Find and show subcategory banner
                const subcategory = category.subcategories?.find(sub => sub.name === subcategoryName);
                if (subcategory && subcategory.bannerUrl) {
                    bannerImage.src = subcategory.bannerUrl;
                } else if (subcategory && subcategory.imageUrl) {
                    bannerImage.src = subcategory.imageUrl;
                } else {
                    // Fallback to category banner/image
                    bannerImage.src = category.bannerUrl || category.imageUrl;
                }
            }
        }

        function loadCategoryProducts(categoryName) {
            console.log('Loading products for category:', categoryName);
            console.log('Total products available:', productsData.length);
            
            // Filter products by category
            currentCategoryProducts = productsData.filter(product => 
                product.category && product.category.toLowerCase() === categoryName.toLowerCase()
            );
            
            console.log('Products found for category:', currentCategoryProducts.length);
            filterCategoryProducts();
        }

        function filterCategoryProducts() {
            let filteredProducts = [...currentCategoryProducts];
            
            // Filter by subcategory if not "All Products"
            if (currentSelectedSubcategory !== 'All Products') {
                filteredProducts = filteredProducts.filter(product => 
                    product.subcategories && 
                    product.subcategories.includes(currentSelectedSubcategory)
                );
            }
            
            // Filter by search term if exists
            const searchInput = document.getElementById('categorySearchInput');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase().trim();
                filteredProducts = filteredProducts.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm))
                );
            }
            
            displayCategoryProducts(filteredProducts);
        }

        function displayCategoryProducts(products) {
            const grid = document.getElementById('categoryProductsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="no-products-message">No products found in this category</div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const rating = product.rating || 4.5;
                const stars = '⭐'.repeat(Math.floor(rating));
                
                // Calculate discount pricing
                let priceHTML = '';
                if (product.originalPrice && product.discount && product.originalPrice > product.price) {
                    priceHTML = `
                        <div class="category-product-price">
                            <span class="category-current-price">₹${product.price}</span>
                            <span class="category-original-price">₹${product.originalPrice}</span>
                            <span class="category-discount-badge">${product.discount}% off</span>
                        </div>
                    `;
                } else {
                    priceHTML = `
                        <div class="category-product-price">
                            <span class="category-current-price">₹${product.price}</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="category-product-card" onclick="openProductModal('${product.id}')">
                        <img src="${product.imageUrl}" alt="${product.name}" class="category-product-image" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                        <div class="category-product-info">
                            <h3 class="category-product-name">${product.name}</h3>
                            <div class="category-product-rating">
                                <span>${stars}</span>
                                <span>(${rating})</span>
                            </div>
                            ${priceHTML}
                            <button class="category-view-btn" onclick="event.stopPropagation(); openProductModal('${product.id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.searchCategoryProducts = function() {
            console.log('Search function called');
            const searchInput = document.getElementById('categorySearchInput');
            if (!searchInput) {
                console.log('Search input not found');
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase();
            console.log('Search term:', searchTerm);
            console.log('Current category products:', currentCategoryProducts.length);
            
            if (!searchTerm || searchTerm.trim() === '') {
                displayCategoryProducts(currentCategoryProducts);
                return;
            }
            
            const filteredProducts = currentCategoryProducts.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                (product.description && product.description.toLowerCase().includes(searchTerm))
            );
            
            console.log('Filtered products:', filteredProducts.length);
            displayCategoryProducts(filteredProducts);
        }

        window.searchCategoryProducts = function() {
            filterCategoryProducts();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('categoryModal');
            if (event.target === modal) {
                closeCategoryModal();
            }
        });

        // Admin category management functions
        window.addCategory = async function() {
            const name = document.getElementById('categoryName').value;
            const imageUrl = document.getElementById('categoryImageUrl').value;
            const bannerUrl = document.getElementById('categoryBannerUrl').value;
            
            if (!name || !imageUrl || !bannerUrl) {
                alert('Please fill in all fields including banner image');
                return;
            }
            
            // Collect subcategories
            const subcategories = collectSubcategories();
            
            if (subcategories.length === 0) {
                alert('Please add at least one subcategory');
                return;
            }
            
            const success = await addCategoryToFirebase(name, imageUrl, bannerUrl, subcategories);
            if (success) {
                loadCategoriesAdminData();
                // Clear form
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryImageUrl').value = '';
                document.getElementById('categoryBannerUrl').value = '';
                clearSubcategoriesForm();
            } else {
                alert('Failed to add category');
            }
        };

        // Subcategory management functions
        window.addSubcategoryInput = function() {
            const container = document.getElementById('subcategoriesContainer');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'subcategory-input-group';
            inputGroup.style.cssText = 'display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;';
            inputGroup.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="subcategory-name" placeholder="Subcategory Name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <button type="button" onclick="removeSubcategoryInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
                <input type="url" class="subcategory-image" placeholder="Subcategory Image URL" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="url" class="subcategory-banner" placeholder="Subcategory Banner Image URL" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            `;
            container.appendChild(inputGroup);
        };
        
        window.closeAddSubcategoryModal = closeAddSubcategoryModal;
        window.saveNewSubcategory = saveNewSubcategory;

        window.removeSubcategoryInput = function(button) {
            const inputGroup = button.parentElement;
            inputGroup.remove();
        };

        function collectSubcategories() {
            const subcategories = [];
            const inputGroups = document.querySelectorAll('.subcategory-input-group');
            
            inputGroups.forEach(group => {
                const nameInput = group.querySelector('.subcategory-name');
                const imageInput = group.querySelector('.subcategory-image');
                const bannerInput = group.querySelector('.subcategory-banner');
                
                if (nameInput.value.trim() && imageInput.value.trim() && bannerInput.value.trim()) {
                    subcategories.push({
                        name: nameInput.value.trim(),
                        imageUrl: convertGoogleDriveUrl(imageInput.value.trim()),
                        bannerUrl: convertGoogleDriveUrl(bannerInput.value.trim())
                    });
                }
            });
            
            return subcategories;
        }

        function clearSubcategoriesForm() {
            const container = document.getElementById('subcategoriesContainer');
            // Keep only the first input group and clear it
            const inputGroups = container.querySelectorAll('.subcategory-input-group');
            
            // Remove all but the first input group
            for (let i = 1; i < inputGroups.length; i++) {
                inputGroups[i].remove();
            }
            // Clear the first input group
            if (inputGroups[0]) {
                inputGroups[0].querySelector('.subcategory-name').value = '';
                inputGroups[0].querySelector('.subcategory-image').value = '';
                inputGroups[0].querySelector('.subcategory-banner').value = '';
            }
        }

        window.loadSubcategoriesForProduct = function() {
            const subcategoriesSection = document.getElementById('productSubcategoriesSection');
            const subcategoriesContainer = document.getElementById('productSubcategoriesContainer');
            
            // Get selected categories
            const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);
            
            if (selectedCategories.length === 0) {
                subcategoriesSection.style.display = 'none';
                return;
            }
            
            // Show subcategories section
            subcategoriesSection.style.display = 'block';
            
            // Clear and populate subcategories
            subcategoriesContainer.innerHTML = '';
            
            // Collect all subcategories from selected categories
            const allSubcategories = [];
            selectedCategories.forEach(categoryName => {
                const category = categoriesData.find(cat => cat.name === categoryName);
                if (category && category.subcategories) {
                    category.subcategories.forEach(sub => {
                        if (!allSubcategories.find(s => s.name === sub.name)) {
                            allSubcategories.push({...sub, parentCategory: categoryName});
                        }
                    });
                }
            });
            
            if (allSubcategories.length === 0) {
                subcategoriesContainer.innerHTML = '<p style="color: #666; text-align: center; grid-column: 1 / -1;">No subcategories available for selected categories.</p>';
                return;
            }
            
            allSubcategories.forEach(subcategory => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="sub_${subcategory.name}" value="${subcategory.name}" class="subcategory-checkbox">
                    <label for="sub_${subcategory.name}" style="flex: 1; cursor: pointer; font-weight: 500;">${subcategory.name}</label>
                    <span style="font-size: 10px; color: #666; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${subcategory.parentCategory}</span>
                `;
                subcategoriesContainer.appendChild(checkboxDiv);
            });
        };

        window.removeCategory = async function(categoryId) {
            console.log('Attempting to remove category with ID:', categoryId);
            const success = await removeCategoryFromFirebase(categoryId);
            if (success) {
                loadCategoriesAdminData();
            } else {
                showNotification('Error removing category. Please try again.', 'error');
            }
        }

        function loadCategoriesAdminData() {
            const categoriesAdminList = document.getElementById('categoriesAdminList');
            if (!categoriesAdminList) return;
            
            categoriesAdminList.innerHTML = '';
            
            categoriesData.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'admin-category-card';
                categoryDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white;';
                
                let subcategoriesHtml = '';
                if (category.subcategories && category.subcategories.length > 0) {
                    subcategoriesHtml = `
                        <div style="margin-top: 10px;">
                            <h5 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">Subcategories:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${category.subcategories.map((sub, subIndex) => `
                                    <div style="display: flex; align-items: center; background: #f8f9fa; padding: 5px 10px; border-radius: 15px; border: 1px solid #e9ecef;">
                                        <span style="font-size: 12px; margin-right: 8px;">${sub.name}</span>
                                        <button onclick="removeSubcategory('${category.id}', ${subIndex})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    subcategoriesHtml = '<p style="margin: 8px 0 0 0; font-size: 12px; color: #999; font-style: italic;">No subcategories</p>';
                }
                
                categoryDiv.innerHTML = `
                    <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${category.name}</h4>
                    ${subcategoriesHtml}
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn-primary" onclick="addSubcategoryToCategory('${category.id}')" style="background: #28a745; font-size: 12px; padding: 6px 12px;">+ Add Subcategory</button>
                        <button class="btn-danger" onclick="removeCategory('${category.id}')" style="font-size: 12px; padding: 6px 12px;">Remove Category</button>
                    </div>
                `;
                categoriesAdminList.appendChild(categoryDiv);
            });
        }

        function filterCategoriesAdmin() {
            const searchTerm = document.getElementById('adminCategorySearchInput').value.toLowerCase();
            const categoriesAdminList = document.getElementById('categoriesAdminList');
            const categoryCards = categoriesAdminList.querySelectorAll('.admin-category-card');
            
            categoryCards.forEach(card => {
                const categoryName = card.querySelector('h4').textContent.toLowerCase();
                if (categoryName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Remove subcategory from a category
        window.removeSubcategory = async function(categoryId, subIndex) {
            if (!confirm('Are you sure you want to remove this subcategory?')) return;
            
            try {
                const category = categoriesData.find(cat => cat.id === categoryId);
                if (!category) return;
                
                const updatedSubcategories = category.subcategories.filter((_, index) => index !== subIndex);
                
                const categoryRef = doc(db, 'categories', categoryId);
                await updateDoc(categoryRef, {
                    subcategories: updatedSubcategories,
                    updatedAt: new Date()
                });
                
                showNotification('Subcategory removed successfully! ✅', 'success');
                await loadCategoriesFromFirebase();
                loadCategoriesAdminData();
                
            } catch (error) {
                console.error('Error removing subcategory:', error);
                showNotification('Error removing subcategory. Please try again.', 'error');
            }
        }
        
        let currentCategoryIdForSubcategory = null;
        
        // Add new subcategory to existing category
        window.addSubcategoryToCategory = function(categoryId) {
            currentCategoryIdForSubcategory = categoryId;
            const modal = document.getElementById('addSubcategoryModal');
            modal.style.display = 'flex';
            
            // Clear form
            document.getElementById('newSubcategoryName').value = '';
            document.getElementById('newSubcategoryImage').value = '';
            document.getElementById('newSubcategoryBanner').value = '';
        }
        
        function closeAddSubcategoryModal() {
            const modal = document.getElementById('addSubcategoryModal');
            modal.style.display = 'none';
            currentCategoryIdForSubcategory = null;
        }
        
        async function saveNewSubcategory() {
            const subcategoryName = document.getElementById('newSubcategoryName').value.trim();
            const subcategoryImage = document.getElementById('newSubcategoryImage').value.trim();
            const subcategoryBanner = document.getElementById('newSubcategoryBanner').value.trim();
            
            if (!subcategoryName) {
                alert('Please enter subcategory name');
                return;
            }
            
            try {
                const category = categoriesData.find(cat => cat.id === currentCategoryIdForSubcategory);
                if (!category) return;
                
                const newSubcategory = {
                    name: subcategoryName,
                    imageUrl: subcategoryImage ? convertGoogleDriveUrl(subcategoryImage) : '',
                    bannerUrl: subcategoryBanner ? convertGoogleDriveUrl(subcategoryBanner) : ''
                };
                
                const updatedSubcategories = [...(category.subcategories || []), newSubcategory];
                
                const categoryRef = doc(db, 'categories', currentCategoryIdForSubcategory);
                await updateDoc(categoryRef, {
                    subcategories: updatedSubcategories,
                    updatedAt: new Date()
                });
                
                showNotification('Subcategory added successfully! ✅', 'success');
                await loadCategoriesFromFirebase();
                loadCategoriesAdminData();
                closeAddSubcategoryModal();
                
            } catch (error) {
                console.error('Error adding subcategory:', error);
                showNotification('Error adding subcategory. Please try again.', 'error');
            }
        }

        function closeEditCategoryModal() {
            const modal = document.getElementById('editCategoryModal');
            modal.style.display = 'none';
            editingCategoryId = null;
        }

        function addEditSubcategory(name = '', imageUrl = '', bannerUrl = '') {
            const container = document.getElementById('editSubcategoriesContainer');
            const subcategoryItem = document.createElement('div');
            subcategoryItem.className = 'edit-subcategory-item';
            
            subcategoryItem.innerHTML = `
                <button type="button" class="edit-subcategory-remove" onclick="this.parentElement.remove()">×</button>
                <input type="text" placeholder="Subcategory Name" value="${name}" required>
                <input type="url" placeholder="Subcategory Image URL" value="${imageUrl}">
                <input type="url" placeholder="Subcategory Banner URL" value="${bannerUrl}">
            `;
            
            container.appendChild(subcategoryItem);
        }

        function collectEditSubcategories() {
            const container = document.getElementById('editSubcategoriesContainer');
            const subcategoryItems = container.querySelectorAll('.edit-subcategory-item');
            const subcategories = [];
            
            subcategoryItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const imageUrl = inputs[1].value.trim();
                const bannerUrl = inputs[2].value.trim();
                
                if (name) {
                    subcategories.push({
                        name: name,
                        imageUrl: imageUrl ? convertGoogleDriveUrl(imageUrl) : '',
                        bannerUrl: bannerUrl ? convertGoogleDriveUrl(bannerUrl) : ''
                    });
                }
            });
            
            return subcategories;
        }

        async function saveEditCategory() {
            const name = document.getElementById('editCategoryName').value.trim();
            const imageUrl = document.getElementById('editCategoryImageUrl').value.trim();
            const bannerUrl = document.getElementById('editCategoryBannerUrl').value.trim();
            
            if (!name || !imageUrl || !bannerUrl) {
                alert('Please fill in all fields including banner image');
                return;
            }
            
            const subcategories = collectEditSubcategories();
            
            if (subcategories.length === 0) {
                alert('Please add at least one subcategory');
                return;
            }
            
            try {
                const categoryRef = doc(db, 'categories', editingCategoryId);
                await updateDoc(categoryRef, {
                    name: name,
                    imageUrl: convertGoogleDriveUrl(imageUrl),
                    bannerUrl: convertGoogleDriveUrl(bannerUrl),
                    subcategories: subcategories,
                    updatedAt: new Date()
                });
                
                showNotification('Category updated successfully! ✅', 'success');
                await loadCategoriesFromFirebase();
                loadCategoriesAdminData();
                closeEditCategoryModal();
                
            } catch (error) {
                console.error('Error updating category:', error);
                showNotification('Error updating category. Please try again.', 'error');
            }
        }

        // Load products from Firebase Firestore
        async function loadProductsFromFirebase() {
            try {
                console.log('Loading products from Firebase...');
                const querySnapshot = await getDocs(collection(db, 'products'));
                productsData = [];
                querySnapshot.forEach((doc) => {
                    console.log('Found product:', doc.id, doc.data());
                    productsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                // Sort products by order if available, otherwise by creation time
                productsData.sort((a, b) => (a.order || 0) - (b.order || 0));
                console.log('Total products loaded:', productsData.length);
                
                // Add fallback products if no products found
                if (productsData.length === 0) {
                    console.log('No products found, adding fallback products');
                    productsData = [
                        {
                            id: 'sample1',
                            name: 'Sample T-Shirt',
                            price: 299,
                            imageUrl: 'https://via.placeholder.com/300x300/e74c3c/ffffff?text=T-Shirt',
                            description: 'Comfortable cotton t-shirt',
                            category: 'Clothing'
                        },
                        {
                            id: 'sample2',
                            name: 'Sample Jeans',
                            price: 599,
                            imageUrl: 'https://via.placeholder.com/300x300/3498db/ffffff?text=Jeans',
                            description: 'Stylish denim jeans',
                            category: 'Clothing'
                        },
                        {
                            id: 'sample3',
                            name: 'Sample Shoes',
                            price: 899,
                            imageUrl: 'https://via.placeholder.com/300x300/27ae60/ffffff?text=Shoes',
                            description: 'Comfortable running shoes',
                            category: 'Footwear'
                        }
                    ];
                }
                
                updateProductsDisplay();
            } catch (error) {
                console.error('Error loading products from Firebase:', error);
                // Fallback products for error case
                productsData = [
                    {
                        id: 'sample1',
                        name: 'Sample Product',
                        price: 299,
                        imageUrl: 'https://via.placeholder.com/300x300/95a5a6/ffffff?text=Product',
                        description: 'Sample product description',
                        category: 'General'
                    }
                ];
                updateProductsDisplay();
            }
        }

        // Add product to Firebase Firestore
        async function addProductToFirebase(name, imageUrl, description, finalPrice, subImages, categories, sizes, sizePricing, deliveryCharge, rating, originalPrice, discount, weightPricing, subcategories = []) {
            try {
                const convertedUrl = convertGoogleDriveUrl(imageUrl);
                const subImagesArray = subImages ? subImages.split(',').map(url => convertGoogleDriveUrl(url.trim())) : [];
                
                const productData = {
                    name: name,
                    imageUrl: convertedUrl,
                    description: description,
                    price: parseFloat(finalPrice),
                    originalPrice: parseFloat(originalPrice),
                    discount: parseFloat(discount),
                    basePrice: parseFloat(finalPrice), // Keep for compatibility
                    deliveryCharge: parseFloat(deliveryCharge),
                    rating: parseFloat(rating),
                    subImages: subImagesArray,
                    categories: categories || [], // Multiple categories
                    category: categories && categories.length > 0 ? categories[0] : '', // Primary category for backward compatibility
                    subcategories: subcategories || [],
                    sizes: sizes || [],
                    sizePricing: sizePricing || {},
                    weightPricing: weightPricing || { ml: [], g: [], kg: [] },
                    createdAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(collection(db, 'products'), productData);
                console.log('Product added with ID:', docRef.id);
                
                // Reload products data
                await loadProductsFromFirebase();
                loadProductsAdminData();
                
                return true;
            } catch (error) {
                console.error('Error adding product:', error);
                return false;
            }
        }

        // Remove product from Firebase Firestore
        async function removeProductFromFirebase(productId) {
            try {
                await deleteDoc(doc(db, 'products', productId));
                console.log('Product removed from Firebase');
                await loadProductsFromFirebase();
                return true;
            } catch (error) {
                console.error('Error removing product from Firebase:', error);
                return false;
            }
        }

        // Update products display on main page
        function updateProductsDisplay() {
            const productsGrid = document.getElementById('productsGrid');
            if (!productsGrid) return;

            // Preserve the title and clear only product items
            const title = productsGrid.querySelector('.section-title');
            productsGrid.innerHTML = '';
            if (title) {
                productsGrid.appendChild(title);
            }

            // Filter products by selected category
            const filteredProducts = selectedCategory 
                ? productsData.filter(product => product.category === selectedCategory)
                : productsData;

            // Show all products in rows of 2
            const displayProducts = filteredProducts;

            displayProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => openProductModal(product.id);
                
                // Create pricing display with discount
                const originalPrice = product.originalPrice;
                const currentPrice = product.price;
                const discount = product.discount;
                
                let priceHTML = '';
                if (originalPrice && originalPrice > currentPrice && discount > 0) {
                    priceHTML = `
                        <div class="product-price-container">
                            <div class="special-price-label" style="color: #27ae60; font-size: 12px; font-weight: 600; margin-bottom: 2px;">Special price</div>
                            <div class="price-row" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span class="current-price" style="color: #27ae60; font-size: 18px; font-weight: 700;">₹${currentPrice}</span>
                                <span class="original-price" style="color: #999; font-size: 14px; text-decoration: line-through;">₹${originalPrice}</span>
                                <span class="discount-badge" style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600;">${discount}% off</span>
                            </div>
                        </div>
                    `;
                } else {
                    priceHTML = `<div class="product-price" style="color: #27ae60; font-size: 18px; font-weight: 700;">₹${currentPrice}</div>`;
                }
                
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-rating" style="color: #fbbf24; font-size: 14px; margin: 4px 0;">
                            ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                        </div>
                        ${priceHTML}
                        <div class="product-buttons">
                            <button class="btn-cart" onclick="event.stopPropagation(); openProductModal('${product.id}')">Add to Cart</button>
                            <button class="btn-order" onclick="event.stopPropagation(); openProductModal('${product.id}')">Order Now</button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });

            // Show message if no products found for selected category
            if (filteredProducts.length === 0 && selectedCategory) {
                const title = productsGrid.querySelector('.section-title');
                productsGrid.innerHTML = '';
                if (title) {
                    productsGrid.appendChild(title);
                }
                const noProductsMsg = document.createElement('p');
                noProductsMsg.style.cssText = 'text-align: center; color: #666; grid-column: 1 / -1;';
                noProductsMsg.textContent = `No products found in "${selectedCategory}" category.`;
                productsGrid.appendChild(noProductsMsg);
            }
        }

        // Functions for managing multiple product images
        window.addImageInput = function() {
            const container = document.getElementById('additionalImagesContainer');
            const newImageGroup = document.createElement('div');
            newImageGroup.className = 'image-input-group';
            newImageGroup.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            newImageGroup.innerHTML = `
                <input type="url" class="additional-image-url" placeholder="Additional Image URL" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <button type="button" onclick="removeImageInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">Remove</button>
            `;
            container.appendChild(newImageGroup);
        }

        window.removeImageInput = function(button) {
            const container = document.getElementById('additionalImagesContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showNotification('At least one additional image input is required', 'warning');
            }
        }

        // Function to collect all additional image URLs
        function collectAdditionalImages() {
            const additionalImageInputs = document.querySelectorAll('.additional-image-url');
            const imageUrls = [];
            additionalImageInputs.forEach(input => {
                if (input.value.trim()) {
                    imageUrls.push(input.value.trim());
                }
            });
            return imageUrls.join(',');
        }

        // Function to clear additional image inputs
        function clearAdditionalImages() {
            const container = document.getElementById('additionalImagesContainer');
            container.innerHTML = `
                <div class="image-input-group" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="url" class="additional-image-url" placeholder="Additional Image URL" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <button type="button" onclick="removeImageInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
            `;
        }

        // Admin product management functions
        // Auto-calculate final price when original price or discount changes
        window.calculateFinalPrice = function() {
            const originalPrice = parseFloat(document.getElementById('productOriginalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('productDiscount').value) || 0;
            
            if (originalPrice > 0) {
                const finalPrice = originalPrice - (originalPrice * discount / 100);
                document.getElementById('productFinalPrice').value = finalPrice.toFixed(2);
            } else {
                document.getElementById('productFinalPrice').value = '';
            }
        };
        
        // Add event listeners for price calculation
        document.addEventListener('DOMContentLoaded', function() {
            const originalPriceInput = document.getElementById('productOriginalPrice');
            const discountInput = document.getElementById('productDiscount');
            
            if (originalPriceInput) {
                originalPriceInput.addEventListener('input', calculateFinalPrice);
            }
            if (discountInput) {
                discountInput.addEventListener('input', calculateFinalPrice);
            }
        });
        
        // Weight-based pricing functions
        window.addWeightInput = function(containerId, unit) {
            const container = document.getElementById(containerId);
            const newWeightGroup = document.createElement('div');
            newWeightGroup.className = 'weight-input-group';
            newWeightGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
            newWeightGroup.innerHTML = `
                <input type="number" class="weight-quantity" placeholder="Quantity (${unit})" min="1" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                <input type="number" class="weight-price" placeholder="Price (₹)" step="0.01" min="0" style="width: 120px; padding: 8px; border: 1px solid #e74c3c; border-radius: 4px;">
                <button type="button" onclick="removeWeightInput(this)" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
            `;
            container.appendChild(newWeightGroup);
        };
        
        window.removeWeightInput = function(button) {
            const weightGroup = button.parentElement;
            weightGroup.remove();
        };
        
        // Collect weight-based pricing data
        function collectWeightPricing() {
            const weightPricing = {
                ml: [],
                g: [],
                kg: []
            };
            
            // Collect ML pricing
            const mlContainer = document.getElementById('mlContainer');
            const mlGroups = mlContainer.querySelectorAll('.weight-input-group');
            mlGroups.forEach(group => {
                const quantity = group.querySelector('.weight-quantity').value;
                const price = group.querySelector('.weight-price').value;
                if (quantity && price) {
                    weightPricing.ml.push({ quantity: parseInt(quantity), price: parseFloat(price) });
                }
            });
            
            // Collect G pricing
            const gContainer = document.getElementById('gContainer');
            const gGroups = gContainer.querySelectorAll('.weight-input-group');
            gGroups.forEach(group => {
                const quantity = group.querySelector('.weight-quantity').value;
                const price = group.querySelector('.weight-price').value;
                if (quantity && price) {
                    weightPricing.g.push({ quantity: parseInt(quantity), price: parseFloat(price) });
                }
            });
            
            // Collect KG pricing
            const kgContainer = document.getElementById('kgContainer');
            const kgGroups = kgContainer.querySelectorAll('.weight-input-group');
            kgGroups.forEach(group => {
                const quantity = group.querySelector('.weight-quantity').value;
                const price = group.querySelector('.weight-price').value;
                if (quantity && price) {
                    weightPricing.kg.push({ quantity: parseInt(quantity), price: parseFloat(price) });
                }
            });
            
            return weightPricing;
        }

        window.addProduct = async function() {
            const name = document.getElementById('productName').value;
            const imageUrl = document.getElementById('productImageUrl').value;
            const description = document.getElementById('productDescription').value;
            const originalPrice = document.getElementById('productOriginalPrice').value;
            const discount = document.getElementById('productDiscount').value || 0;
            const finalPrice = document.getElementById('productFinalPrice').value;
            const deliveryCharge = document.getElementById('deliveryCharge').value || 0;
            const rating = document.getElementById('productRating').value;
            const subImages = collectAdditionalImages();
            // Get selected main categories
            const selectedCategories = [];
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox:checked');
            categoryCheckboxes.forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });
            
            // Get selected subcategories
            const selectedSubcategories = [];
            const subcategoryCheckboxes = document.querySelectorAll('.subcategory-checkbox:checked');
            subcategoryCheckboxes.forEach(checkbox => {
                selectedSubcategories.push(checkbox.value);
            });
            
            // Get selected regular sizes and their prices
            const sizeCheckboxes = document.querySelectorAll('.size-checkbox:checked');
            const sizes = [];
            const sizePricing = {};
            
            sizeCheckboxes.forEach(checkbox => {
                const size = checkbox.value;
                const priceInput = document.getElementById(`price${size}`);
                const sizePrice = priceInput.value || finalPrice;
                
                sizes.push(size);
                sizePricing[size] = parseFloat(sizePrice);
            });
            
            // Get weight-based pricing
            const weightPricing = collectWeightPricing();
            
            if (!name || !imageUrl || !description || !originalPrice || !finalPrice || !rating) {
                showNotification('Please fill in all required fields (name, image, description, original price, rating)', 'warning');
                return;
            }
            
            if (selectedCategories.length === 0) {
                showNotification('Please select at least one main category', 'warning');
                return;
            }
            
            if (productsData.length >= 20) {
                showNotification('Maximum 20 products allowed', 'warning');
                return;
            }
            
            if (await addProductToFirebase(name, imageUrl, description, finalPrice, subImages, selectedCategories, sizes, sizePricing, deliveryCharge, rating, originalPrice, discount, weightPricing, selectedSubcategories)) {
                document.getElementById('productName').value = '';
                document.getElementById('productImageUrl').value = '';
                document.getElementById('productDescription').value = '';
                document.getElementById('productOriginalPrice').value = '';
                document.getElementById('productDiscount').value = '0';
                document.getElementById('productFinalPrice').value = '';
                document.getElementById('deliveryCharge').value = '0';
                document.getElementById('productSubImages').value = '';
                document.getElementById('productRating').value = '';
                
                // Clear category and subcategory selections
                document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.subcategory-checkbox').forEach(cb => cb.checked = false);
                
                // Hide subcategories section
                const subcategoriesSection = document.getElementById('productSubcategoriesSection');
                if (subcategoriesSection) {
                    subcategoriesSection.style.display = 'none';
                }
                
                // Clear additional image inputs
                clearAdditionalImages();
                
                // Clear size checkboxes and price inputs
                document.querySelectorAll('.size-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('[id^="price"]').forEach(input => {
                    input.value = '';
                });
                
                // Clear weight pricing inputs
                clearWeightInputs();
                
                showNotification('Product added successfully!', 'success');
                loadProductsAdminData();
            } else {
                showNotification('Error adding product. Please try again.', 'error');
            }
        };

        // Load products admin data with search functionality
        function loadProductsAdminData() {
            const productsAdminList = document.getElementById('productsAdminList');
            if (!productsAdminList) return;
            
            productsAdminList.innerHTML = '';
            
            // Get search term
            const searchInput = document.getElementById('productSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            // Filter products based on search term
            const filteredProducts = productsData.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.category && product.category.toLowerCase().includes(searchTerm))
            );
            
            // Create grid container
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 10px;';
            
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.style.cssText = `
                    position: relative;
                    background: white;
                    border-radius: 15px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    border: 2px solid #e5e7eb;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                `;
                
                const discountText = product.discount && product.discount > 0 ? ` (${product.discount}% off)` : '';
                const originalPriceText = product.originalPrice && product.originalPrice !== product.price ? `<span style="text-decoration: line-through; color: #999; font-size: 11px;">₹${product.originalPrice}</span> ` : '';
                
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" style="width: 100%; height: 120px; object-fit: contain; background: #f8fafc;" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div style="padding: 12px;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px; color: #1a202c; line-height: 1.3; height: 36px; overflow: hidden;">${product.name}</div>
                        <div style="font-size: 13px; color: #059669; font-weight: bold; margin-bottom: 2px;">
                            ${originalPriceText}<span style="color: #059669;">₹${product.price}</span>${discountText}
                        </div>
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Category: ${product.category || 'No category'}</div>
                        ${product.sizes && product.sizes.length > 0 ? `<div style="font-size: 10px; color: #666; margin-bottom: 8px;">Sizes: ${product.sizes.join(', ')}</div>` : '<div style="margin-bottom: 8px;"></div>'}
                        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <button onclick="openUpdateCategoriesModal('${product.id}')" style="flex: 1; background: #f59e0b; color: white; border: none; padding: 6px 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600;">Include Categories</button>
                        </div>
                        <button onclick="removeProduct('${product.id}')" style="width: 100%; background: #dc3545; color: white; border: none; padding: 6px 8px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600;">Remove Product</button>
                    </div>
                `;
                
                // Add hover effect
                productCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
                });
                productCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.borderColor = '#e5e7eb';
                    this.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                });
                
                gridContainer.appendChild(productCard);
            });
            
            productsAdminList.appendChild(gridContainer);
            
            // Show message if no products found
            if (filteredProducts.length === 0 && searchTerm) {
                productsAdminList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No products found matching your search.</p>';
            } else if (filteredProducts.length === 0) {
                productsAdminList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No products available. Add some products first.</p>';
            }
        }

        // Search products function
        window.searchProducts = function() {
            loadProductsAdminData();
        };

        // Update Categories Modal Functions
        let currentUpdateProductId = null;

        window.openUpdateCategoriesModal = function(productId) {
            currentUpdateProductId = productId;
            const product = productsData.find(p => p.id === productId);
            if (!product) return;

            // Show modal
            const modal = document.getElementById('updateCategoriesModal');
            modal.style.display = 'flex';

            // Display product info
            const productInfo = document.getElementById('updateProductInfo');
            productInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${product.imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEwIiBmaWxsPSIjOTk5YWEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPgo='">
                    <div>
                        <div style="font-weight: bold; font-size: 16px; color: #1a202c;">${product.name}</div>
                        <div style="color: #059669; font-weight: 600;">₹${product.price}</div>
                        <div style="color: #666; font-size: 12px;">Current Category: ${product.category || 'No category'}</div>
                    </div>
                </div>
            `;

            // Load categories for selection
            loadCategoriesForUpdate(product);
        };

        function loadCategoriesForUpdate(product) {
            const categoriesContainer = document.getElementById('updateCategoriesContainer');
            const subcategoriesContainer = document.getElementById('updateSubcategoriesContainer');
            
            // Clear containers
            categoriesContainer.innerHTML = '';
            subcategoriesContainer.innerHTML = '';

            // Load main categories
            categoriesData.forEach(category => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                
                const isSelected = Array.isArray(product.categories) ? product.categories.includes(category.name) : product.category === category.name;
                
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="updateCat_${category.name}" value="${category.name}" class="update-category-checkbox" ${isSelected ? 'checked' : ''} onchange="loadSubcategoriesForUpdate()">
                    <label for="updateCat_${category.name}" style="flex: 1; cursor: pointer; font-weight: 500;">${category.name}</label>
                `;
                categoriesContainer.appendChild(checkboxDiv);
            });

            // Load subcategories based on selected categories
            loadSubcategoriesForUpdate();
        }

        function loadSubcategoriesForUpdate() {
            const subcategoriesContainer = document.getElementById('updateSubcategoriesContainer');
            subcategoriesContainer.innerHTML = '';

            // Get selected categories
            const selectedCategories = Array.from(document.querySelectorAll('.update-category-checkbox:checked')).map(cb => cb.value);
            
            if (selectedCategories.length === 0) {
                subcategoriesContainer.innerHTML = '<p style="color: #666; text-align: center; grid-column: 1 / -1;">Please select at least one main category to see subcategories.</p>';
                return;
            }

            // Collect all subcategories from selected categories
            const allSubcategories = [];
            selectedCategories.forEach(categoryName => {
                const category = categoriesData.find(cat => cat.name === categoryName);
                if (category && category.subcategories) {
                    category.subcategories.forEach(sub => {
                        if (!allSubcategories.find(s => s.name === sub.name)) {
                            allSubcategories.push({...sub, parentCategory: categoryName});
                        }
                    });
                }
            });

            if (allSubcategories.length === 0) {
                subcategoriesContainer.innerHTML = '<p style="color: #666; text-align: center; grid-column: 1 / -1;">No subcategories available for selected categories.</p>';
                return;
            }

            // Get current product
            const product = productsData.find(p => p.id === currentUpdateProductId);
            
            allSubcategories.forEach(subcategory => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                
                const isSelected = Array.isArray(product.subcategories) ? product.subcategories.includes(subcategory.name) : false;
                
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="updateSub_${subcategory.name}" value="${subcategory.name}" class="update-subcategory-checkbox" ${isSelected ? 'checked' : ''}>
                    <label for="updateSub_${subcategory.name}" style="flex: 1; cursor: pointer; font-weight: 500;">${subcategory.name}</label>
                    <span style="font-size: 10px; color: #666; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${subcategory.parentCategory}</span>
                `;
                subcategoriesContainer.appendChild(checkboxDiv);
            });
        }

        window.closeUpdateCategoriesModal = function() {
            const modal = document.getElementById('updateCategoriesModal');
            modal.style.display = 'none';
            currentUpdateProductId = null;
        };

        window.updateProductCategories = async function() {
            if (!currentUpdateProductId) return;

            // Get selected categories and subcategories
            const selectedCategories = Array.from(document.querySelectorAll('.update-category-checkbox:checked')).map(cb => cb.value);
            const selectedSubcategories = Array.from(document.querySelectorAll('.update-subcategory-checkbox:checked')).map(cb => cb.value);

            if (selectedCategories.length === 0) {
                showNotification('Please select at least one main category', 'warning');
                return;
            }

            try {
                // Update product in Firebase
                const productRef = doc(db, 'products', currentUpdateProductId);
                await updateDoc(productRef, {
                    categories: selectedCategories,
                    subcategories: selectedSubcategories,
                    category: selectedCategories[0] // Keep first category as primary for backward compatibility
                });

                // Update local data
                const productIndex = productsData.findIndex(p => p.id === currentUpdateProductId);
                if (productIndex !== -1) {
                    productsData[productIndex].categories = selectedCategories;
                    productsData[productIndex].subcategories = selectedSubcategories;
                    productsData[productIndex].category = selectedCategories[0];
                }

                showNotification('Product categories updated successfully!', 'success');
                closeUpdateCategoriesModal();
                loadProductsAdminData(); // Refresh admin products display

            } catch (error) {
                console.error('Error updating product categories:', error);
                showNotification('Error updating categories. Please try again.', 'error');
            }
        };

        window.removeProduct = async function(productId) {
            console.log('Attempting to remove product with ID:', productId);
            const success = await removeProductFromFirebase(productId);
            if (success) {
                loadProductsAdminData();
            } else {
                showNotification('Error removing product. Please try again.', 'error');
            }
        };

        // Carousel functions for product modal
        window.changeCarouselImage = function(productId, direction) {
            const carousel = document.getElementById('imageCarousel-' + productId);
            if (!carousel) return;
            
            const images = carousel.querySelectorAll('.carousel-image');
            const indicators = carousel.parentElement.querySelectorAll('.carousel-indicator');
            
            let currentIndex = 0;
            images.forEach((img, index) => {
                if (img.style.opacity === '1') {
                    currentIndex = index;
                }
            });
            
            let newIndex = currentIndex + direction;
            if (newIndex >= images.length) newIndex = 0;
            if (newIndex < 0) newIndex = images.length - 1;
            
            // Update images
            images.forEach((img, index) => {
                img.style.opacity = index === newIndex ? '1' : '0';
            });
            
            // Update indicators
            indicators.forEach((indicator, index) => {
                indicator.style.background = index === newIndex ? 'white' : 'rgba(255,255,255,0.5)';
            });
        };
        
        window.goToCarouselImage = function(productId, targetIndex) {
            const carousel = document.getElementById('imageCarousel-' + productId);
            if (!carousel) return;
            
            const images = carousel.querySelectorAll('.carousel-image');
            const indicators = carousel.parentElement.querySelectorAll('.carousel-indicator');
            
            // Update images
            images.forEach((img, index) => {
                img.style.opacity = index === targetIndex ? '1' : '0';
            });
            
            // Update indicators
            indicators.forEach((indicator, index) => {
                indicator.style.background = index === targetIndex ? 'white' : 'rgba(255,255,255,0.5)';
            });
        };

        // Product detail modal functions
        window.openProductModal = function(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            // Add to modal stack
            modalStack.push('product');
            
            // Add to browser history so back button works
            history.pushState({modal: 'product', productId: productId}, '', `#product-${productId}`);
            
            const modal = document.getElementById('productModal');
            const modalBody = document.getElementById('productModalBody');
            
            // Scroll modal to top when product changes
            if (modal) {
                modal.scrollTop = 0;
            }
            
            // Prepare all images (main + sub images)
            const allImages = [product.imageUrl];
            if (product.subImages && product.subImages.length > 0) {
                allImages.push(...product.subImages);
            }
            
            // Create carousel HTML
            let carouselHTML = '';
            if (allImages.length > 1) {
                // Multiple images - show carousel
                let imagesHTML = '';
                let indicatorsHTML = '';
                
                allImages.forEach((imgUrl, index) => {
                    imagesHTML += `<img src="${imgUrl}" alt="${product.name}" class="carousel-image" data-index="${index}" style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; transition: opacity 0.3s ease; ${index === 0 ? 'opacity: 1;' : 'opacity: 0;'}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">`;
                    indicatorsHTML += `<div onclick="goToCarouselImage('${product.id}', ${index})" class="carousel-indicator" data-index="${index}" style="width: 8px; height: 8px; border-radius: 50%; background: ${index === 0 ? 'white' : 'rgba(255,255,255,0.5)'}; cursor: pointer; transition: background 0.3s ease;"></div>`;
                });
                
                carouselHTML = `
                    <div style="position: relative; margin-bottom: 20px;">
                        <div id="imageCarousel-${product.id}" style="width: 100%; height: 400px; overflow: hidden; border-radius: 8px; background: #f8f9fa; position: relative;">
                            ${imagesHTML}
                        </div>
                        <button onclick="changeCarouselImage('${product.id}', -1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;">‹</button>
                        <button onclick="changeCarouselImage('${product.id}', 1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;">›</button>
                        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 10;">
                            ${indicatorsHTML}
                        </div>
                    </div>
                `;
            } else {
                // Single image - show normally
                carouselHTML = `<img src="${product.imageUrl}" alt="${product.name}" class="product-modal-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">`;
            }
            
            modalBody.innerHTML = `
                ${carouselHTML}
                <h3 class="product-modal-name">${product.name}</h3>
                <div class="product-rating" style="color: #fbbf24; font-size: 16px; margin: 8px 0;">
                    ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating}/5)` : 'No rating'}
                </div>
                <div class="product-modal-price-container" id="price-${product.id}">
                    ${product.originalPrice && product.originalPrice > product.price && product.discount > 0 ? `
                        <div class="special-price-label" style="color: #27ae60; font-size: 14px; font-weight: 600; margin-bottom: 5px;">Special price</div>
                        <div class="price-row" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <span class="current-price" style="color: #27ae60; font-size: 24px; font-weight: 700;">₹${product.price}</span>
                            <span class="original-price" style="color: #999; font-size: 18px; text-decoration: line-through;">₹${product.originalPrice}</span>
                            <span class="discount-badge" style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${product.discount}% off</span>
                        </div>
                    ` : `
                        <div class="product-modal-price" style="color: #27ae60; font-size: 24px; font-weight: 700;">₹${product.price}</div>
                    `}
                </div>
                <p class="product-modal-description">${product.description}</p>
                ${product.category ? `<p><strong>Category:</strong> ${product.category}</p>` : ''}
                ${product.deliveryCharge ? `<p style="color: #27ae60; font-weight: 600;">Delivery Charge: ₹${product.deliveryCharge}</p>` : ''}
                
                ${(product.sizes && product.sizes.length > 0) || (product.weightPricing && (product.weightPricing.ml.length > 0 || product.weightPricing.g.length > 0 || product.weightPricing.kg.length > 0)) ? `
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #2c3e50;">Size/Quantity:</label>
                    <div id="size-buttons-${product.id}" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                        ${product.sizes ? product.sizes.map(size => `
                            <button class="size-btn" data-size="${size}" onclick="selectSize('${product.id}', '${size}')" 
                                style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; min-width: 50px;">
                                ${size}
                            </button>
                        `).join('') : ''}
                        ${product.weightPricing ? [
                            ...product.weightPricing.ml.map(item => `
                                <button class="size-btn" data-size="ml-${item.quantity}" onclick="selectSize('${product.id}', 'ml-${item.quantity}')" 
                                    style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;">
                                    ${item.quantity} ml
                                </button>
                            `),
                            ...product.weightPricing.g.map(item => `
                                <button class="size-btn" data-size="g-${item.quantity}" onclick="selectSize('${product.id}', 'g-${item.quantity}')" 
                                    style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;">
                                    ${item.quantity} g
                                </button>
                            `),
                            ...product.weightPricing.kg.map(item => `
                                <button class="size-btn" data-size="kg-${item.quantity}" onclick="selectSize('${product.id}', 'kg-${item.quantity}')" 
                                    style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;">
                                    ${item.quantity} kg
                                </button>
                            `)
                        ].join('') : ''}
                    </div>
                    <input type="hidden" id="selected-size-${product.id}" value="">
                </div>
                ` : ''}
                
                <div class="product-modal-quantity">
                    <span class="quantity-label">Quantity:</span>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity('${product.id}', -1)">-</button>
                        <input type="number" id="quantity-${product.id}" class="quantity-input" value="1" min="1" max="10" onchange="updateTotalPrice('${product.id}')">
                        <button class="quantity-btn" onclick="changeQuantity('${product.id}', 1)">+</button>
                    </div>
                </div>
                
                <!-- Total Amount Display -->
                <div id="total-amount-${product.id}" style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Total Amount:</div>
                    <div id="total-price-display-${product.id}">
                        ${product.originalPrice && product.originalPrice > product.price && product.discount > 0 ? `
                            <div style="font-size: 12px; color: #27ae60; font-weight: 600; margin-bottom: 4px;">Special Price</div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span style="color: #27ae60; font-size: 20px; font-weight: 700;" id="total-price-${product.id}">₹${product.price}</span>
                                <span style="color: #999; font-size: 16px; text-decoration: line-through;" id="total-original-${product.id}">₹${product.originalPrice}</span>
                                <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;" id="total-discount-${product.id}">${product.discount}% off</span>
                            </div>
                        ` : `
                            <div style="font-size: 20px; font-weight: 700; color: #27ae60;" id="total-price-${product.id}">₹${product.price}</div>
                        `}
                    </div>
                </div>
                
                <div class="product-modal-buttons">
                    <button class="btn-cart" id="cartBtn-${product.id}" onclick="addToCartWithQuantity('${product.id}')">Add to Cart</button>
                    <button class="btn-order" onclick="openConfirmOrderModal('${product.id}')" style="background: #fbbf24; color: #000; font-weight: 600;">Order Now</button>
                </div>
                
                <div class="related-products-section">
                    <h4 class="related-products-title">Related Products</h4>
                    <div class="related-products-scroll" id="relatedProducts-${product.id}">
                        <!-- Related products will be populated here -->
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Initialize total price display
            initializeTotalPrice(product.id);
            
            // Load related products
            loadRelatedProducts(product.id, product.category);
            
            // Update button state based on cart
            updateProductModalButtons(product.id);
        };

        // Open product modal from cart (without Add to Cart button)
        window.openProductModalFromCart = function(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            // Add to modal stack
            modalStack.push('product');
            
            // Find the cart item to get its quantity, size, and pricing info
            const cartItem = cartItems.find(item => item.id === productId);
            const quantity = cartItem ? cartItem.quantity : 1;
            const size = cartItem ? cartItem.size : '';
            const originalPrice = cartItem ? (cartItem.originalPrice || cartItem.price) : product.price;
            const currentPrice = cartItem ? cartItem.price : product.price;
            const discount = cartItem ? (cartItem.discount || 0) : (product.discount || 0);
            
            const modal = document.getElementById('productModal');
            const modalBody = document.getElementById('productModalBody');
            
            // Scroll modal to top when product changes
            if (modal) {
                modal.scrollTop = 0;
            }
            
            let deliveryCharge = product.deliveryCharge || 0;
            
            // Calculate totals with discount applied
            const subtotal = currentPrice * quantity;
            const originalSubtotal = originalPrice * quantity;
            const totalAmount = subtotal + deliveryCharge;
            const savings = originalSubtotal - subtotal;
            
            // Prepare all images (main + sub images)
            const allImages = [product.imageUrl];
            if (product.subImages && product.subImages.length > 0) {
                allImages.push(...product.subImages);
            }
            
            // Create carousel HTML
            let carouselHTML = '';
            if (allImages.length > 1) {
                let imagesHTML = '';
                let indicatorsHTML = '';
                
                allImages.forEach((imgUrl, index) => {
                    imagesHTML += `<img src="${imgUrl}" alt="${product.name}" class="carousel-image" data-index="${index}" style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; transition: opacity 0.3s ease; ${index === 0 ? 'opacity: 1;' : 'opacity: 0;'}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">`;
                    indicatorsHTML += `<div onclick="goToCarouselImage('${product.id}', ${index})" class="carousel-indicator" data-index="${index}" style="width: 8px; height: 8px; border-radius: 50%; background: ${index === 0 ? 'white' : 'rgba(255,255,255,0.5)'}; cursor: pointer; transition: background 0.3s ease;"></div>`;
                });
                
                carouselHTML = `
                    <div style="position: relative; margin-bottom: 20px;">
                        <div id="imageCarousel-${product.id}" style="width: 100%; height: 400px; overflow: hidden; border-radius: 8px; background: #f8f9fa; position: relative;">
                            ${imagesHTML}
                        </div>
                        <button onclick="changeCarouselImage('${product.id}', -1)" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;">‹</button>
                        <button onclick="changeCarouselImage('${product.id}', 1)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10;">›</button>
                        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 10;">
                            ${indicatorsHTML}
                        </div>
                    </div>
                `;
            } else {
                carouselHTML = `<img src="${product.imageUrl}" alt="${product.name}" class="product-modal-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">`;
            }
            
            modalBody.innerHTML = `
                ${carouselHTML}
                <h3 class="product-modal-name">${product.name}</h3>
                <div class="product-rating" style="color: #fbbf24; font-size: 16px; margin: 8px 0;">
                    ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating}/5)` : 'No rating'}
                </div>
                <p class="product-modal-description">${product.description}</p>
                ${product.category ? `<p><strong>Category:</strong> ${product.category}</p>` : ''}
                
                <!-- Cart Item Details -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #27ae60;">
                    <h4 style="color: #2c3e50; margin-bottom: 12px; font-size: 16px;">Cart Item Details</h4>
                    ${size ? `<p style="margin: 5px 0;"><strong>Selected Size:</strong> ${size}</p>` : ''}
                    <p style="margin: 5px 0;"><strong>Quantity:</strong> ${quantity}</p>
                    
                    <!-- Pricing Information -->
                    ${originalPrice > currentPrice && discount > 0 ? `
                        <div style="margin: 10px 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="font-size: 14px; color: #27ae60; font-weight: 600; margin-bottom: 8px;">🎉 Special Price Applied!</div>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 8px;">
                                <span style="color: #27ae60; font-size: 18px; font-weight: 700;">₹${currentPrice}</span>
                                <span style="color: #999; font-size: 16px; text-decoration: line-through;">₹${originalPrice}</span>
                                <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${discount}% off</span>
                            </div>
                            <div style="color: #666; font-size: 13px;">Unit price after discount</div>
                        </div>
                        
                        <!-- Calculation Breakdown -->
                        <div style="margin: 10px 0; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>Subtotal (${quantity} × ₹${currentPrice}):</span>
                                <span style="font-weight: 600;">₹${subtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0; color: #999; font-size: 12px;">
                                <span>Original subtotal (${quantity} × ₹${originalPrice}):</span>
                                <span style="text-decoration: line-through;">₹${originalSubtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0; color: #27ae60; font-weight: 600; border-top: 1px solid #e0e0e0; padding-top: 8px;">
                                <span>💰 You Save:</span>
                                <span>₹${savings.toFixed(2)}</span>
                            </div>
                        </div>
                    ` : `
                        <div style="margin: 10px 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>Unit Price:</span>
                                <span style="font-weight: 600; color: #27ae60;">₹${currentPrice}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>Subtotal (${quantity} items):</span>
                                <span style="font-weight: 600;">₹${subtotal.toFixed(2)}</span>
                            </div>
                        </div>
                    `}
                    
                    ${deliveryCharge > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px 0; border-top: 1px solid #e0e0e0;">
                            <span style="color: #27ae60; font-weight: 600;">🚚 Delivery Charge:</span>
                            <span style="color: #27ae60; font-weight: 600;">₹${deliveryCharge}</span>
                        </div>
                    ` : `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px 0; border-top: 1px solid #e0e0e0;">
                            <span style="color: #27ae60; font-weight: 600;">🎁 Delivery:</span>
                            <span style="color: #27ae60; font-weight: 600;">FREE</span>
                        </div>
                    `}
                    
                    <div style="display: flex; justify-content: space-between; margin: 12px 0; padding: 12px 0; border-top: 2px solid #27ae60; font-size: 18px; font-weight: 700; color: #27ae60;">
                        <span>Total Amount:</span>
                        <span>₹${totalAmount.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="product-modal-buttons">
                    <button class="btn-order" onclick="openConfirmOrderModalFromCart('${product.id}')">Order Now</button>
                </div>
                
                <div class="related-products-section">
                    <h4 class="related-products-title">Related Products</h4>
                    <div class="related-products-scroll" id="relatedProducts-${product.id}">
                        <!-- Related products will be populated here -->
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load related products
            loadRelatedProducts(product.id, product.category);
        };

        window.closeProductModal = function() {
            // Remove from modal stack if present
            const productIndex = modalStack.lastIndexOf('product');
            if (productIndex !== -1) {
                modalStack.splice(productIndex, 1);
            }
            
            document.getElementById('productModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        };

        // Load related products for product modal
        window.loadRelatedProducts = function(currentProductId, currentCategory) {
            const relatedContainer = document.getElementById(`relatedProducts-${currentProductId}`);
            if (!relatedContainer) return;

            // Get products from same category (excluding current product)
            let relatedProducts = productsData.filter(product => 
                product.id !== currentProductId && 
                product.category === currentCategory
            );

            // If not enough products from same category, add random products
            if (relatedProducts.length < 8) {
                const otherProducts = productsData.filter(product => 
                    product.id !== currentProductId && 
                    product.category !== currentCategory
                );
                const shuffled = otherProducts.sort(() => 0.5 - Math.random());
                relatedProducts = [...relatedProducts, ...shuffled].slice(0, 8);
            } else {
                relatedProducts = relatedProducts.slice(0, 8);
            }

            // Generate HTML for related products
            const relatedHTML = relatedProducts.map(product => `
                <div class="related-product-card" onclick="openProductModal('${product.id}')">
                    <img src="${product.imageUrl}" alt="${product.name}" class="related-product-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">
                    <div class="related-product-name">${product.name}</div>
                    <div class="product-rating" style="color: #fbbf24; font-size: 16px; margin: 6px 0;">
                        ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                    </div>
                    ${(product.originalPrice && product.originalPrice > product.price && product.discount > 0) ? `
                        <div class="product-price-container" style="margin-top: 8px;">
                            <div style="font-size: 10px; color: #27ae60; font-weight: 600; margin-bottom: 2px;">Special price</div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                <span style="color: #27ae60; font-weight: 700; font-size: 18px;">₹${product.price}</span>
                                <span style="color: #999; font-size: 14px; text-decoration: line-through;">₹${product.originalPrice}</span>
                                <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600;">${product.discount}% off</span>
                            </div>
                        </div>
                    ` : `
                        <div class="related-product-price" style="color: #27ae60; font-size: 18px; font-weight: 700; margin-top: 8px;">₹${product.price}</div>
                    `}
                </div>
            `).join('');

            relatedContainer.innerHTML = relatedHTML;
        };

        // Load related products for cart sidebar
        window.loadCartRelatedProducts = function() {
            const relatedContainer = document.getElementById('cartRelatedProducts');
            if (!relatedContainer) return;

            // Get categories from current cart items
            const cartCategories = [...new Set(cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                return product ? product.category : null;
            }).filter(Boolean))];

            // Get cart product IDs to exclude
            const cartProductIds = cartItems.map(item => item.id);

            // Get related products from cart categories
            let relatedProducts = productsData.filter(product => 
                !cartProductIds.includes(product.id) && 
                cartCategories.includes(product.category)
            );

            // If not enough, add random products
            if (relatedProducts.length < 8) {
                const otherProducts = productsData.filter(product => 
                    !cartProductIds.includes(product.id) && 
                    !cartCategories.includes(product.category)
                );
                const shuffled = otherProducts.sort(() => 0.5 - Math.random());
                relatedProducts = [...relatedProducts, ...shuffled].slice(0, 8);
            } else {
                relatedProducts = relatedProducts.slice(0, 8);
            }

            // Generate HTML for related products
            const relatedHTML = relatedProducts.map(product => `
                <div class="related-product-card" onclick="openProductModal('${product.id}')">
                    <img src="${product.imageUrl}" alt="${product.name}" class="related-product-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">
                    <div class="related-product-name">${product.name}</div>
                    <div class="product-rating" style="color: #fbbf24; font-size: 16px; margin: 6px 0;">
                        ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                    </div>
                    ${(product.originalPrice && product.originalPrice > product.price && product.discount > 0) ? `
                        <div class="product-price-container" style="margin-top: 8px;">
                            <div style="font-size: 10px; color: #27ae60; font-weight: 600; margin-bottom: 2px;">Special price</div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                <span style="color: #27ae60; font-weight: 700; font-size: 18px;">₹${product.price}</span>
                                <span style="color: #999; font-size: 14px; text-decoration: line-through;">₹${product.originalPrice}</span>
                                <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600;">${product.discount}% off</span>
                            </div>
                        </div>
                    ` : `
                        <div class="related-product-price" style="color: #27ae60; font-size: 18px; font-weight: 700; margin-top: 8px;">₹${product.price}</div>
                    `}
                </div>
            `).join('');

            relatedContainer.innerHTML = relatedHTML;
        };

        // Load related products for cart confirmation modal
        window.loadCartModalRelatedProducts = function() {
            const relatedContainer = document.getElementById('cartModalRelatedProducts');
            if (!relatedContainer) return;

            // Get categories from current cart items
            const cartCategories = [...new Set(cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                return product ? product.category : null;
            }).filter(Boolean))];

            // Get cart product IDs to exclude
            const cartProductIds = cartItems.map(item => item.id);

            // Get related products from cart categories
            let relatedProducts = productsData.filter(product => 
                !cartProductIds.includes(product.id) && 
                cartCategories.includes(product.category)
            );

            // If not enough, add random products
            if (relatedProducts.length < 8) {
                const otherProducts = productsData.filter(product => 
                    !cartProductIds.includes(product.id) && 
                    !cartCategories.includes(product.category)
                );
                const shuffled = otherProducts.sort(() => 0.5 - Math.random());
                relatedProducts = [...relatedProducts, ...shuffled].slice(0, 8);
            } else {
                relatedProducts = relatedProducts.slice(0, 8);
            }

            // Generate HTML for related products
            const relatedHTML = relatedProducts.map(product => `
                <div class="related-product-card" onclick="openProductModal('${product.id}')">
                    <img src="${product.imageUrl}" alt="${product.name}" class="related-product-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik03NSA3NUgxMjVWMTI1SDc1Vjc1WiIgZmlsbD0iI0RERERERCIvPgo8L3N2Zz4K'">
                    <div class="related-product-name">${product.name}</div>
                    <div class="product-rating" style="color: #fbbf24; font-size: 16px; margin: 6px 0;">
                        ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                    </div>
                    ${(product.originalPrice && product.originalPrice > product.price && product.discount > 0) ? `
                        <div class="product-price-container" style="margin-top: 8px;">
                            <div style="font-size: 10px; color: #27ae60; font-weight: 600; margin-bottom: 2px;">Special price</div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                <span style="color: #27ae60; font-weight: 700; font-size: 18px;">₹${product.price}</span>
                                <span style="color: #999; font-size: 14px; text-decoration: line-through;">₹${product.originalPrice}</span>
                                <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600;">${product.discount}% off</span>
                            </div>
                        </div>
                    ` : `
                        <div class="related-product-price" style="color: #27ae60; font-size: 18px; font-weight: 700; margin-top: 8px;">₹${product.price}</div>
                    `}
                </div>
            `).join('');

            relatedContainer.innerHTML = relatedHTML;
        };

        // Open confirm order modal
        window.openConfirmOrderModal = async function(productId) {
            // Add to modal stack for proper back navigation
            modalStack.push('confirmOrder');
            
            // Add to browser history
            history.pushState({modal: 'confirmOrder', productId: productId}, '', `#confirm-order-${productId}`);
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const quantityInput = document.getElementById(`quantity-${productId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Get selected size if available
            let selectedSize = '';
            const selectedSizeInput = document.getElementById(`selected-size-${productId}`);
            if (selectedSizeInput && ((product.sizes && product.sizes.length > 0) || (product.weightPricing && (product.weightPricing.ml.length > 0 || product.weightPricing.g.length > 0 || product.weightPricing.kg.length > 0)))) {
                selectedSize = selectedSizeInput.value;
                if (!selectedSize) {
                    showNotification('Please select a size/quantity before placing order.', 'warning');
                    return;
                }
            }
            
            // Calculate the correct price with discount
            let currentPrice = product.price;
            let originalPrice = product.originalPrice || product.price;
            
            // Apply size-specific pricing if available
            if (selectedSize && product.sizePricing && product.sizePricing[selectedSize]) {
                currentPrice = product.sizePricing[selectedSize];
                originalPrice = currentPrice; // Use size price as base
            }
            
            // Apply discount if available
            if (product.discount && product.discount > 0) {
                currentPrice = originalPrice - (originalPrice * product.discount / 100);
            }
            
            const deliveryCharge = product.deliveryCharge || 0;
            const subtotal = currentPrice * quantity;
            const totalAmount = subtotal + deliveryCharge;
            
            // Load user address data
            await loadUserAddressFromFirebase();
            
            const modal = document.getElementById('confirmOrderModal');
            const modalBody = document.getElementById('confirmOrderModalBody');
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Order Summary</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <img src="${product.imageUrl}" alt="${product.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50;">${product.name}</div>
                            ${selectedSize ? `<div style="color: #666; font-size: 12px;">Size: ${selectedSize}</div>` : ''}
                            <div style="color: #27ae60; font-weight: 600;">₹${currentPrice} x ${quantity} = ₹${subtotal}</div>
                            ${deliveryCharge > 0 ? `<div style="color: #666; font-size: 12px;">Delivery: ₹${deliveryCharge}</div>` : ''}
                            <div style="font-weight: 700; color: #e74c3c; font-size: 16px;">Total: ₹${totalAmount}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Delivery Address</h4>
                    
                    ${userAddressData && userAddressData.address ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                <input type="radio" name="addressOption" value="saved" checked onchange="toggleAddressForm()" style="margin-right: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #2c3e50;">Use Saved Address</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 3px; word-break: break-word;">
                                        📱 ${userAddressData.phone}<br>
                                        📍 ${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}
                                        ${userAddressData.nearby ? `<br>Near: ${userAddressData.nearby}` : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="addressOption" value="custom" ${!userAddressData || !userAddressData.address ? 'checked' : ''} onchange="toggleAddressForm()" style="margin-right: 10px;">
                            <div style="font-weight: 600; color: #2c3e50;">Use Different Address</div>
                        </label>
                    </div>
                    
                    <div id="customAddressForm" style="display: ${!userAddressData || !userAddressData.address ? 'block' : 'none'}; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Phone Number *</label>
                            <input type="tel" id="customPhone" placeholder="Enter your phone number" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.phone || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Full Address *</label>
                            <textarea id="customAddress" placeholder="Enter complete address with house/flat number, street, area" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 70px; resize: vertical; box-sizing: border-box; transition: border-color 0.3s;" rows="3" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">${userAddressData?.address || ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">State *</label>
                                <select id="customState" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'" onchange="loadCitiesForState()">
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                    <option value="Ladakh">Ladakh</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">City *</label>
                                <select id="customCity" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                                    <option value="">Select City</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Pincode *</label>
                                <input type="text" id="customPincode" placeholder="Enter pincode" maxlength="6" pattern="[0-9]{6}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.pincode || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Nearby Landmark</label>
                                <input type="text" id="customNearby" placeholder="Optional landmark" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.nearby || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="product-modal-buttons">
                    <button class="btn-order" onclick="confirmOrderWithAddress('${productId}', ${quantity}, '${selectedSize}', ${currentPrice}, ${deliveryCharge}, ${totalAmount})" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                        Confirm Order - ₹${totalAmount}
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        };

        // Close confirm order modal
        window.closeConfirmOrderModal = function() {
            // Remove from modal stack if present
            const confirmOrderIndex = modalStack.lastIndexOf('confirmOrder');
            if (confirmOrderIndex !== -1) {
                modalStack.splice(confirmOrderIndex, 1);
            }
            
            document.getElementById('confirmOrderModal').style.display = 'none';
        };

        // Toggle address form visibility
        window.toggleAddressForm = function() {
            const customOption = document.querySelector('input[name="addressOption"][value="custom"]');
            const customForm = document.getElementById('customAddressForm');
            
            if (customOption.checked) {
                customForm.style.display = 'block';
            } else {
                customForm.style.display = 'none';
            }
        };

        // Load cities based on selected state
        window.loadCitiesForState = function() {
            const stateSelect = document.getElementById('customState');
            const citySelect = document.getElementById('customCity');
            const selectedState = stateSelect.value;
            
            // Clear existing cities
            citySelect.innerHTML = '<option value="">Select City</option>';
            
            if (!selectedState) return;
            
            // Indian states and their major cities
            const stateCities = {
                'Andhra Pradesh': ['Visakhapatnam', 'Vijayawada', 'Guntur', 'Nellore', 'Kurnool', 'Rajahmundry', 'Tirupati', 'Kadapa', 'Anantapur', 'Eluru'],
                'Arunachal Pradesh': ['Itanagar', 'Naharlagun', 'Pasighat', 'Tezpur', 'Bomdila', 'Ziro', 'Along', 'Changlang', 'Tezu', 'Namsai'],
                'Assam': ['Guwahati', 'Silchar', 'Dibrugarh', 'Jorhat', 'Nagaon', 'Tinsukia', 'Tezpur', 'Bongaigaon', 'Karimganj', 'Sivasagar'],
                'Bihar': ['Patna', 'Gaya', 'Bhagalpur', 'Muzaffarpur', 'Purnia', 'Darbhanga', 'Bihar Sharif', 'Arrah', 'Begusarai', 'Katihar'],
                'Chhattisgarh': ['Raipur', 'Bhilai', 'Korba', 'Bilaspur', 'Durg', 'Rajnandgaon', 'Jagdalpur', 'Raigarh', 'Ambikapur', 'Mahasamund'],
                'Goa': ['Panaji', 'Vasco da Gama', 'Margao', 'Mapusa', 'Ponda', 'Bicholim', 'Curchorem', 'Sanquelim', 'Cuncolim', 'Quepem'],
                'Gujarat': ['Ahmedabad', 'Surat', 'Vadodara', 'Rajkot', 'Bhavnagar', 'Jamnagar', 'Junagadh', 'Gandhinagar', 'Anand', 'Navsari'],
                'Haryana': ['Gurugram', 'Faridabad', 'Panipat', 'Ambala', 'Yamunanagar', 'Rohtak', 'Hisar', 'Karnal', 'Sonipat', 'Panchkula'],
                'Himachal Pradesh': ['Shimla', 'Dharamshala', 'Solan', 'Mandi', 'Palampur', 'Baddi', 'Nahan', 'Paonta Sahib', 'Sundernagar', 'Chamba'],
                'Jharkhand': ['Ranchi', 'Jamshedpur', 'Dhanbad', 'Bokaro', 'Deoghar', 'Phusro', 'Hazaribagh', 'Giridih', 'Ramgarh', 'Medininagar'],
                'Karnataka': ['Bangalore', 'Mysore', 'Hubli', 'Mangalore', 'Belgaum', 'Gulbarga', 'Davanagere', 'Bellary', 'Bijapur', 'Shimoga'],
                'Kerala': ['Thiruvananthapuram', 'Kochi', 'Kozhikode', 'Thrissur', 'Kollam', 'Palakkad', 'Alappuzha', 'Malappuram', 'Kannur', 'Kasaragod'],
                'Madhya Pradesh': ['Bhopal', 'Indore', 'Gwalior', 'Jabalpur', 'Ujjain', 'Sagar', 'Dewas', 'Satna', 'Ratlam', 'Rewa'],
                'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Thane', 'Nashik', 'Aurangabad', 'Solapur', 'Amravati', 'Kolhapur', 'Sangli'],
                'Manipur': ['Imphal', 'Thoubal', 'Bishnupur', 'Churachandpur', 'Kakching', 'Ukhrul', 'Senapati', 'Tamenglong', 'Jiribam', 'Chandel'],
                'Meghalaya': ['Shillong', 'Tura', 'Jowai', 'Nongpoh', 'Baghmara', 'Williamnagar', 'Nongstoin', 'Mawkyrwat', 'Resubelpara', 'Ampati'],
                'Mizoram': ['Aizawl', 'Lunglei', 'Saiha', 'Champhai', 'Kolasib', 'Serchhip', 'Mamit', 'Lawngtlai', 'Saitual', 'Khawzawl'],
                'Nagaland': ['Kohima', 'Dimapur', 'Mokokchung', 'Tuensang', 'Wokha', 'Zunheboto', 'Phek', 'Kiphire', 'Longleng', 'Peren'],
                'Odisha': ['Bhubaneswar', 'Cuttack', 'Rourkela', 'Berhampur', 'Sambalpur', 'Puri', 'Balasore', 'Bhadrak', 'Baripada', 'Jharsuguda'],
                'Punjab': ['Ludhiana', 'Amritsar', 'Jalandhar', 'Patiala', 'Bathinda', 'Mohali', 'Firozpur', 'Batala', 'Pathankot', 'Moga'],
                'Rajasthan': ['Jaipur', 'Jodhpur', 'Udaipur', 'Kota', 'Bikaner', 'Ajmer', 'Bhilwara', 'Alwar', 'Sikar', 'Pali'],
                'Sikkim': ['Gangtok', 'Namchi', 'Geyzing', 'Mangan', 'Jorethang', 'Nayabazar', 'Rangpo', 'Singtam', 'Pakyong', 'Ravangla'],
                'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli', 'Tiruppur', 'Vellore', 'Erode', 'Thoothukkudi'],
                'Telangana': ['Hyderabad', 'Warangal', 'Nizamabad', 'Khammam', 'Karimnagar', 'Ramagundam', 'Mahbubnagar', 'Nalgonda', 'Adilabad', 'Suryapet'],
                'Tripura': ['Agartala', 'Dharmanagar', 'Udaipur', 'Kailasahar', 'Belonia', 'Khowai', 'Pratapgarh', 'Ranir Bazar', 'Sonamura', 'Kamalpur'],
                'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Ghaziabad', 'Agra', 'Varanasi', 'Meerut', 'Allahabad', 'Bareilly', 'Aligarh', 'Moradabad', 'Saharanpur', 'Gorakhpur', 'Noida', 'Firozabad', 'Loni', 'Jhansi', 'Muzaffarnagar', 'Mathura', 'Shahjahanpur', 'Rampur', 'Maunath Bhanjan'],
                'Uttarakhand': ['Dehradun', 'Haridwar', 'Roorkee', 'Haldwani', 'Rudrapur', 'Kashipur', 'Rishikesh', 'Kotdwar', 'Pithoragarh', 'Almora'],
                'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Malda', 'Bardhaman', 'Barasat', 'Kharagpur', 'Haldia'],
                'Delhi': ['New Delhi', 'Central Delhi', 'North Delhi', 'South Delhi', 'East Delhi', 'West Delhi', 'North East Delhi', 'North West Delhi', 'South East Delhi', 'South West Delhi'],
                'Jammu and Kashmir': ['Srinagar', 'Jammu', 'Baramulla', 'Anantnag', 'Sopore', 'Kathua', 'Udhampur', 'Punch', 'Rajouri', 'Kupwara'],
                'Ladakh': ['Leh', 'Kargil', 'Nubra', 'Changthang', 'Zanskar', 'Drass', 'Sankoo', 'Turtuk', 'Diskit', 'Panamik']
            };
            
            const cities = stateCities[selectedState] || [];
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        };

        // Open confirm order modal for all cart items
        window.openConfirmOrderModalForAllCartItems = async function() {
            if (cartItems.length === 0) {
                showNotification('Your cart is empty! 🛒', 'warning');
                return;
            }

            if (!auth.currentUser) {
                showNotification('Please login or register first to continue.', 'warning');
                setTimeout(async () => {
                    await setActiveTab('profile');
                }, 1000);
                return;
            }

            // Calculate total for all cart items
            const total = cartItems.reduce((sum, item) => {
                const product = productsData.find(p => p.id === item.id);
                const deliveryCharge = product ? (product.deliveryCharge || 0) : 0;
                return sum + (item.price * item.quantity) + deliveryCharge;
            }, 0);

            await loadUserAddressFromFirebase();
            
            const modal = document.getElementById('confirmOrderModal');
            const modalBody = document.getElementById('confirmOrderModalBody');
            
            // Generate order summary for all cart items
            const orderSummaryHTML = cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                const deliveryCharge = product ? (product.deliveryCharge || 0) : 0;
                const itemTotal = (item.price * item.quantity) + deliveryCharge;
                
                return `
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <img src="${item.imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2c3e50; font-size: 14px;">${item.name}</div>
                            ${item.size ? `<div style="color: #666; font-size: 11px;">Size: ${item.size}</div>` : ''}
                            <div style="color: #27ae60; font-weight: 600; font-size: 12px;">₹${item.price} x ${item.quantity} = ₹${item.price * item.quantity}</div>
                            ${deliveryCharge > 0 ? `<div style="color: #666; font-size: 11px;">Delivery: ₹${deliveryCharge}</div>` : ''}
                        </div>
                        <div style="font-weight: 700; color: #e74c3c; font-size: 14px;">₹${itemTotal}</div>
                    </div>
                `;
            }).join('');
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Order Summary (${cartItems.length} items)</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${orderSummaryHTML}
                    </div>
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                        <div style="font-weight: 700; color: #e74c3c; font-size: 18px; text-align: right;">
                            Grand Total: ₹${total}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Delivery Address</h4>
                    
                    ${userAddressData && userAddressData.address ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                <input type="radio" name="addressOption" value="saved" checked onchange="toggleAddressForm()" style="margin-right: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #2c3e50;">Use Saved Address</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 3px; word-break: break-word;">
                                        📱 ${userAddressData.phone}<br>
                                        📍 ${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}
                                        ${userAddressData.nearby ? `<br>Near: ${userAddressData.nearby}` : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="addressOption" value="custom" ${!userAddressData || !userAddressData.address ? 'checked' : ''} onchange="toggleAddressForm()" style="margin-right: 10px;">
                            <div style="font-weight: 600; color: #2c3e50;">Use Different Address</div>
                        </label>
                    </div>
                    
                    <div id="customAddressForm" style="display: ${!userAddressData || !userAddressData.address ? 'block' : 'none'}; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Phone Number *</label>
                            <input type="tel" id="customPhone" placeholder="Enter your phone number" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.phone || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Full Address *</label>
                            <textarea id="customAddress" placeholder="Enter complete address with house/flat number, street, area" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 70px; resize: vertical; box-sizing: border-box; transition: border-color 0.3s;" rows="3" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">${userAddressData?.address || ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">State *</label>
                                <select id="customState" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'" onchange="loadCitiesForState()">
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                    <option value="Ladakh">Ladakh</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">City *</label>
                                <select id="customCity" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                                    <option value="">Select City</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Pincode *</label>
                                <input type="text" id="customPincode" placeholder="Enter pincode" maxlength="6" pattern="[0-9]{6}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.pincode || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Nearby Landmark</label>
                                <input type="text" id="customNearby" placeholder="Optional landmark" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.nearby || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="product-modal-buttons">
                    <button class="btn-order" onclick="confirmOrderForAllCartItems(${total})" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                        Confirm All Orders - ₹${total}
                    </button>
                </div>
                
                <div class="related-products-section">
                    <h4 class="related-products-title">You might also like</h4>
                    <div class="related-products-scroll" id="cartModalRelatedProducts">
                        <!-- Related products will be populated here -->
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Load related products for cart modal
            loadCartModalRelatedProducts();
        };

        // Confirm order for all cart items with selected address
        window.confirmOrderForAllCartItems = async function(totalAmount) {
            // Get selected address option
            const savedAddressOption = document.querySelector('input[name="addressOption"][value="saved"]');
            const customAddressOption = document.querySelector('input[name="addressOption"][value="custom"]');
            
            let finalAddress = '';
            let finalPhone = '';
            
            if (savedAddressOption && savedAddressOption.checked) {
                // Use saved address
                if (!userAddressData || !userAddressData.phone || !userAddressData.address) {
                    showNotification('❌ Saved address is incomplete. Please use custom address option.', 'error');
                    return;
                }
                finalPhone = userAddressData.phone;
                finalAddress = `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`;
            } else if (customAddressOption && customAddressOption.checked) {
                // Use custom address
                const customPhone = document.getElementById('customPhone').value.trim();
                const customAddress = document.getElementById('customAddress').value.trim();
                const customCity = document.getElementById('customCity').value.trim();
                const customState = document.getElementById('customState').value.trim();
                const customPincode = document.getElementById('customPincode').value.trim();
                const customNearby = document.getElementById('customNearby').value.trim();
                
                // Validate custom address
                if (!customPhone || !customAddress || !customCity || !customState || !customPincode) {
                    showNotification('❌ Please fill all required address fields (Phone, Address, City, State, Pincode)', 'error');
                    return;
                }
                
                finalPhone = customPhone;
                finalAddress = `${customAddress}, ${customCity}, ${customState} - ${customPincode}${customNearby ? ', Near ' + customNearby : ''}`;
            } else {
                showNotification('❌ Please select an address option.', 'error');
                return;
            }
            
            try {
                // Create order for each cart item
                const orderPromises = cartItems.map(item => {
                    const product = productsData.find(p => p.id === item.id);
                    const deliveryCharge = product ? (product.deliveryCharge || 0) : 0;
                    const orderData = {
                        productId: item.id,
                        productName: item.name,
                        productPrice: item.price,
                        productImage: item.imageUrl,
                        productSize: item.size || '',
                        quantity: item.quantity,
                        deliveryCharge: deliveryCharge,
                        totalAmount: (item.price * item.quantity) + deliveryCharge,
                        userPhone: finalPhone,
                        userAddress: finalAddress,
                        orderDate: new Date().toLocaleDateString(),
                        status: 'Pending',
                        orderType: 'Cart Order All'
                    };
                    return saveOrderToFirebase(orderData);
                });
                
                const orderIds = await Promise.all(orderPromises);
                const successfulOrders = orderIds.filter(id => id);
                
                if (successfulOrders.length === cartItems.length) {
                    showNotification(`🎉 All orders placed successfully!<br>${successfulOrders.length} orders confirmed<br>Total amount: ₹${totalAmount}`, 'success', 6000);
                    
                    // Clear cart
                    cartItems = [];
                    localStorage.setItem('cartItems', JSON.stringify(cartItems));
                    await saveCartToFirebase(); // Save empty cart to Firebase
                    updateCartCount();
                    updateCartDisplay();
                    updateCartDisplayMain();
                    
                    // Close modal
                    closeConfirmOrderModal();
                    
                    // Switch to orders tab to show the new orders
                    setTimeout(async () => {
                        await setActiveTab('profile');
                        loadUserOrders();
                    }, 2000);
                } else {
                    showNotification('❌ Some orders failed to process. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Order confirmation error:', error);
                showNotification('❌ Error placing orders. Please try again.', 'error');
            }
        };

        // Open confirm order modal from cart
        window.openConfirmOrderModalFromCart = async function(productId) {
            const product = productsData.find(p => p.id === productId);
            const cartItem = cartItems.find(item => item.id === productId);
            
            if (!product || !cartItem) {
                showNotification('Product not found in cart.', 'error');
                return;
            }
            
            const quantity = cartItem.quantity;
            const selectedSize = cartItem.size || '';
            const currentPrice = cartItem.price;
            const deliveryCharge = product.deliveryCharge || 0;
            const subtotal = currentPrice * quantity;
            const totalAmount = subtotal + deliveryCharge;
            
            // Load user address data
            await loadUserAddressFromFirebase();
            
            const modal = document.getElementById('confirmOrderModal');
            const modalBody = document.getElementById('confirmOrderModalBody');
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Order Summary</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <img src="${product.imageUrl}" alt="${product.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50;">${product.name}</div>
                            ${selectedSize ? `<div style="color: #666; font-size: 12px;">Size: ${selectedSize}</div>` : ''}
                            <div style="color: #27ae60; font-weight: 600;">₹${currentPrice} x ${quantity} = ₹${subtotal}</div>
                            ${deliveryCharge > 0 ? `<div style="color: #666; font-size: 12px;">Delivery: ₹${deliveryCharge}</div>` : ''}
                            <div style="font-weight: 700; color: #e74c3c; font-size: 16px;">Total: ₹${totalAmount}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Delivery Address</h4>
                    
                    ${userAddressData && userAddressData.address ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                <input type="radio" name="addressOption" value="saved" checked onchange="toggleAddressForm()" style="margin-right: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #2c3e50;">Use Saved Address</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 3px; word-break: break-word;">
                                        📱 ${userAddressData.phone}<br>
                                        📍 ${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}
                                        ${userAddressData.nearby ? `<br>Near: ${userAddressData.nearby}` : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="addressOption" value="custom" ${!userAddressData || !userAddressData.address ? 'checked' : ''} onchange="toggleAddressForm()" style="margin-right: 10px;">
                            <div style="font-weight: 600; color: #2c3e50;">Use Different Address</div>
                        </label>
                    </div>
                    
                    <div id="customAddressForm" style="display: ${!userAddressData || !userAddressData.address ? 'block' : 'none'}; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Phone Number *</label>
                            <input type="tel" id="customPhone" placeholder="Enter your phone number" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.phone || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Full Address *</label>
                            <textarea id="customAddress" placeholder="Enter complete address with house/flat number, street, area" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 70px; resize: vertical; box-sizing: border-box; transition: border-color 0.3s;" rows="3" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">${userAddressData?.address || ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">State *</label>
                                <select id="customState" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'" onchange="loadCitiesForState()">
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                    <option value="Ladakh">Ladakh</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">City *</label>
                                <select id="customCity" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                                    <option value="">Select City</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Pincode *</label>
                                <input type="text" id="customPincode" placeholder="Enter pincode" maxlength="6" pattern="[0-9]{6}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.pincode || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; font-size: 13px;">Nearby Landmark</label>
                                <input type="text" id="customNearby" placeholder="Optional landmark" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.3s;" value="${userAddressData?.nearby || ''}" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="product-modal-buttons">
                    <button class="btn-order" onclick="confirmOrderWithAddressFromCart('${productId}', ${quantity}, '${selectedSize}', ${currentPrice}, ${deliveryCharge}, ${totalAmount})" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                        Confirm Order - ₹${totalAmount}
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        };

        // Confirm order with selected address
        window.confirmOrderWithAddress = async function(productId, quantity, selectedSize, currentPrice, deliveryCharge, totalAmount) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            // Get selected address option
            const savedAddressOption = document.querySelector('input[name="addressOption"][value="saved"]');
            const customAddressOption = document.querySelector('input[name="addressOption"][value="custom"]');
            
            let finalAddress = '';
            let finalPhone = '';
            
            if (savedAddressOption && savedAddressOption.checked) {
                // Use saved address
                if (!userAddressData || !userAddressData.phone || !userAddressData.address) {
                    showNotification('❌ Saved address is incomplete. Please use custom address option.', 'error');
                    return;
                }
                finalPhone = userAddressData.phone;
                finalAddress = `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`;
            } else if (customAddressOption && customAddressOption.checked) {
                // Use custom address
                const customPhone = document.getElementById('customPhone').value.trim();
                const customAddress = document.getElementById('customAddress').value.trim();
                const customCity = document.getElementById('customCity').value.trim();
                const customState = document.getElementById('customState').value.trim();
                const customPincode = document.getElementById('customPincode').value.trim();
                const customNearby = document.getElementById('customNearby').value.trim();
                
                // Validate custom address
                if (!customPhone || !customAddress || !customCity || !customState || !customPincode) {
                    showNotification('❌ Please fill all required address fields (Phone, Address, City, State, Pincode)', 'error');
                    return;
                }
                
                finalPhone = customPhone;
                finalAddress = `${customAddress}, ${customCity}, ${customState} - ${customPincode}${customNearby ? ', Near ' + customNearby : ''}`;
            } else {
                showNotification('❌ Please select an address option', 'error');
                return;
            }
            
            // Create order data
            const orderData = {
                productId: product.id,
                productName: product.name,
                productPrice: currentPrice,
                originalPrice: product.originalPrice || currentPrice,
                discount: product.discount || 0,
                productImage: product.imageUrl,
                productSize: selectedSize,
                quantity: quantity,
                deliveryCharge: deliveryCharge,
                totalAmount: totalAmount,
                userPhone: finalPhone,
                userAddress: finalAddress,
                orderDate: new Date().toLocaleDateString(),
                status: 'Pending'
            };
            
            // Save order to Firebase
            const orderId = await saveOrderToFirebase(orderData);
            if (orderId) {
                showNotification(`Order placed successfully! 🎉<br>Order ID: ${orderId}<br>Total: ₹${totalAmount}`, 'success', 6000);
                closeConfirmOrderModal();
                closeProductModal();
            } else {
                showNotification('Error placing order. Please try again.', 'error');
            }
        };

        // Confirm order with selected address from cart
        window.confirmOrderWithAddressFromCart = async function(productId, quantity, selectedSize, currentPrice, deliveryCharge, totalAmount) {
            const product = productsData.find(p => p.id === productId);
            const cartItem = cartItems.find(item => item.id === productId);
            
            if (!product || !cartItem) {
                showNotification('Product not found in cart.', 'error');
                return;
            }
            
            // Get selected address option
            const savedAddressOption = document.querySelector('input[name="addressOption"][value="saved"]');
            const customAddressOption = document.querySelector('input[name="addressOption"][value="custom"]');
            
            let finalAddress = '';
            let finalPhone = '';
            
            if (savedAddressOption && savedAddressOption.checked) {
                // Use saved address
                if (!userAddressData || !userAddressData.phone || !userAddressData.address) {
                    showNotification('❌ Saved address is incomplete. Please use custom address option.', 'error');
                    return;
                }
                finalPhone = userAddressData.phone;
                finalAddress = `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`;
            } else if (customAddressOption && customAddressOption.checked) {
                // Use custom address
                const customPhone = document.getElementById('customPhone').value.trim();
                const customAddress = document.getElementById('customAddress').value.trim();
                const customCity = document.getElementById('customCity').value.trim();
                const customState = document.getElementById('customState').value.trim();
                const customPincode = document.getElementById('customPincode').value.trim();
                const customNearby = document.getElementById('customNearby').value.trim();
                
                // Validate custom address
                if (!customPhone || !customAddress || !customCity || !customState || !customPincode) {
                    showNotification('❌ Please fill all required address fields (Phone, Address, City, State, Pincode)', 'error');
                    return;
                }
                
                finalPhone = customPhone;
                finalAddress = `${customAddress}, ${customCity}, ${customState} - ${customPincode}${customNearby ? ', Near ' + customNearby : ''}`;
            } else {
                showNotification('❌ Please select an address option', 'error');
                return;
            }
            
            // Calculate discount information
            const originalPrice = product.originalPrice || product.price;
            const discount = product.discount || 0;
            
            // Create order data
            const orderData = {
                productId: product.id,
                productName: product.name,
                productPrice: currentPrice,
                originalPrice: originalPrice,
                discount: discount,
                productImage: product.imageUrl,
                productSize: selectedSize,
                quantity: quantity,
                deliveryCharge: deliveryCharge,
                totalAmount: totalAmount,
                userPhone: finalPhone,
                userAddress: finalAddress,
                orderDate: new Date().toLocaleDateString(),
                status: 'Pending'
            };
            
            // Save order to Firebase
            const orderId = await saveOrderToFirebase(orderData);
            if (orderId) {
                // Remove item from cart after successful order (size-specific)
                removeFromCart(productId, selectedSize);
                showNotification(`Order placed successfully! 🎉<br>Order ID: ${orderId}<br>Total: ₹${totalAmount}`, 'success', 6000);
                closeConfirmOrderModal();
                closeProductModal();
            } else {
                showNotification('Error placing order. Please try again.', 'error');
            }
        };

        // Quantity control functions
        // Size selection with buttons
        window.selectSize = function(productId, selectedSize) {
            // Update hidden input
            document.getElementById(`selected-size-${productId}`).value = selectedSize;
            
            // Update button styles
            const sizeButtons = document.querySelectorAll(`#size-buttons-${productId} .size-btn`);
            sizeButtons.forEach(btn => {
                if (btn.dataset.size === selectedSize) {
                    btn.style.background = '#27ae60';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#27ae60';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#ddd';
                }
            });
            
            // Update price and total
            updatePriceBySize(productId);
            
            // Update cart button based on new size selection
            updateProductModalButtons(productId);
        };
        
        // Update price based on selected size with discount application
        window.updatePriceBySize = function(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const selectedSizeInput = document.getElementById(`selected-size-${productId}`);
            const priceContainer = document.getElementById(`price-${productId}`);
            const selectedSize = selectedSizeInput ? selectedSizeInput.value : '';
            
            let originalPrice = product.originalPrice || product.price;
            let currentPrice = product.price;
            let discount = product.discount || 0;
            
            if (selectedSize) {
                // Check if it's a regular size
                if (product.sizePricing && product.sizePricing[selectedSize]) {
                    originalPrice = product.sizePricing[selectedSize];
                    currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                }
                // Check if it's a weight-based option
                else if (selectedSize.includes('-')) {
                    const [unit, quantity] = selectedSize.split('-');
                    const weightOptions = product.weightPricing[unit];
                    const weightOption = weightOptions.find(item => item.quantity == quantity);
                    
                    if (weightOption) {
                        originalPrice = weightOption.price;
                        currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                    }
                }
            }
            
            // Update price display
            if (originalPrice > currentPrice && discount > 0) {
                priceContainer.innerHTML = `
                    <div class="special-price-label" style="color: #27ae60; font-size: 14px; font-weight: 600; margin-bottom: 5px;">Special price</div>
                    <div class="price-row" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span class="current-price" style="color: #27ae60; font-size: 24px; font-weight: 700;">₹${currentPrice.toFixed(2)}</span>
                        <span class="original-price" style="color: #999; font-size: 18px; text-decoration: line-through;">₹${originalPrice.toFixed(2)}</span>
                        <span class="discount-badge" style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${discount}% off</span>
                    </div>
                `;
            } else {
                priceContainer.innerHTML = `<div class="product-modal-price" style="color: #27ae60; font-size: 24px; font-weight: 700;">₹${currentPrice.toFixed(2)}</div>`;
            }
            updateTotalPrice(productId);
        };
        
        // Update total price with quantity and discount display
        window.updateTotalPrice = function(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const selectedSizeInput = document.getElementById(`selected-size-${productId}`);
            const quantityInput = document.getElementById(`quantity-${productId}`);
            const totalPriceDisplayElement = document.getElementById(`total-price-display-${productId}`);
            
            if (!totalPriceDisplayElement) {
                console.log('Total price display element not found for product:', productId);
                return;
            }
            
            const selectedSize = selectedSizeInput ? selectedSizeInput.value : '';
            const quantity = parseInt(quantityInput ? quantityInput.value : 1) || 1;
            
            let originalPrice = product.originalPrice || product.price;
            let currentPrice = product.price;
            let discount = product.discount || 0;
            
            if (selectedSize) {
                // Check if it's a regular size
                if (product.sizePricing && product.sizePricing[selectedSize]) {
                    originalPrice = product.sizePricing[selectedSize];
                    currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                }
                // Check if it's a weight-based option
                else if (selectedSize.includes('-')) {
                    const [unit, quantityVal] = selectedSize.split('-');
                    const weightOptions = product.weightPricing[unit];
                    const weightOption = weightOptions.find(item => item.quantity == quantityVal);
                    
                    if (weightOption) {
                        originalPrice = weightOption.price;
                        currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                    }
                }
            } else {
                // No size selected, use base price with discount
                currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
            }
            
            const totalAmount = currentPrice * quantity;
            const totalOriginalAmount = originalPrice * quantity;
            
            // Update the entire total display with discount information
            if (originalPrice > currentPrice && discount > 0) {
                totalPriceDisplayElement.innerHTML = `
                    <div style="font-size: 12px; color: #27ae60; font-weight: 600; margin-bottom: 4px;">Special Price (${quantity} items)</div>
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <span style="color: #27ae60; font-size: 20px; font-weight: 700;">₹${totalAmount.toFixed(2)}</span>
                        <span style="color: #999; font-size: 16px; text-decoration: line-through;">₹${totalOriginalAmount.toFixed(2)}</span>
                        <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${discount}% off</span>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">You save: ₹${(totalOriginalAmount - totalAmount).toFixed(2)}</div>
                `;
            } else {
                totalPriceDisplayElement.innerHTML = `
                    <div style="font-size: 20px; font-weight: 700; color: #27ae60;">₹${totalAmount.toFixed(2)}</div>
                    ${quantity > 1 ? `<div style="font-size: 11px; color: #666; margin-top: 4px;">${quantity} items × ₹${currentPrice.toFixed(2)} each</div>` : ''}
                `;
            }
        };

        window.changeQuantity = function(productId, change) {
            const quantityInput = document.getElementById(`quantity-${productId}`);
            let currentQuantity = parseInt(quantityInput.value);
            currentQuantity += change;
            
            if (currentQuantity < 1) currentQuantity = 1;
            if (currentQuantity > 10) currentQuantity = 10;
            
            quantityInput.value = currentQuantity;
            updateTotalPrice(productId);
        };
        
        // Initialize total price on modal open
        function initializeTotalPrice(productId) {
            setTimeout(() => {
                console.log('Initializing total price for product:', productId);
                updateTotalPrice(productId);
            }, 200);
        }

        // Function to update product modal buttons based on cart status (size-specific)
        function updateProductModalButtons(productId) {
            const cartBtn = document.getElementById(`cartBtn-${productId}`);
            if (!cartBtn) return;
            
            // Get currently selected size
            const selectedSizeInput = document.getElementById(`selected-size-${productId}`);
            const selectedSize = selectedSizeInput ? selectedSizeInput.value : '';
            
            // Check if this specific product with this specific size is in cart
            const isInCartWithSize = cartItems.some(item => 
                item.id === productId && item.size === selectedSize
            );
            
            if (isInCartWithSize) {
                cartBtn.textContent = 'Go to Cart';
                cartBtn.onclick = function() {
                    closeProductModal();
                    setActiveTab('cart');
                };
                cartBtn.style.background = '#27ae60';
                cartBtn.style.color = 'white';
            } else {
                cartBtn.textContent = 'Add to Cart';
                cartBtn.onclick = function() {
                    addToCartWithQuantity(productId);
                };
                cartBtn.style.background = '#3498db';
                cartBtn.style.color = 'white';
            }
        }

        // Function to go to cart section
        function goToCart() {
            closeProductModal();
            setActiveTab('cart');
        }

        // Remove duplicate - using the enhanced updateTotalPrice function above

        // Updated cart and order functions with quantity
        window.addToCartWithQuantity = async function(productId) {
            const product = productsData.find(p => p.id === productId);
            const quantityInput = document.getElementById(`quantity-${productId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Get selected size if available
            let selectedSize = '';
            const selectedSizeInput = document.getElementById(`selected-size-${productId}`);
            if (selectedSizeInput && ((product.sizes && product.sizes.length > 0) || (product.weightPricing && (product.weightPricing.ml.length > 0 || product.weightPricing.g.length > 0 || product.weightPricing.kg.length > 0)))) {
                selectedSize = selectedSizeInput.value;
                if (!selectedSize) {
                    showNotification('Please select a size/quantity before adding to cart.', 'warning');
                    return;
                }
            }
            
            if (product) {
                // Get size-specific price with discount application
                let originalPrice = product.originalPrice || product.price;
                let currentPrice = product.price; // base price
                let discount = product.discount || 0;
                
                if (selectedSize) {
                    // Check if it's a regular size
                    if (product.sizePricing && product.sizePricing[selectedSize]) {
                        originalPrice = product.sizePricing[selectedSize];
                        currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                    }
                    // Check if it's a weight-based option
                    else if (selectedSize.includes('-')) {
                        const [unit, quantity] = selectedSize.split('-');
                        const weightOptions = product.weightPricing[unit];
                        const weightOption = weightOptions.find(item => item.quantity == quantity);
                        
                        if (weightOption) {
                            originalPrice = weightOption.price;
                            currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                        }
                    }
                } else {
                    // No size selected, use base price with discount
                    currentPrice = discount > 0 ? originalPrice - (originalPrice * discount / 100) : originalPrice;
                }
                
                const existingItem = cartItems.find(item => item.id === productId && item.size === selectedSize);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cartItems.push({
                        id: product.id,
                        name: product.name,
                        price: currentPrice, // This is now the discounted price
                        originalPrice: originalPrice,
                        discount: discount,
                        imageUrl: product.imageUrl,
                        quantity: quantity,
                        size: selectedSize
                    });
                }
                
                updateCartCount();
                await saveCartToFirebase();
                const sizeText = selectedSize ? ` (Size: ${selectedSize})` : '';
                showNotification(`${quantity} x ${product.name}${sizeText} added to cart!`, 'success');
                
                // Update button state after adding to cart
                updateProductModalButtons(productId);
            }
        };

        let orderItems = [];

        // Custom notification system
        function showNotification(message, type = 'success', duration = 4000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
                ${message}
            `;
            
            container.appendChild(notification);
            
            // Show notification with animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Order function specifically for cart items (like checkout but for single item)
        window.orderFromCart = async function(productId) {
            const product = productsData.find(p => p.id === productId);
            const cartItem = cartItems.find(item => item.id === productId);
            
            if (!product || !cartItem) {
                showNotification('Product not found in cart.', 'error');
                return;
            }
            
            // Reload user address data to ensure it's current
            await loadUserAddressFromFirebase();
            
            // Check if user has address saved with stricter validation
            if (!userAddressData || 
                !userAddressData.phone || 
                !userAddressData.address || 
                userAddressData.phone.trim() === '' || 
                userAddressData.address.trim() === '') {
                
                showNotification('❌ Order cannot be placed!<br><br>📍 Please add your delivery address first:<br>1. Go to Profile section<br>2. Click "Edit Address"<br>3. Fill phone number and address<br>4. Save and try ordering again', 'error', 8000);
                
                // Automatically switch to profile section
                setTimeout(async () => {
                    await setActiveTab('profile');
                }, 1000);
                return;
            }
            
            // Use the cart item's price (which already has size-based pricing)
            const deliveryCharge = product.deliveryCharge || 0;
            const orderData = {
                productId: product.id,
                productName: product.name,
                productPrice: cartItem.price, // This is the discounted price
                originalPrice: cartItem.originalPrice || cartItem.price,
                discount: cartItem.discount || 0,
                productImage: product.imageUrl,
                productSize: cartItem.size || '',
                quantity: cartItem.quantity,
                deliveryCharge: deliveryCharge,
                totalAmount: (cartItem.price * cartItem.quantity) + deliveryCharge, // Total with discounted price
                userPhone: userAddressData ? userAddressData.phone : 'Not provided',
                userAddress: userAddressData ? userAddressData.address : 'Not provided',
                orderDate: new Date().toLocaleDateString(),
                status: 'Pending',
                orderType: 'Single Item Order'
            };
            
            // Remove item from cart immediately for real-time effect
            const itemIndex = cartItems.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                cartItems.splice(itemIndex, 1);
                updateCartCount();
                updateCartDisplay();
                updateCartDisplayMain();
            }
            
            // Close modal immediately
            closeProductModal();
            
            try {
                // Save order to Firebase
                const orderId = await saveOrderToFirebase(orderData);
                
                if (orderId) {
                    // Update cart in Firebase
                    await saveCartToFirebase();
                    
                    // Refresh Orders section in real-time
                    await loadOrdersDataFromFirebase();
                    
                    // Show success message
                    showNotification(`Order placed successfully!<br><br>Product: ${product.name}<br>Quantity: ${cartItem.quantity}<br>Total: ₹${orderData.totalAmount}`, 'success');
                    
                    console.log('Order placed:', orderData);
                } else {
                    // If order failed, add item back to cart
                    cartItems.push(cartItem);
                    updateCartCount();
                    updateCartDisplay();
                    updateCartDisplayMain();
                    showNotification('Failed to place order. Please try again.', 'error');
                }
            } catch (error) {
                // If error, add item back to cart
                cartItems.push(cartItem);
                updateCartCount();
                updateCartDisplay();
                updateCartDisplayMain();
                console.error('Order error:', error);
                showNotification('Error placing order. Please try again.', 'error');
            }
        };

        window.orderNowWithQuantity = async function(productId) {
            const product = productsData.find(p => p.id === productId);
            const quantityInput = document.getElementById(`quantity-${productId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            // Get selected size if available
            let selectedSize = '';
            const sizeSelect = document.getElementById(`size-${productId}`);
            if (sizeSelect && product.sizes && product.sizes.length > 0) {
                selectedSize = sizeSelect.value;
                if (!selectedSize) {
                    showNotification('Please select a size before placing order.', 'warning');
                    return;
                }
            }
            
            if (product) {
                // Reload user address data to ensure it's current
                await loadUserAddressFromFirebase();
                
                // Check if user has address saved with stricter validation
                if (!userAddressData || 
                    !userAddressData.phone || 
                    !userAddressData.address || 
                    userAddressData.phone.trim() === '' || 
                    userAddressData.address.trim() === '') {
                    
                    showNotification('❌ Order cannot be placed!<br><br>📍 Please add your delivery address first:<br>1. Go to Profile section<br>2. Click "Edit Address"<br>3. Fill phone number and address<br>4. Save and try ordering again', 'error', 8000);
                    
                    // Automatically switch to profile section
                    setTimeout(() => {
                        setActiveTab('profile');
                    }, 1000);
                    return;
                }
                
                // Get size-specific price
                let currentPrice = product.price; // base price
                if (selectedSize && product.sizePricing && product.sizePricing[selectedSize]) {
                    currentPrice = product.sizePricing[selectedSize];
                }
                
                const deliveryCharge = product.deliveryCharge || 0;
                
                // Calculate discount information
                const originalPrice = product.price;
                const discount = product.discount || 0;
                
                const orderData = {
                    productId: product.id,
                    productName: product.name,
                    productPrice: currentPrice,
                    originalPrice: originalPrice,
                    discount: discount,
                    productImage: product.imageUrl,
                    productSize: selectedSize,
                    quantity: quantity,
                    deliveryCharge: deliveryCharge,
                    totalAmount: (currentPrice * quantity) + deliveryCharge,
                    userPhone: userAddressData.phone,
                    userAddress: `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`,
                    orderDate: new Date().toLocaleDateString(),
                    status: 'Pending'
                };
                
                const orderId = await saveOrderToFirebase(orderData);
                if (orderId) {
                    showNotification(`Order placed successfully! 🎉<br>Order ID: ${orderId}<br>Total: ₹${orderData.totalAmount}`, 'success', 6000);
                    closeProductModal();
                } else {
                    showNotification('Error placing order. Please try again.', 'error');
                }
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeProductModal();
            }
        });

        // Show all products when clicking outside categories
        window.showAllProducts = function() {
            selectedCategory = '';
            updateProductsDisplay();
        };

        // Cart functionality - redirect to cart page
        window.openCart = function() {
            setActiveTab('cart');
        };

        window.closeCart = function() {
            // No longer needed - cart sidebar removed
        };

        window.addToCart = async function(productId) {
            if (!currentUser) {
                showNotification('Please login or register to add items to cart! 🔐', 'warning', 4000);
                showLoginModal();
                return;
            }
            
            const product = productsData.find(p => p.id === productId);
            if (product) {
                const existingItem = cartItems.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cartItems.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        imageUrl: product.imageUrl,
                        quantity: 1
                    });
                }
                updateCartCount();
                updateCartDisplay();
                updateCartDisplayMain();
                await saveCartToFirebase();
                showNotification(`${product.name} added to cart! 🛒`, 'success');
            }
        };

        // Cancel Order Function
        window.cancelOrder = async function(orderId) {
            const success = await cancelOrderFromFirebase(orderId);
            if (success) {
                showNotification('Order cancelled successfully! ❌', 'success');
                loadOrdersDataFromFirebase(); // Refresh orders list
            } else {
                showNotification('Error cancelling order. Please try again.', 'error');
            }
        };

        // Address Form Functions
        window.showAddressForm = async function() {
            const modal = document.getElementById('addressModal');
            modal.style.display = 'flex';
            
            // Load user address data in modal
            await loadUserAddressInModal();
        };

        window.closeAddressModal = function() {
            document.getElementById('addressModal').style.display = 'none';
        };


        function updateCartCount() {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            
            // Update bottom navbar cart count
            const cartCountBottom = document.getElementById('cartCountBottom');
            if (cartCountBottom) {
                cartCountBottom.textContent = totalItems;
                cartCountBottom.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const cartTotalAmount = document.getElementById('cartTotalAmount');
            
            // Check if elements exist before manipulating them
            if (!cartItemsContainer || !cartTotal || !cartTotalAmount) {
                console.log('Cart sidebar elements not found in DOM');
                return;
            }
            
            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<div class="cart-empty">🛒 Your cart is empty<br><small style="color: #999; font-size: 12px;">Browse our products and add items to see them here</small></div>';
                cartTotal.style.display = 'none';
                return;
            }
            
            cartItemsContainer.innerHTML = '';
            let total = 0;
            
            cartItems.forEach(item => {
                total += item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="cart-item-image" onclick="openProductModalFromCart('${item.id}')" style="cursor: pointer;">
                    <div class="cart-item-info" onclick="openProductModalFromCart('${item.id}')" style="cursor: pointer;">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="product-rating" style="color: #fbbf24; font-size: 12px; margin: 2px 0;">
                            ${'⭐'.repeat(item.rating || 0)} ${item.rating ? `(${item.rating})` : ''}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 4px;">Size: ${item.size || 'N/A'} | Quantity: ${item.quantity}</div>
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart('${item.id}', '${item.size}')">Remove</button>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
            
            cartTotalAmount.textContent = `Total: ₹${total}`;
            cartTotal.style.display = 'block';
        }

        // Update cart display for main page section
        function updateCartDisplayMain() {
            const cartItemsContainer = document.getElementById('cartItemsMain');
            const cartTotal = document.getElementById('cartTotalMain');
            const cartTotalAmount = document.getElementById('cartTotalAmountMain');
            
            // Check if elements exist before manipulating them
            if (!cartItemsContainer || !cartTotal || !cartTotalAmount) {
                console.log('Cart display elements not found in DOM');
                return;
            }
            
            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<div class="cart-empty-main">🛒 Your cart is empty<br>Add some products to get started!<br><small style="color: #999; font-size: 12px;">Browse our products and add items to see them here</small></div>';
                cartTotal.style.display = 'none';
                return;
            }
            
            cartItemsContainer.innerHTML = '';
            let total = 0;
            
            cartItems.forEach(item => {
                total += item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item-main';
                cartItem.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="cart-item-image-main" onclick="openProductModalFromCart('${item.id}')">
                    <div class="cart-item-info-main" onclick="openProductModalFromCart('${item.id}')">
                        <div class="cart-item-name-main">${item.name}</div>
                        <div class="product-rating" style="color: #fbbf24; font-size: 12px; margin: 2px 0;">
                            ${'⭐'.repeat(item.rating || 0)} ${item.rating ? `(${item.rating})` : ''}
                        </div>
                        <div style="color: #666; font-size: 13px; margin-top: 4px;">Size: ${item.size || 'N/A'} | Quantity: ${item.quantity}</div>
                    </div>
                    <button class="cart-item-remove-main" onclick="removeFromCart('${item.id}', '${item.size}')">Remove</button>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
            
            cartTotalAmount.textContent = `Total: ₹${total}`;
            cartTotal.style.display = 'block';
        }

        window.removeFromCart = async function(productId, size) {
            const removedItem = cartItems.find(item => item.id === productId && item.size === size);
            cartItems = cartItems.filter(item => !(item.id === productId && item.size === size));
            updateCartCount();
            updateCartDisplay();
            updateCartDisplayMain();
            await saveCartToFirebase();
            
            // Show removal notification
            if (removedItem) {
                showNotification(`${removedItem.name} (${size}) removed from cart! 🗑️`, 'success');
            }
        };

        window.checkout = async function() {
            if (cartItems.length === 0) {
                showNotification('Your cart is empty! 🛒', 'warning');
                return;
            }
            
            // Reload user address data to ensure it's current
            await loadUserAddressFromFirebase();
            
            // Check if user has address saved with stricter validation
            if (!userAddressData || 
                !userAddressData.phone || 
                !userAddressData.address || 
                userAddressData.phone.trim() === '' || 
                userAddressData.address.trim() === '') {
                
                showNotification('❌ Order cannot be placed!<br><br>📍 Please add your delivery address first:<br>1. Go to Profile section<br>2. Click "Edit Address"<br>3. Fill phone number and address<br>4. Save and try ordering again', 'error', 8000);
                
                // Automatically switch to profile section
                setTimeout(async () => {
                    await setActiveTab('profile');
                }, 1000);
                return;
            }
            
            const total = cartItems.reduce((sum, item) => {
                const product = productsData.find(p => p.id === item.id);
                const deliveryCharge = product ? (product.deliveryCharge || 0) : 0;
                return sum + (item.price * item.quantity) + deliveryCharge;
            }, 0);
            
            // Create order for each cart item
            const orderPromises = cartItems.map(item => {
                const product = productsData.find(p => p.id === item.id);
                const deliveryCharge = product ? (product.deliveryCharge || 0) : 0;
                const orderData = {
                    productId: item.id,
                    productName: item.name,
                    productPrice: item.price, // This is the discounted price
                    originalPrice: item.originalPrice || item.price,
                    discount: item.discount || 0,
                    productImage: item.imageUrl,
                    productSize: item.size || '',
                    quantity: item.quantity,
                    deliveryCharge: deliveryCharge,
                    totalAmount: (item.price * item.quantity) + deliveryCharge, // Total with discounted price
                    userPhone: userAddressData.phone,
                    userAddress: `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`,
                    orderDate: new Date().toLocaleDateString(),
                    status: 'Pending',
                    orderType: 'Cart Checkout'
                };
                return saveOrderToFirebase(orderData);
            });
            
            try {
                const orderIds = await Promise.all(orderPromises);
                const successfulOrders = orderIds.filter(id => id);
                
                if (successfulOrders.length === cartItems.length) {
                    showNotification(`Checkout successful! 🎉<br>${successfulOrders.length} orders placed<br>Total amount: ₹${total}`, 'success', 6000);
                    cartItems = [];
                    updateCartCount();
                    updateCartDisplay();
                    updateCartDisplayMain();
                    await saveCartToFirebase(); // Clear cart in Firebase
                    
                    // Refresh Orders section in real-time
                    await loadOrdersDataFromFirebase();
                    
                    closeCart();
                } else {
                    showNotification('Some orders failed to process. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Error during checkout. Please try again.', 'error');
            }
        };

        window.orderNow = async function(productId) {
            if (!currentUser) {
                showNotification('Please login or register to place orders! 🔐', 'warning', 4000);
                showLoginModal();
                return;
            }
            
            const product = productsData.find(p => p.id === productId);
            if (product) {
                // Reload user address data to ensure it's current
                await loadUserAddressFromFirebase();
                
                // Check if user has address saved with stricter validation
                if (!userAddressData || 
                    !userAddressData.phone || 
                    !userAddressData.address || 
                    userAddressData.phone.trim() === '' || 
                    userAddressData.address.trim() === '') {
                    
                    showNotification('❌ Order cannot be placed!<br><br>📍 Please add your delivery address first:<br>1. Go to Profile section<br>2. Click "Edit Address"<br>3. Fill phone number and address<br>4. Save and try ordering again', 'error', 8000);
                    
                    // Automatically switch to profile section
                    setTimeout(() => {
                        setActiveTab('profile');
                    }, 1000);
                    return;
                }
                
                const orderData = {
                    productId: product.id,
                    productName: product.name,
                    productPrice: product.price,
                    originalPrice: product.originalPrice || product.price,
                    discount: product.discount || 0,
                    productImage: product.imageUrl,
                    quantity: 1,
                    totalAmount: product.price,
                    userPhone: userAddressData.phone,
                    userAddress: `${userAddressData.address}, ${userAddressData.city}, ${userAddressData.state} - ${userAddressData.pincode}${userAddressData.nearby ? ', Near ' + userAddressData.nearby : ''}`,
                    orderDate: new Date().toLocaleDateString(),
                    status: 'Pending'
                };
                
                const orderId = await saveOrderToFirebase(orderData);
                if (orderId) {
                    showNotification(`Order placed successfully! 🎉<br>Order ID: ${orderId}<br>Total: ₹${orderData.totalAmount}`, 'success', 6000);
                } else {
                    showNotification('Error placing order. Please try again.', 'error');
                }
            }
        };

        // Check authentication before accessing protected features
        window.checkAuthAndSetTab = function(tab) {
            console.log('checkAuthAndSetTab called with:', tab, 'currentUser:', currentUser);
            if (!currentUser) {
                showNotification('Please login or register to use app features! 🔐', 'warning', 4000);
                showLoginModal();
                return;
            }
            console.log('User authenticated, setting tab:', tab);
            setActiveTab(tab);
        };

        // App Navigation functionality
        window.setActiveTab = async function(tab) {
            console.log('Setting active tab:', tab);
            
            // Add to navigation history and browser history
            if (navigationHistory[currentHistoryIndex] !== tab) {
                navigationHistory.push(tab);
                currentHistoryIndex = navigationHistory.length - 1;
                history.pushState({section: tab}, '', `#${tab}`);
            }
            
            // Close category modal if open
            const categoryModal = document.getElementById('categoryModal');
            if (categoryModal && categoryModal.style.display !== 'none') {
                closeCategoryModal();
            }
            
            
            // Remove active class from all tabs
            document.querySelectorAll('.app-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked tab - find the correct nav item
            const navItems = document.querySelectorAll('.app-nav-item');
            navItems.forEach(item => {
                const label = item.querySelector('.app-nav-label');
                if (label && label.textContent.toLowerCase() === tab.toLowerCase()) {
                    item.classList.add('active');
                }
            });
            
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Close all modals after section switching
            setTimeout(() => {
                closeProductModal();
                closeConfirmOrderModal();
                closeSidebar();
                closeCartModal();
            }, 50);
            
            // Show selected section
            switch(tab) {
                case 'home':
                    document.getElementById('homeSection').classList.add('active');
                    break;
                case 'search':
                    document.getElementById('searchSection').classList.add('active');
                    loadAllProductsInSearch();
                    break;
                case 'cart':
                    document.getElementById('cartSection').classList.add('active');
                    // Add delay to ensure DOM is ready
                    setTimeout(() => {
                        loadCartFromFirebase();
                    }, 100);
                    break;
                case 'orders':
                    document.getElementById('ordersSection').classList.add('active');
                    loadOrdersDataFromFirebase();
                    break;
                case 'profile':
                    document.getElementById('profileSection').classList.add('active');
                    updateProfileInfo();
                    loadAddressInProfileSection();
                    break;
            }
        };

        // Show section function
        window.showSection = function(tab) {
            // Update bottom navbar active states
            document.querySelectorAll('.app-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to correct bottom nav item
            const navItems = document.querySelectorAll('.app-nav-item');
            navItems.forEach(item => {
                const label = item.querySelector('.app-nav-label');
                if (label && label.textContent.toLowerCase() === tab.toLowerCase()) {
                    item.classList.add('active');
                }
            });
            
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Close all modals after section switching
            setTimeout(() => {
                closeProductModal();
                closeConfirmOrderModal();
                closeSidebar();
                closeCartModal();
            }, 50);
            
            // Show selected section
            switch(tab) {
                case 'home':
                    document.getElementById('homeSection').classList.add('active');
                    break;
                case 'search':
                    document.getElementById('searchSection').classList.add('active');
                    loadAllProductsInSearch();
                    break;
                case 'cart':
                    document.getElementById('cartSection').classList.add('active');
                    // Add delay to ensure DOM is ready
                    setTimeout(() => {
                        loadCartFromFirebase();
                    }, 100);
                    break;
                case 'orders':
                    document.getElementById('ordersSection').classList.add('active');
                    loadOrdersDataFromFirebase();
                    break;
                case 'profile':
                    document.getElementById('profileSection').classList.add('active');
                    updateProfileInfo();
                    loadAddressInProfileSection();
                    break;
            }
        };

        // Redirect to search section when clicking home page search bar
        window.redirectToSearch = function() {
            const searchInput = document.getElementById('mainSearchInput');
            const searchTerm = searchInput.value.trim();
            
            // Switch to search section
            showSection('search');
            
            // If there's a search term, transfer it and search
            if (searchTerm) {
                const searchPageInput = document.getElementById('searchInput');
                if (searchPageInput) {
                    searchPageInput.value = searchTerm;
                    performSearch();
                }
            } else {
                // Load all products in search section
                loadAllProductsInSearch();
            }
        };

        // Handle keyup events on home page search bar
        window.handleMainSearchKeyup = function(event) {
            if (event.key === 'Enter') {
                redirectToSearch();
            }
        };

        // Search functionality
        window.performSearch = function() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm) {
                searchProductsInSection(searchTerm);
            } else {
                loadAllProductsInSearch();
            }
        };

        // Add real-time search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    if (searchTerm) {
                        searchProductsInSection(searchTerm);
                    } else {
                        loadAllProductsInSearch();
                    }
                });
            }
        });

        function loadAllProductsInSearch() {
            const searchProductsGrid = document.getElementById('searchProductsGrid');
            if (!searchProductsGrid) return;
            
            searchProductsGrid.innerHTML = '';
            
            productsData.forEach(product => {
                const productCard = createProductCard(product);
                searchProductsGrid.appendChild(productCard);
            });
        }

        function searchProductsInSection(searchTerm) {
            const filteredProducts = productsData.filter(product => 
                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (product.category && product.category.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            const searchProductsGrid = document.getElementById('searchProductsGrid');
            if (!searchProductsGrid) return;
            
            searchProductsGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                searchProductsGrid.innerHTML = `<p style="text-align: center; color: #666; grid-column: 1 / -1; padding: 40px;">No products found for "${searchTerm}".</p>`;
                return;
            }
            
            filteredProducts.forEach(product => {
                const productCard = createProductCard(product);
                searchProductsGrid.appendChild(productCard);
            });
        }

        function createProductCard(product) {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.onclick = () => openProductModal(product.id);
            
            // Create pricing display with discount
            const originalPrice = product.originalPrice;
            const currentPrice = product.price;
            const discount = product.discount;
            
            let priceHTML = '';
            if (originalPrice && originalPrice > currentPrice && discount > 0) {
                priceHTML = `
                    <div class="product-price-container">
                        <div class="special-price-label" style="color: #27ae60; font-size: 12px; font-weight: 600; margin-bottom: 2px;">Special price</div>
                        <div class="price-row" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span class="current-price" style="color: #27ae60; font-size: 18px; font-weight: 700;">₹${currentPrice}</span>
                            <span class="original-price" style="color: #999; font-size: 14px; text-decoration: line-through;">₹${originalPrice}</span>
                            <span class="discount-badge" style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600;">${discount}% off</span>
                        </div>
                    </div>
                `;
            } else {
                priceHTML = `<div class="product-price" style="color: #27ae60; font-size: 18px; font-weight: 700;">₹${currentPrice}</div>`;
            }
            
            productCard.innerHTML = `
                <img src="${product.imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                <div class="product-info">
                    <h3 class="product-name">${product.name}</h3>
                    <div class="product-rating" style="color: #fbbf24; font-size: 14px; margin: 4px 0;">
                        ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                    </div>
                    ${priceHTML}
                    <div class="product-buttons">
                        <button class="btn-cart" onclick="event.stopPropagation(); openProductModal('${product.id}')">Add to Cart</button>
                        <button class="btn-order" onclick="event.stopPropagation(); openProductModal('${product.id}')">Order Now</button>
                    </div>
                </div>
            `;
            return productCard;
        }

        function updateProfileInfo() {
            if (currentUser) {
                document.getElementById('profileName').textContent = currentUser.displayName || 'User';
                document.getElementById('profileEmail').textContent = currentUser.email || 'user@email.com';
                document.getElementById('profileImage').src = currentUser.photoURL || '';
            }
        }

        // Load and display orders from Firebase
        async function loadOrdersDataFromFirebase() {
            const ordersContent = document.getElementById('ordersContent');
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            
            try {
                const orders = await loadOrdersFromFirebase();
                // Update global orders data for invoice functionality
                globalOrdersData = orders;
                
                if (orders.length === 0) {
                    noOrdersMessage.style.display = 'block';
                    // Clear existing orders
                    const existingOrders = ordersContent.querySelectorAll('.order-item');
                    existingOrders.forEach(order => order.remove());
                    return;
                }
                
                noOrdersMessage.style.display = 'none';
                
                // Clear existing orders except the no orders message
                const existingOrders = ordersContent.querySelectorAll('.order-item');
                existingOrders.forEach(order => order.remove());
                
                orders.forEach(order => {
                    const orderElement = document.createElement('div');
                    orderElement.className = 'order-item';
                    orderElement.style.cssText = `
                        background: white;
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 15px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                        border: 1px solid #f0f0f0;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                        width: 100%;
                        box-sizing: border-box;
                        overflow: hidden;
                    `;
                    
                    // Add hover effect
                    orderElement.addEventListener('mouseenter', () => {
                        orderElement.style.transform = 'translateY(-1px)';
                        orderElement.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.12)';
                    });
                    orderElement.addEventListener('mouseleave', () => {
                        orderElement.style.transform = 'translateY(0)';
                        orderElement.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.08)';
                    });
                    
                    orderElement.innerHTML = `
                        <!-- Top section: Image + Name/Description -->
                        <div style="display: flex; gap: 12px; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex-shrink: 0;">
                                <img src="${order.productImage}" alt="${order.productName}" 
                                     style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px; background: #f8f9fa; border: 1px solid #e9ecef;"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik0yNSAyNUg0NVY0NUgyNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+Cg=='">
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="font-size: 16px; font-weight: 700; color: #2c3e50; margin: 0 0 5px 0; line-height: 1.3; word-break: break-word;">${order.productName}</h3>
                                ${(() => {
                                    const product = productsData.find(p => p.id === order.productId);
                                    const rating = product ? product.rating : 0;
                                    return rating > 0 ? `<div style="color: #fbbf24; font-size: 12px; margin: 2px 0;">${'⭐'.repeat(rating)} (${rating})</div>` : '';
                                })()}
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Order ID: <span style="font-family: monospace; background: #f8f9fa; padding: 1px 4px; border-radius: 3px;">${order.id.substring(0, 12)}...</span></div>
                                <div style="font-size: 12px; color: #666;">📅 ${order.orderDate}</div>
                            </div>
                        </div>
                        
                        <!-- Middle section: Half width for quantity/amount/size, Half width for total -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <div style="flex: 1; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 3px;">Quantity: <strong>${order.quantity}</strong></div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 3px;">Unit Price: ₹${order.productPrice}</div>
                                ${order.productSize ? `<div style="font-size: 13px; color: #666; margin-bottom: 3px;">Size: <strong>${order.productSize}</strong></div>` : ''}
                                ${order.deliveryCharge ? `<div style="font-size: 13px; color: #27ae60; font-weight: 600;">🚚 Delivery: ₹${order.deliveryCharge}</div>` : ''}
                            </div>
                            <div style="flex: 1; background: #e8f5e8; padding: 10px; border-radius: 6px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                                ${(() => {
                                    // Get product data to check for discount
                                    const product = productsData.find(p => p.id === order.productId);
                                    const hasDiscount = product && product.discount && product.discount > 0;
                                    const originalPrice = product ? product.originalPrice || product.price : order.productPrice;
                                    const discountPercent = product ? product.discount : 0;
                                    
                                    if (hasDiscount && originalPrice > order.productPrice) {
                                        const originalTotal = (originalPrice * order.quantity) + (order.deliveryCharge || 0);
                                        return `
                                            <div style="font-size: 10px; color: #999; margin-bottom: 1px;">Original Total</div>
                                            <div style="font-size: 12px; color: #999; text-decoration: line-through; margin-bottom: 2px;">₹${originalTotal}</div>
                                            <div style="font-size: 12px; color: #27ae60; margin-bottom: 2px;">Final Amount</div>
                                            <div style="font-size: 18px; font-weight: 700; color: #27ae60;">₹${order.totalAmount}</div>
                                            <div style="background: #27ae60; color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; display: inline-block; margin-top: 3px;">${discountPercent}% OFF</div>
                                        `;
                                    } else {
                                        return `
                                            <div style="font-size: 12px; color: #27ae60; margin-bottom: 2px;">Total Amount</div>
                                            <div style="font-size: 18px; font-weight: 700; color: #27ae60;">₹${order.totalAmount}</div>
                                        `;
                                    }
                                })()}
                            </div>
                        </div>
                        
                        <!-- Status section -->
                        <div style="width: 100%; margin-bottom: 15px; text-align: center;">
                            ${order.status === 'Rejected' ? `
                                <div style="display: inline-flex; align-items: center; gap: 10px; background: #f8d7da; color: #721c24; padding: 8px 20px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                    <span>❌</span>
                                    ${order.status}
                                </div>
                            ` : `
                                <img src="${order.status === 'Pending' ? 'pending.png' : (order.status === 'Shipped' ? 'shipped.png' : 'complete.png')}" 
                                     alt="${order.status}" 
                                     style="width: 100%; height: 60px; object-fit: contain; border-radius: 8px;"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgMjAwIDYwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjhmOWZhIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPiR7b3JkZXIuc3RhdHVzfTwvdGV4dD4KPHN2Zz4K'">
                            `}
                        </div>
                        
                        <!-- Delivery info -->
                        <div style="background: #f0f8ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; color: #666;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: #2c3e50;">🚚 Delivery Information:</div>
                            <div style="margin-bottom: 3px;">📞 Phone: ${order.userPhone || 'Not provided'}</div>
                            <div>📍 Address: ${order.userAddress || 'Not provided'}</div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <!-- Invoice button: Show for all orders -->
                            <button onclick="showInvoice('${order.id}')" 
                                    style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.3)'">
                                📄 Invoice
                            </button>
                            
                            <!-- Cancel button: Only show for Pending orders -->
                            ${order.status === 'Pending' ? `
                            <button onclick="cancelOrder('${order.id}')" 
                                    style="flex: 1; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(231, 76, 60, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(231, 76, 60, 0.3)'">
                                ❌ Cancel Order
                            </button>
                            ` : ''}
                        </div>
                        
                        <!-- Status display for non-pending orders -->
                        ${order.status !== 'Pending' ? `
                        <div style="margin-top: 10px;">
                        ${order.status === 'Shipped' ? `
                            <div style="width: 100%; text-align: center; padding: 12px; background: linear-gradient(135deg, #d1ecf1, #bee5eb); border-radius: 8px; color: #0c5460; font-size: 14px; font-weight: 600; border: 1px solid #b8daff;">
                                🚚 Your Order is Shipped!<br>
                                <span style="font-size: 12px; font-weight: 400;">Your order will be delivered shortly</span>
                            </div>
                        ` : order.status === 'Completed' ? `
                            <div style="width: 100%; text-align: center; padding: 12px; background: #d4edda; border-radius: 8px; color: #155724; font-size: 14px; font-weight: 600;">
                                ✅ Order Delivered Successfully!<br>
                                <span style="font-size: 12px; font-weight: 400;">Thank you for your order!</span><br>
                            ⏰ Auto-delete in: <span id="countdown-${order.id}">Loading...</span>
                            </div>
                        ` : order.status === 'Rejected' ? `
                            <div style="width: 100%; text-align: center; padding: 12px; background: #f8d7da; border-radius: 8px; color: #721c24; font-size: 14px; font-weight: 600;">
                                ❌ Order Rejected<br>
                                <span style="font-size: 12px; font-weight: 400;">Sorry, your order was rejected</span><br>
                            ⏰ Auto-delete in: <span id="countdown-${order.id}">Loading...</span>
                            </div>
                        ` : `
                            <div style="width: 100%; text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px; color: #666; font-size: 14px; font-weight: 600;">
                                ❌ Order Cancelled
                            </div>
                        `}
                        </div>
                        ` : ''}
                    `;
                    ordersContent.appendChild(orderElement);
                    
                    // Start countdown timer for completed/rejected/shipped orders
                    if (order.status === 'Completed' || order.status === 'Rejected' || order.status === 'Shipped') {
                        startCountdownTimer(order.id, order.completedAt || order.rejectedAt || order.shippedAt);
                    }
                });
            } catch (error) {
                console.error('Error loading orders:', error);
                noOrdersMessage.textContent = 'Error loading orders. Please try again.';
                noOrdersMessage.style.display = 'block';
            }
        }

        function searchProducts(searchTerm) {
            const filteredProducts = productsData.filter(product => 
                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.description.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const productsGrid = document.getElementById('productsGrid');
            if (!productsGrid) return;
            
            productsGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `<p style="text-align: center; color: #666; grid-column: 1 / -1;">No products found for "${searchTerm}".</p>`;
                return;
            }
            
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => openProductModal(product.id);
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-rating" style="color: #fbbf24; font-size: 14px; margin: 4px 0;">
                            ${'⭐'.repeat(product.rating || 0)} ${product.rating ? `(${product.rating})` : ''}
                        </div>
                        <div class="product-price">₹${product.price}</div>
                        <div class="product-buttons">
                            <button class="btn-cart" onclick="event.stopPropagation(); openProductModal('${product.id}')">Add to Cart</button>
                            <button class="btn-order" onclick="event.stopPropagation(); openProductModal('${product.id}')">Order Now</button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }

        // Check if user is admin
        function isAdmin(email) {
            return adminUsers.includes(email);
        }

        // Show/hide admin button based on user role
        function updateAdminVisibility(user) {
            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn && user && isAdmin(user.email)) {
                adminBtn.style.display = 'block';
            } else if (adminBtn) {
                adminBtn.style.display = 'none';
            }
        }

        // Add user to registered users list
        function addRegisteredUser(user) {
            const existingUser = registeredUsers.find(u => u.email === user.email);
            if (!existingUser) {
                registeredUsers.push({
                    name: user.displayName,
                    email: user.email,
                    isAdmin: isAdmin(user.email)
                });
                saveData();
            }
        }

        // Admin Panel Functions
        window.openAdminPanel = function() {
            document.getElementById('adminPanel').style.display = 'flex';
            loadAdminData();
        };

        window.closeAdminPanel = function() {
            document.getElementById('adminPanel').style.display = 'none';
        };

        window.showTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'slides') {
                loadSlidesData();
            } else if (tabName === 'categories') {
                loadCategoriesAdminData();
            } else if (tabName === 'products') {
                loadProductsAdminData();
                
                // Add search functionality for products
                const productSearchInput = document.getElementById('productSearchInput');
                if (productSearchInput) {
                    productSearchInput.addEventListener('input', function() {
                        loadProductsAdminData();
                    });
                }
            } else if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'events') {
                loadEventsData();
                loadEventProductSelection();
                
                // Add search functionality for event products
                const searchInput = document.getElementById('eventProductSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        loadEventProductSelection(this.value);
                    });
                }
            } else if (tabName === 'ordersAdmin') {
                loadPendingOrdersForAdmin();
            }
        };

        // Slideshow Management
        window.addSlide = async function() {
            const title = document.getElementById('slideTitle').value;
            const url = document.getElementById('slideUrl').value;
            
            if (!title || !url) {
                showNotification('Please fill in both title and URL', 'warning');
                return;
            }
            
            if (slidesData.length >= 5) {
                showNotification('Maximum 5 slides allowed', 'warning');
                return;
            }
            
            // Add to Firebase instead of localStorage
            const success = await addSlideToFirebase(title, url);
            if (success) {
                loadSlidesData();
                // Clear form
                document.getElementById('slideTitle').value = '';
                document.getElementById('slideUrl').value = '';
            } else {
                showNotification('Error adding slide. Please try again.', 'error');
            }
        };

        window.removeSlide = async function(slideId) {
            console.log('Attempting to remove slide with ID:', slideId);
            const success = await removeSlideFromFirebase(slideId);
            if (success) {
                loadSlidesData();
            } else {
                showNotification('Error removing slide. Please try again.', 'error');
            }
        }

        function loadSlidesData() {
            const slidesList = document.getElementById('slidesList');
            slidesList.innerHTML = '';
            
            slidesData.forEach((slide, index) => {
                const slideItem = document.createElement('div');
                slideItem.className = 'slide-item';
                slideItem.innerHTML = `
                    <div class="slide-info">
                        <div class="slide-title-admin">${slide.title}</div>
                        <div class="slide-url">${slide.originalUrl || slide.url}</div>
                        <small style="color: #999;">ID: ${slide.id}</small>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-danger" onclick="removeSlide('${slide.id}')">Remove</button>
                    </div>
                `;
                slidesList.appendChild(slideItem);
            });
        }

        // Event Management
        let eventsData = [];
        
        // Template preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const templateSelect = document.getElementById('eventTemplate');
            const templatePreview = document.getElementById('templatePreview');
            
            if (templateSelect && templatePreview) {
                templateSelect.addEventListener('change', function() {
                    const selectedTemplate = this.value;
                    const previews = {
                        'template-1': '<strong>🎯 Modern Scroll:</strong> Smooth horizontal scrolling with 200px cards, perfect for showcasing products',
                        'template-2': '<strong>📱 Smart Grid:</strong> Responsive grid that adapts to screen size, modern card spacing',
                        'template-4': '<strong>💎 Compact Pro:</strong> Space-efficient 140px cards with premium styling and hover effects'
                    };
                    templatePreview.innerHTML = previews[selectedTemplate] || previews['template-1'];
                });
            }
        });
        
        window.addEvent = async function() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventNameImage = document.getElementById('eventNameImage').value.trim();
            const backgroundImage = document.getElementById('eventBackgroundImage').value.trim();
            const selectedTemplate = document.getElementById('eventTemplate').value;
            const selectedTitleColor = document.getElementById('eventTitleColor').value;
            const selectedProducts = getSelectedEventProducts();
            
            if (!eventName || !backgroundImage || selectedProducts.length === 0) {
                showNotification('Please fill all fields and select at least one product', 'error');
                return;
            }
            
            // Don't set local ID - let Firebase generate the ID
            const eventData = {
                name: eventName,
                nameImage: eventNameImage,
                backgroundImage: backgroundImage,
                template: selectedTemplate,
                titleColor: selectedTitleColor,
                products: selectedProducts,
                createdAt: new Date().toISOString()
            };
            
            console.log('Adding event without local ID:', eventData);
            const success = await addEventToFirebase(eventData);
            if (success) {
                document.getElementById('eventName').value = '';
                document.getElementById('eventNameImage').value = '';
                document.getElementById('eventBackgroundImage').value = '';
                clearEventProductSelection();
                loadEventsData();
                loadEventsOnHomePage();
                showNotification('Event added successfully!', 'success');
            } else {
                showNotification('Error adding event. Please try again.', 'error');
            }
        };
        
        function getSelectedEventProducts() {
            const checkboxes = document.querySelectorAll('#eventProductSelection input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => {
                const productId = cb.value;
                return productsData.find(p => p.id === productId);
            }).filter(p => p);
        }
        
        function clearEventProductSelection() {
            const checkboxes = document.querySelectorAll('#eventProductSelection input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        window.removeEvent = async function(eventId) {
            // Add confirmation dialog
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                return;
            }
            
            console.log('=== Starting Event Removal Process ===');
            console.log('Event ID to remove:', eventId);
            console.log('Type of eventId:', typeof eventId);
            console.log('Events before removal:', eventsData.map(e => ({id: e.id, name: e.name})));
            
            const success = await removeEventFromFirebase(eventId);
            if (success) {
                console.log('Event removal successful, refreshing admin panel');
                loadEventsData();
                loadEventsOnHomePage();
                showNotification('Event removed successfully!', 'success');
                console.log('=== Event Removal Process Complete ===');
            } else {
                console.error('Event removal failed');
                showNotification('Error removing event. Please try again.', 'error');
            }
        };
        
        function loadEventsData() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';
            
            eventsData.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd;';
                eventItem.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${event.name}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Products: ${event.products.length}</div>
                            <div style="font-size: 12px; color: #999;">ID: ${event.id}</div>
                        </div>
                        <button onclick="removeEvent('${event.id}')" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Remove</button>
                    </div>
                `;
                eventsList.appendChild(eventItem);
            });
        }
        
        function loadEventProductSelection(searchTerm = '') {
            const container = document.getElementById('eventProductSelection');
            container.innerHTML = '';
            
            // Filter products based on search term
            const filteredProducts = productsData.filter(product => 
                product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.category.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            // Create grid container
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 10px;';
            
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.style.cssText = `
                    position: relative;
                    background: white;
                    border-radius: 15px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    border: 2px solid #e5e7eb;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                `;
                
                productCard.innerHTML = `
                    <div style="position: absolute; top: 8px; left: 8px; z-index: 10;">
                        <input type="checkbox" value="${product.id}" style="transform: scale(1.3); cursor: pointer;" onclick="event.stopPropagation();">
                    </div>
                    <img src="${product.imageUrl}" style="width: 100%; height: 120px; object-fit: contain; background: #f8fafc;" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZjNmNGY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OWFhMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div style="padding: 12px;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px; color: #1a202c; line-height: 1.3; height: 36px; overflow: hidden;">${product.name}</div>
                        <div style="font-size: 13px; color: #059669; font-weight: bold; margin-bottom: 2px;">₹${product.price}</div>
                        <div style="font-size: 11px; color: #666;">Category: ${product.category}</div>
                    </div>
                `;
                
                // Add click handler to toggle checkbox
                productCard.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = productCard.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        updateCardSelection(productCard, checkbox.checked);
                    }
                });
                
                // Add hover effect
                productCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
                });
                productCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.borderColor = '#e5e7eb';
                    this.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                });
                
                gridContainer.appendChild(productCard);
            });
            
            container.appendChild(gridContainer);
        }
        
        function updateCardSelection(card, isSelected) {
            if (isSelected) {
                card.style.borderColor = '#10b981';
                card.style.backgroundColor = '#f0fdf4';
            } else {
                card.style.borderColor = '#e5e7eb';
                card.style.backgroundColor = 'white';
            }
        }
        
        // Load and display events on home page
        function loadEventsOnHomePage() {
            const eventsSection = document.getElementById('eventsSection');
            eventsSection.innerHTML = '';
            
            eventsData.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                eventCard.style.backgroundImage = `url(${event.backgroundImage})`;
                
                const eventContent = document.createElement('div');
                eventContent.className = 'event-content';
                
                const eventTitle = document.createElement('div');
                eventTitle.className = 'event-title';
                
                // Check if event has nameImage, if yes show image instead of text
                if (event.nameImage && event.nameImage.trim()) {
                    const eventTitleImage = document.createElement('img');
                    eventTitleImage.src = event.nameImage;
                    eventTitleImage.alt = event.name;
                    eventTitleImage.style.maxWidth = '100%';
                    eventTitleImage.style.height = 'auto';
                    eventTitleImage.style.maxHeight = '80px';
                    eventTitleImage.style.objectFit = 'contain';
                    eventTitle.appendChild(eventTitleImage);
                } else {
                    // Fallback to text if no image provided
                    eventTitle.textContent = event.name;
                    // Apply selected title color only for text
                    if (event.titleColor) {
                        eventTitle.style.color = event.titleColor;
                    }
                }
                
                const eventProducts = document.createElement('div');
                eventProducts.className = `event-products ${event.template || 'template-1'}`;
                
                event.products.forEach(product => {
                    const productCard = createProductCard(product);
                    eventProducts.appendChild(productCard);
                });
                
                eventContent.appendChild(eventTitle);
                eventContent.appendChild(eventProducts);
                eventCard.appendChild(eventContent);
                eventsSection.appendChild(eventCard);
            });
        }

        // User Management
        window.toggleAdmin = async function(email) {
            if (email === 'moghaeashu@gmail.com') {
                showNotification('Cannot modify permanent admin', 'warning');
                return;
            }
            
            try {
                const isCurrentlyAdmin = adminUsers.includes(email);
                
                if (isCurrentlyAdmin) {
                    // Remove admin privileges
                    adminUsers = adminUsers.filter(admin => admin !== email);
                    showNotification(`Removed admin privileges from ${email}`, 'success');
                } else {
                    // Grant admin privileges
                    adminUsers.push(email);
                    showNotification(`Granted admin privileges to ${email}`, 'success');
                }
                
                // Save admin list to localStorage
                localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
                
                // Optionally save admin status to Firestore user document
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    usersSnapshot.forEach(async (userDoc) => {
                        const userData = userDoc.data();
                        if (userData.email === email) {
                            await updateDoc(doc(db, 'users', userDoc.id), {
                                isAdmin: !isCurrentlyAdmin
                            });
                        }
                    });
                } catch (firestoreError) {
                    console.log('Could not update Firestore admin status:', firestoreError);
                }
                
                // Reload users to reflect changes
                loadUsersData();
                
            } catch (error) {
                console.error('Error toggling admin status:', error);
                showNotification('Error updating admin status', 'error');
            }
        };

        async function loadUsersData() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading users...</div>';
            
            try {
                // Fetch all users from Firestore
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const allUsers = [];
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    allUsers.push({
                        uid: doc.id,
                        name: userData.name || userData.displayName || 'Unknown',
                        email: userData.email,
                        phone: userData.phone || 'N/A',
                        createdAt: userData.createdAt,
                        isAdmin: adminUsers.includes(userData.email)
                    });
                });
                
                // Clear loading message
                usersList.innerHTML = '';
                
                if (allUsers.length === 0) {
                    usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No registered users found.</div>';
                    return;
                }
                
                // Sort users by creation date (newest first)
                allUsers.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return new Date(b.createdAt.seconds * 1000) - new Date(a.createdAt.seconds * 1000);
                    }
                    return 0;
                });
                
                allUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    const isPermanentAdmin = user.email === 'moghaeashu@gmail.com';
                    const joinDate = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
                    
                    userItem.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${user.name}${user.isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-details" style="font-size: 12px; color: #666; margin-top: 5px;">
                                Phone: ${user.phone} | Joined: ${joinDate}
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${!isPermanentAdmin ? 
                                `<button class="${user.isAdmin ? 'btn-danger' : 'btn-success'}" onclick="toggleAdmin('${user.email}')">
                                    ${user.isAdmin ? 'Remove Admin' : 'Make Admin'}
                                </button>` : 
                                '<span style="color: #f39c12; font-size: 12px;">Permanent Admin</span>'
                            }
                        </div>
                    `;
                    usersList.appendChild(userItem);
                });
                
                console.log(`Loaded ${allUsers.length} users from Firestore`);
                
            } catch (error) {
                console.error('Error loading users from Firestore:', error);
                usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading users. Please try again.</div>';
            }
        }

        function loadAdminData() {
            loadSlidesData();
            loadUsersData();
            loadEventsFromFirebase().then(() => {
                loadEventsData();
            });
        }

        // Update slideshow with current data
        function updateSlideshow() {
            console.log('Updating slideshow with', slidesData.length, 'slides');
            const slideshowContainer = document.querySelector('.slideshow-container');
            const dotsContainer = document.querySelector('.dots-container');
            
            if (!slideshowContainer || !dotsContainer) {
                console.error('Slideshow containers not found');
                return;
            }
            
            // Clear existing content
            slideshowContainer.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            // If no slides, show empty message
            if (slidesData.length === 0) {
                slideshowContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #666;">No slides added yet. Admin can add slides through the admin panel.</div>';
                console.log('Showing empty state message');
                return;
            }
            
            // Create slides wrapper
            const slidesWrapper = document.createElement('div');
            slidesWrapper.className = 'slides-wrapper';
            
            // Add new slides
            slidesData.forEach((slide, index) => {
                console.log(`Adding slide ${index + 1}:`, slide.title, slide.url);
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slides';
                
                slideDiv.innerHTML = `
                    <img src="${slide.url}" 
                         alt="${slide.title}" 
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onload="console.log('Image loaded successfully:', this.src)"
                         onerror="
                            console.error('Failed to load image:', this.src);
                            const fileId = '${slide.url}'.match(/\/d\/([a-zA-Z0-9_-]+)/);
                            if (fileId && fileId[1]) {
                                console.log('Trying alternative URL format...');
                                this.src = 'https://drive.google.com/uc?export=view&id=' + fileId[1];
                                this.onerror = function() {
                                    console.log('Alternative format also failed, trying thumbnail...');
                                    this.src = 'https://drive.google.com/thumbnail?id=' + fileId[1] + '&sz=w800-h400';
                                    this.onerror = function() {
                                        console.log('All formats failed, showing placeholder');
                                        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4=';
                                    };
                                };
                            }
                         ">
                `;
                
                slidesWrapper.appendChild(slideDiv);
                
                // Add dot
                const dot = document.createElement('span');
                dot.className = 'dot';
                if (index === 0) dot.classList.add('active');
                dot.onclick = () => currentSlide(index + 1);
                dotsContainer.appendChild(dot);
            });
            
            // Add slides wrapper to container
            slideshowContainer.appendChild(slidesWrapper);
            
            // Add navigation arrows
            const prevArrow = document.createElement('button');
            prevArrow.className = 'slideshow-nav prev';
            prevArrow.innerHTML = '‹';
            prevArrow.onclick = () => changeSlide(-1);
            
            const nextArrow = document.createElement('button');
            nextArrow.className = 'slideshow-nav next';
            nextArrow.innerHTML = '›';
            nextArrow.onclick = () => changeSlide(1);
            
            slideshowContainer.appendChild(prevArrow);
            slideshowContainer.appendChild(nextArrow);
            
            // Reset slideshow
            slideIndex = 0;
            stopSlideshow();
            if (slidesData.length > 1) {
                startSlideshow();
            }
            
            console.log('Slideshow updated successfully');
        }

        // State-City mapping for Indian states
        const stateCityMap = {
            "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool", "Rajahmundry", "Tirupati", "Kadapa", "Anantapur", "Eluru"],
            "Arunachal Pradesh": ["Itanagar", "Naharlagun", "Pasighat", "Tezpur", "Bomdila", "Ziro", "Along", "Changlang", "Tezu", "Khonsa"],
            "Assam": ["Guwahati", "Silchar", "Dibrugarh", "Jorhat", "Nagaon", "Tinsukia", "Tezpur", "Bongaigaon", "Karimganj", "Sivasagar"],
            "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Purnia", "Darbhanga", "Bihar Sharif", "Arrah", "Begusarai", "Katihar"],
            "Chhattisgarh": ["Raipur", "Bhilai", "Korba", "Bilaspur", "Durg", "Rajnandgaon", "Jagdalpur", "Raigarh", "Ambikapur", "Mahasamund"],
            "Goa": ["Panaji", "Margao", "Vasco da Gama", "Mapusa", "Ponda", "Bicholim", "Curchorem", "Sanquelim", "Cuncolim", "Quepem"],
            "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Junagadh", "Gandhinagar", "Anand", "Navsari", "Morbi", "Mehsana", "Bharuch", "Vapi", "Palanpur", "Godhra", "Bhuj", "Porbandar", "Nadiad", "Surendranagar", "Gandhidham", "Veraval", "Mahesana", "Patan", "Botad", "Amreli", "Deesa", "Jetpur", "Kalol", "Dahod", "Botad", "Khambhat", "Mahuva", "Modasa", "Keshod", "Una", "Sidhpur", "Wankaner", "Limbdi", "Mandvi", "Thangadh", "Vyara", "Padra", "Lunawada", "Rajula", "Radhanpur", "Vijapur"],
            "Haryana": ["Faridabad", "Gurgaon", "Panipat", "Ambala", "Yamunanagar", "Rohtak", "Hisar", "Karnal", "Sonipat", "Panchkula"],
            "Himachal Pradesh": ["Shimla", "Dharamshala", "Solan", "Mandi", "Palampur", "Baddi", "Nahan", "Paonta Sahib", "Sundernagar", "Chamba"],
            "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Deoghar", "Phusro", "Hazaribagh", "Giridih", "Ramgarh", "Medininagar"],
            "Karnataka": ["Bangalore", "Mysore", "Hubli", "Mangalore", "Belgaum", "Gulbarga", "Davanagere", "Bellary", "Bijapur", "Shimoga", "Tumkur", "Raichur", "Bidar", "Hospet", "Gadag", "Udupi", "Bhadravati", "Hassan", "Kolar", "Mandya", "Chikmagalur", "Karwar", "Ranebennuru", "Gangavati", "Chitradurga", "Puttur", "Koppal", "Bagalkot", "Haveri", "Sirsi", "Sindhanur", "Kampli", "Kushtagi", "Bunts", "Kundapura", "Bantwal", "Sullia", "Puttur", "Madikeri", "Kushalnagar", "Virajpet", "Somwarpet", "Chikkaballapur", "Doddaballapur", "Hoskote", "Anekal"],
            "Kerala": ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kollam", "Palakkad", "Alappuzha", "Malappuram", "Kannur", "Kasaragod"],
            "Madhya Pradesh": ["Bhopal", "Indore", "Gwalior", "Jabalpur", "Ujjain", "Sagar", "Dewas", "Satna", "Ratlam", "Rewa"],
            "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Thane", "Nashik", "Aurangabad", "Solapur", "Amravati", "Kolhapur", "Sangli", "Navi Mumbai", "Kalyan", "Vasai", "Virar", "Bhiwandi", "Ahmednagar", "Latur", "Dhule", "Akola", "Satara", "Chandrapur", "Jalgaon", "Parbhani", "Jalna", "Bhusawal", "Nanded", "Warangal", "Ichalkaranji", "Panvel", "Ambernath", "Malegaon", "Mira-Bhayandar", "Ulhasnagar", "Dombivli", "Raigad", "Baramati", "Osmanabad", "Beed", "Gondia", "Wardha", "Yavatmal", "Buldhana", "Washim", "Hingoli", "Gadchiroli", "Sindhudurg", "Ratnagiri"],
            "Manipur": ["Imphal", "Thoubal", "Bishnupur", "Churachandpur", "Kakching", "Ukhrul", "Senapati", "Tamenglong", "Jiribam", "Pherzawl"],
            "Meghalaya": ["Shillong", "Tura", "Jowai", "Nongpoh", "Baghmara", "Ampati", "Resubelpara", "Nongstoin", "Mawkyrwat", "Williamnagar"],
            "Mizoram": ["Aizawl", "Lunglei", "Saiha", "Champhai", "Kolasib", "Serchhip", "Mamit", "Lawngtlai", "Saitual", "Khawzawl"],
            "Nagaland": ["Kohima", "Dimapur", "Mokokchung", "Tuensang", "Wokha", "Zunheboto", "Phek", "Kiphire", "Longleng", "Peren"],
            "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Berhampur", "Sambalpur", "Puri", "Balasore", "Bhadrak", "Baripada", "Jharsuguda"],
            "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Mohali", "Firozpur", "Batala", "Pathankot", "Moga"],
            "Rajasthan": ["Jaipur", "Jodhpur", "Kota", "Bikaner", "Ajmer", "Udaipur", "Bhilwara", "Alwar", "Bharatpur", "Sikar", "Tonk", "Sawai Madhopur", "Pali", "Barmer", "Jhunjhunu", "Dausa", "Churu", "Ganganagar", "Hanumangarh", "Jaisalmer", "Jalore", "Jhalawar", "Karauli", "Nagaur", "Pratapgarh", "Rajsamand", "Sirohi", "Dungarpur", "Banswara", "Bundi", "Chittorgarh", "Dholpur", "Mount Abu", "Pushkar", "Mandawa", "Neemrana", "Kishangarh", "Makrana", "Didwana", "Ratangarh", "Sujangarh", "Taranagar", "Nokha", "Dungargarh", "Bikaner", "Deshnoke"],
            "Sikkim": ["Gangtok", "Namchi", "Geyzing", "Mangan", "Jorethang", "Nayabazar", "Rangpo", "Singtam", "Rabongla", "Gyalshing"],
            "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Tiruppur", "Vellore", "Erode", "Thoothukkudi", "Dindigul", "Thanjavur", "Ranipet", "Sivakasi", "Karur", "Udhagamandalam", "Hosur", "Nagercoil", "Kanchipuram", "Kumarakonam", "Pudukkottai", "Ambur", "Pallavaram", "Tambaram", "Avadi", "Tiruvottiyur", "Tiruchengode", "Pollachi", "Rajapalayam", "Gudiyatham", "Vaniyambadi", "Ambattur", "Manachanallur", "Kovilpatti", "Tindivanam", "Tiruvannamalai", "Pollachi", "Karaikudi", "Kumbakonam", "Mayiladuthurai", "Cuddalore", "Chidambaram", "Tiruvarur", "Ramanathapuram", "Virudhunagar", "Aruppukkottai", "Sivaganga"],
            "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Khammam", "Karimnagar", "Ramagundam", "Mahbubnagar", "Nalgonda", "Adilabad", "Suryapet"],
            "Tripura": ["Agartala", "Dharmanagar", "Udaipur", "Kailashahar", "Belonia", "Khowai", "Pratapgarh", "Ranir Bazar", "Sonamura", "Amarpur"],
            "Uttar Pradesh": ["Lucknow", "Kanpur", "Ghaziabad", "Agra", "Varanasi", "Meerut", "Allahabad", "Bareilly", "Aligarh", "Moradabad", "Saharanpur", "Gorakhpur", "Noida", "Firozabad", "Jhansi", "Muzaffarnagar", "Mathura", "Budaun", "Rampur", "Shahjahanpur", "Farrukhabad", "Mau", "Hapur", "Etawah", "Mirzapur", "Bulandshahr", "Sambhal", "Amroha", "Hardoi", "Fatehpur", "Raebareli", "Orai", "Sitapur", "Bahraich", "Modinagar", "Unnao", "Jaunpur", "Lakhimpur", "Hathras", "Banda", "Pilibhit", "Barabanki", "Khurja", "Gonda", "Mainpuri", "Lalitpur", "Etah", "Deoria", "Ujhani", "Ghazipur", "Sultanpur", "Azamgarh", "Bijnor", "Sahaswan", "Basti", "Chandausi", "Akbarpur", "Ballia", "Tanda", "Greater Noida", "Shikohabad", "Shamli", "Awagarh", "Kasganj"],
            "Uttarakhand": ["Dehradun", "Haridwar", "Roorkee", "Haldwani", "Rudrapur", "Kashipur", "Rishikesh", "Kotdwar", "Ramnagar", "Manglaur"],
            "West Bengal": ["Kolkata", "Howrah", "Durgapur", "Asansol", "Siliguri", "Malda", "Bardhaman", "Baharampur", "Habra", "Kharagpur"],
            "Delhi": ["New Delhi", "Delhi Cantonment", "Narela", "Najafgarh", "Alipur", "Mehrauli", "Karol Bagh", "Dwarka", "Rohini", "Janakpuri"],
            "Jammu and Kashmir": ["Srinagar", "Jammu", "Baramulla", "Anantnag", "Sopore", "KathuaUdhampur", "Punch", "Rajauri", "Kupwara"],
            "Ladakh": ["Leh", "Kargil", "Nubra", "Zanskar", "Drass", "Khaltse", "Nyoma", "Durbuk", "Tangtse", "Chushul"],
            "Puducherry": ["Puducherry", "Karaikal", "Yanam", "Mahe", "Villianur", "Ariyankuppam", "Mannadipet", "Bahour", "Nettapakkam", "Kirumampakkam"],
            "Chandigarh": ["Chandigarh"],
            "Andaman and Nicobar Islands": ["Port Blair", "Bamboo Flat", "Garacharma", "Dignabad", "Ferrargunj", "Rangat", "Mayabunder", "Diglipur", "Car Nicobar", "Nancowry"],
            "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Diu", "Silvassa", "Naroli", "Dadra", "Nagar Haveli", "Khanvel", "Samarvarni", "Dudhani", "Kilvani"],
            "Lakshadweep": ["Kavaratti", "Agatti", "Minicoy", "Amini", "Andrott", "Kalpeni", "Kadmat", "Kiltan", "Chetlat", "Bitra"]
        };

        // Address Management Functions
        window.openAddressModal = function() {
            document.getElementById('addressModal').style.display = 'flex';
            loadUserAddressInModal();
        }

        window.closeAddressModal = function() {
            document.getElementById('addressModal').style.display = 'none';
        }

        window.openTermsModal = function() {
            console.log('Opening Terms Modal');
            document.getElementById('termsModal').style.display = 'flex';
        }

        window.closeTermsModal = function() {
            console.log('Closing Terms Modal');
            document.getElementById('termsModal').style.display = 'none';
        }

        window.openFAQModal = function() {
            console.log('Opening FAQ Modal');
            document.getElementById('faqModal').style.display = 'flex';
        }

        window.closeFAQModal = function() {
            console.log('Closing FAQ Modal');
            document.getElementById('faqModal').style.display = 'none';
        }

        window.closeSidebar = function() {
            // No longer needed - cart sidebar removed
        };

        window.openPrivacyModal = function() {
            console.log('Opening Privacy Modal');
            document.getElementById('privacyModal').style.display = 'flex';
        }

        window.closePrivacyModal = function() {
            console.log('Closing Privacy Modal');
            document.getElementById('privacyModal').style.display = 'none';
        }

        window.copyContactNumber = function() {
            const contactNumber = '+91 8218864803';
            navigator.clipboard.writeText(contactNumber).then(() => {
                showNotification('Contact number copied! 📋', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy number', 'error');
            });
        }

        // Function to load user address in modal
        async function loadUserAddressInModal() {
            try {
                await loadUserAddressFromFirebase();
                
                if (userAddressData) {
                    // Fill form fields with saved data
                    document.getElementById('userPhone').value = userAddressData.phone || '';
                    document.getElementById('userState').value = userAddressData.state || '';
                    document.getElementById('userCity').value = userAddressData.city || '';
                    document.getElementById('userAddress').value = userAddressData.address || '';
                    document.getElementById('userPincode').value = userAddressData.pincode || '';
                    document.getElementById('userNearby').value = userAddressData.nearby || '';
                    
                    // Update city options based on selected state
                    if (userAddressData.state) {
                        updateCityOptions(userAddressData.state);
                        // Set city after options are populated
                        setTimeout(() => {
                            document.getElementById('userCity').value = userAddressData.city || '';
                        }, 100);
                    }
                    
                    // Show current address display
                    document.getElementById('displayState').textContent = userAddressData.state || 'Not set';
                    document.getElementById('displayCity').textContent = userAddressData.city || 'Not set';
                    document.getElementById('displayAddress').textContent = userAddressData.address || 'Not set';
                    document.getElementById('displayPincode').textContent = userAddressData.pincode || 'Not set';
                    document.getElementById('displayPhone').textContent = userAddressData.phone || 'Not set';
                    document.getElementById('displayNearby').textContent = userAddressData.nearby || 'Not set';
                    
                    document.getElementById('currentAddressDisplay').style.display = 'block';
                } else {
                    // Hide current address display if no data
                    document.getElementById('currentAddressDisplay').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading address in modal:', error);
                document.getElementById('currentAddressDisplay').style.display = 'none';
            }
        }

        // Function to load address in profile section
        async function loadAddressInProfileSection() {
            try {
                await loadUserAddressFromFirebase();
                
                // Check if elements exist before updating
                const stateEl = document.getElementById('profileDisplayState');
                const cityEl = document.getElementById('profileDisplayCity');
                const pincodeEl = document.getElementById('profileDisplayPincode');
                const addressEl = document.getElementById('profileDisplayAddress');
                const nearbyEl = document.getElementById('profileDisplayNearby');
                const displayEl = document.getElementById('profileAddressDisplay');
                
                if (!stateEl || !cityEl || !pincodeEl || !addressEl || !nearbyEl || !displayEl) {
                    console.log('Profile address elements not found, skipping update');
                    return;
                }
                
                if (userAddressData) {
                    // Show address details in profile section (without phone)
                    stateEl.textContent = userAddressData.state || 'Not set';
                    cityEl.textContent = userAddressData.city || 'Not set';
                    pincodeEl.textContent = userAddressData.pincode || 'Not set';
                    addressEl.textContent = userAddressData.address || 'Not set';
                    nearbyEl.textContent = userAddressData.nearby || 'Not set';
                    
                    displayEl.style.display = 'block';
                } else {
                    // Hide address display if no data
                    displayEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading address in profile section:', error);
                const displayEl = document.getElementById('profileAddressDisplay');
                if (displayEl) {
                    displayEl.style.display = 'none';
                }
            }
        }

        window.saveUserAddress = async function() {
            const phone = document.getElementById('userPhone').value.trim();
            const state = document.getElementById('userState').value.trim();
            const city = document.getElementById('userCity').value.trim();
            const address = document.getElementById('userAddress').value.trim();
            const pincode = document.getElementById('userPincode').value.trim();
            const nearby = document.getElementById('userNearby').value.trim();
            
            // Validation
            if (!phone || !state || !city || !address || !pincode) {
                showNotification('Please fill in all required fields (Phone, State, City, Address, Pincode)', 'warning');
                return;
            }
            
            // Validate phone number format (10 digits)
            if (!/^\d{10}$/.test(phone)) {
                showNotification('Please enter a valid 10-digit phone number', 'warning');
                return;
            }
            
            // Validate pincode format (6 digits)
            if (!/^\d{6}$/.test(pincode)) {
                showNotification('Please enter a valid 6-digit pincode', 'warning');
                return;
            }
            
            const addressData = {
                phone: phone,
                state: state,
                city: city,
                address: address,
                pincode: pincode,
                nearby: nearby
            };
            
            const success = await saveUserAddressToFirebase(addressData);
            if (success) {
                userAddressData = addressData;
                showNotification('Address saved successfully! 📍', 'success');
                closeAddressModal();
                displayCurrentAddress();
                // Update profile section address display only if profile is active
                setTimeout(() => {
                    loadAddressInProfileSection();
                }, 100);
            } else {
                showNotification('Error saving address. Please try again.', 'error');
            }
        };

        function loadCurrentAddress() {
            if (userAddressData) {
                const stateSelect = document.getElementById('userState');
                const citySelect = document.getElementById('userCity');
                
                document.getElementById('userPhone').value = userAddressData.phone || '';
                stateSelect.value = userAddressData.state || '';
                
                // Load cities for the selected state
                if (userAddressData.state) {
                    updateCityOptions(userAddressData.state);
                    citySelect.value = userAddressData.city || '';
                }
                
                document.getElementById('userAddress').value = userAddressData.address || '';
                document.getElementById('userPincode').value = userAddressData.pincode || '';
                document.getElementById('userNearby').value = userAddressData.nearby || '';
                displayCurrentAddress();
            }
        }

        // Update city options based on selected state
        function updateCityOptions(selectedState) {
            const citySelect = document.getElementById('userCity');
            citySelect.innerHTML = '<option value="">Select City</option>';
            
            if (selectedState && stateCityMap[selectedState]) {
                stateCityMap[selectedState].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function displayCurrentAddress() {
            const displayDiv = document.getElementById('currentAddressDisplay');
            const displayPhone = document.getElementById('displayPhone');
            const displayState = document.getElementById('displayState');
            const displayCity = document.getElementById('displayCity');
            const displayAddress = document.getElementById('displayAddress');
            const displayPincode = document.getElementById('displayPincode');
            const displayNearby = document.getElementById('displayNearby');

            // Profile address display
            const profileDisplayDiv = document.getElementById('profileAddressDisplay');
            const profileDisplayPhone = document.getElementById('profileDisplayPhone');
            const profileDisplayState = document.getElementById('profileDisplayState');
            const profileDisplayCity = document.getElementById('profileDisplayCity');
            const profileDisplayAddress = document.getElementById('profileDisplayAddress');
            const profileDisplayPincode = document.getElementById('profileDisplayPincode');
            const profileDisplayNearby = document.getElementById('profileDisplayNearby');

            if (userAddressData && (userAddressData.phone || userAddressData.state || userAddressData.city || userAddressData.address)) {
                // Modal display
                if (displayDiv) {
                    displayDiv.style.display = 'block';
                    if (displayPhone) displayPhone.textContent = `Phone: ${userAddressData.phone || 'Not provided'}`;
                    if (displayState) displayState.textContent = `State: ${userAddressData.state || 'Not provided'}`;
                    if (displayCity) displayCity.textContent = `City: ${userAddressData.city || 'Not provided'}`;
                    if (displayAddress) displayAddress.textContent = `Address: ${userAddressData.address || 'Not provided'}`;
                    if (displayPincode) displayPincode.textContent = `Pincode: ${userAddressData.pincode || 'Not provided'}`;
                    if (displayNearby) displayNearby.textContent = `Nearby: ${userAddressData.nearby || 'Not provided'}`;
                }

                // Profile display
                if (profileDisplayDiv) {
                    profileDisplayDiv.style.display = 'block';
                    if (profileDisplayPhone) profileDisplayPhone.textContent = userAddressData.phone || 'Not provided';
                    if (profileDisplayState) profileDisplayState.textContent = userAddressData.state || 'Not provided';
                    if (profileDisplayCity) profileDisplayCity.textContent = userAddressData.city || 'Not provided';
                    if (profileDisplayAddress) profileDisplayAddress.textContent = userAddressData.address || 'Not provided';
                    if (profileDisplayPincode) profileDisplayPincode.textContent = userAddressData.pincode || 'Not provided';
                    if (profileDisplayNearby) profileDisplayNearby.textContent = userAddressData.nearby || 'Not provided';
                }
            } else {
                if (displayDiv) displayDiv.style.display = 'none';
                if (profileDisplayDiv) profileDisplayDiv.style.display = 'none';
            }
        }

        // Navigation history for back button functionality
        let navigationHistory = ['home'];
        let currentHistoryIndex = 0;
        
        // Modal stack to track open modals in order
        let modalStack = [];

        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            console.log('Popstate event:', event);
            console.log('Modal stack length:', modalStack.length);
            console.log('Current section:', document.querySelector('.tab-button.active')?.getAttribute('data-tab'));
            
            // Check if there are modals in the stack and close the last opened one
            if (modalStack.length > 0) {
                const lastModal = modalStack.pop();
                console.log('Closing modal from stack:', lastModal);
                
                switch(lastModal) {
                    case 'product':
                        closeProductModal();
                        break;
                    case 'category':
                        closeCategoryModal();
                        break;
                    case 'confirmOrder':
                        closeConfirmOrderModal();
                        break;
                    case 'cart':
                        closeCartModal();
                        break;
                    case 'invoice':
                        closeInvoice();
                        break;
                }
                return;
            }
            
            // If no modals are open, navigate to home section
            const currentActiveNav = document.querySelector('.app-nav-item.active .app-nav-label')?.textContent?.toLowerCase();
            console.log('Current active nav:', currentActiveNav);
            
            if (currentActiveNav && currentActiveNav !== 'home') {
                console.log('Navigating to home from:', currentActiveNav);
                setActiveTabWithoutHistory('home');
                return;
            } else if (!currentActiveNav || currentActiveNav === 'home') {
                // Already on home or no active tab, prevent browser back
                console.log('Already on home, preventing browser back');
                history.pushState({section: 'home'}, '', '#home');
                return;
            }
            
            if (event.state && event.state.modal) {
                // Handle modal back navigation
                if (event.state.modal === 'category') {
                    // Remove from modal stack and close modal
                    const categoryIndex = modalStack.lastIndexOf('category');
                    if (categoryIndex !== -1) {
                        modalStack.splice(categoryIndex, 1);
                    }
                    closeCategoryModal();
                } else if (event.state.modal === 'product') {
                    // Remove from modal stack and close modal
                    const productIndex = modalStack.lastIndexOf('product');
                    if (productIndex !== -1) {
                        modalStack.splice(productIndex, 1);
                    }
                    closeProductModal();
                } else if (event.state.modal === 'invoice') {
                    // Remove from modal stack and close modal
                    const invoiceIndex = modalStack.lastIndexOf('invoice');
                    if (invoiceIndex !== -1) {
                        modalStack.splice(invoiceIndex, 1);
                    }
                    closeInvoice();
                }
                return;
            } else if (event.state && event.state.section) {
                // Navigate to the previous section without adding to history
                setActiveTabWithoutHistory(event.state.section);
            } else {
                // Default back behavior
                if (navigationHistory.length > 1 && currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    setActiveTabWithoutHistory(navigationHistory[currentHistoryIndex]);
                } else {
                    // If no modals are open and user presses back, go to home section
                    if (modalStack.length === 0) {
                        setActiveTabWithoutHistory('home');
                        // Update navigation history to reflect home as current
                        if (navigationHistory[currentHistoryIndex] !== 'home') {
                            navigationHistory.push('home');
                            currentHistoryIndex = navigationHistory.length - 1;
                        }
                        // Push home state to history
                        history.pushState({section: 'home'}, '', '#home');
                    } else {
                        // If we're at the beginning of navigation history, prevent default back behavior
                        // Push current state back to prevent browser from going to previous page
                        history.pushState({section: navigationHistory[currentHistoryIndex]}, '', `#${navigationHistory[currentHistoryIndex]}`);
                        
                        // Show a subtle notification instead of closing the app
                        console.log('Already at the beginning of navigation history');
                    }
                }
            }
        });

        // Set active tab without adding to history (for back navigation)
        async function setActiveTabWithoutHistory(tab) {
            console.log('Setting active tab without history:', tab);
            
            // Close all modals first
            setTimeout(() => {
                closeProductModal();
                closeConfirmOrderModal();
                closeSidebar();
                closeCartModal();
            }, 50);
            
            // Remove active class from all tabs
            document.querySelectorAll('.app-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked tab
            const navItems = document.querySelectorAll('.app-nav-item');
            navItems.forEach(item => {
                const label = item.querySelector('.app-nav-label');
                if (label && label.textContent.toLowerCase() === tab.toLowerCase()) {
                    item.classList.add('active');
                }
            });
            
            // Hide all sections
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            switch(tab) {
                case 'home':
                    document.getElementById('homeSection').classList.add('active');
                    break;
                case 'search':
                    document.getElementById('searchSection').classList.add('active');
                    loadAllProductsInSearch();
                    break;
                case 'cart':
                    document.getElementById('cartSection').classList.add('active');
                    // Add delay to ensure DOM is ready
                    setTimeout(() => {
                        loadCartFromFirebase();
                    }, 100);
                    break;
                case 'orders':
                    document.getElementById('ordersSection').classList.add('active');
                    loadOrdersDataFromFirebase();
                    break;
                case 'profile':
                    document.getElementById('profileSection').classList.add('active');
                    updateProfileInfo();
                    loadAddressInProfileSection();
                    break;
            }
        }

        // Cart functionality and form handlers
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData(); // Load data from Firebase and localStorage
            
            // Load cart data immediately when app opens
            await loadCartFromFirebase();
            
            // Load events from Firebase and display on home page
            await loadEventsFromFirebase();
            loadEventsOnHomePage();
            
            // Add event listener for state selection
            const stateSelect = document.getElementById('userState');
            if (stateSelect) {
                stateSelect.addEventListener('change', function() {
                    const selectedState = this.value;
                    updateCityOptions(selectedState);
                });
            }
            
            const cartBtn = document.querySelector('.cart-btn');
            if (cartBtn) {
                cartBtn.addEventListener('click', function() {
                    showNotification('Cart functionality is already implemented! 🛒', 'info');
                });
            }
            
            // Add form event listeners
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const emailOrPhone = document.getElementById('loginEmailOrPhone').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!emailOrPhone || !password) {
                        showNotification('Please fill in all fields', 'error');
                        return;
                    }
                    
                    await loginWithEmailOrPhone(emailOrPhone, password);
                });
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const name = document.getElementById('registerName').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const phone = document.getElementById('registerPhone').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // Validation
                    if (!name || !email || !phone || !password || !confirmPassword) {
                        showNotification('Please fill in all fields', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showNotification('Password must be at least 6 characters', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showNotification('Passwords do not match', 'error');
                        return;
                    }
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showNotification('Please enter a valid email address', 'error');
                        return;
                    }
                    
                    const phoneRegex = /^[0-9]{10}$/;
                    if (!phoneRegex.test(phone)) {
                        showNotification('Please enter a valid 10-digit phone number', 'error');
                        return;
                    }
                    
                    await registerWithEmailAndPhone(name, email, phone, password);
                });
            }
            
            // Initialize slideshow when page loads
            setTimeout(() => {
                updateSlideshow();
            }, 500);
        });
        // Global orders data
        let globalOrdersData = [];
        
        // Invoice Modal Functions
        window.showInvoice = async function(orderId) {
            // Add to modal stack and history for back navigation
            modalStack.push('invoice');
            history.pushState({modal: 'invoice'}, '', '');
            let order = null;
            
            // First, check if order exists in admin orders (for admin panel)
            if (allAdminOrders && allAdminOrders.length > 0) {
                order = allAdminOrders.find(o => o.id === orderId);
            }
            
            // If not found in admin orders, check global orders (for user orders)
            if (!order && globalOrdersData && globalOrdersData.length > 0) {
                order = globalOrdersData.find(o => o.id === orderId);
            }
            
            // If still not found, try to load from Firebase directly
            if (!order) {
                try {
                    console.log('Order not found in cache, loading from Firebase...');
                    const orderDoc = await getDoc(doc(db, 'orders', orderId));
                    if (orderDoc.exists()) {
                        order = { id: orderDoc.id, ...orderDoc.data() };
                    } else {
                        alert('Order not found in database');
                        return;
                    }
                } catch (error) {
                    console.error('Error loading order from Firebase:', error);
                    alert('Error loading order data');
                    return;
                }
            }
            
            const invoiceModal = document.getElementById('invoiceModal');
            const invoiceContent = document.getElementById('invoiceContent');
            const printBtn = document.getElementById('printInvoiceBtn');
            
            // Generate invoice content
            invoiceContent.innerHTML = generateInvoiceHTML(order);
            
            // Show print button only on desktop (screen width > 768px)
            if (window.innerWidth > 768) {
                printBtn.style.display = 'block';
            } else {
                printBtn.style.display = 'none';
            }
            
            // Show modal
            invoiceModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        };
        
        window.closeInvoice = function() {
            // Remove from modal stack
            const invoiceIndex = modalStack.lastIndexOf('invoice');
            if (invoiceIndex !== -1) {
                modalStack.splice(invoiceIndex, 1);
            }
            
            const invoiceModal = document.getElementById('invoiceModal');
            invoiceModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        };
        
        window.printInvoice = function() {
            const printContent = document.getElementById('invoiceContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    ${printContent}
                </div>
            `;
            
            window.print();
            location.reload();
        };

        function generateInvoiceHTML(order) {
            // Fix date handling - use current date if timestamp is invalid
            let orderDate;
            try {
                if (order.timestamp) {
                    orderDate = new Date(order.timestamp).toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    orderDate = new Date().toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (error) {
                orderDate = new Date().toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let itemsHTML = '';
            let totalAmount = 0;
            
            // Handle different order data structures
            const orderItems = order.items || order.products || [];
            
            if (orderItems.length === 0) {
                // If no items array, try to create from single product data
                if (order.productName || order.name) {
                    const singleItem = {
                        name: order.productName || order.name || 'Product',
                        price: order.productPrice || order.price || order.totalAmount || 0,
                        quantity: order.quantity || 1,
                        image: order.productImage || order.image || null
                    };
                    orderItems.push(singleItem);
                }
            }
            
            orderItems.forEach(item => {
                const itemPrice = item.price || item.productPrice || 0; // This is the discounted price
                const itemQuantity = item.quantity || 1;
                const itemTotal = itemPrice * itemQuantity; // Total with discounted price
                totalAmount += itemTotal;
                
                // Get product data to get original price and discount
                const productData = productsData.find(p => p.id === (item.productId || item.id));
                const originalPrice = (item.originalPrice || (productData ? productData.originalPrice : null) || (productData ? productData.price : itemPrice));
                const discount = (item.discount || (productData ? productData.discount : 0));
                const rating = productData ? productData.rating : 0;
                
                // Handle product image with better fallback
                let productImageHTML = '';
                const productImage = item.image || item.productImage;
                
                if (productImage && productImage !== 'null' && productImage !== '') {
                    productImageHTML = `<img src="${productImage}" alt="Product" style="width: 30px; height: 30px; border-radius: 4px; object-fit: cover; margin-right: 8px;" onerror="this.style.display='none'">`;
                }
                
                // Create price display with discount information
                let priceDisplay = '';
                if (originalPrice > itemPrice && discount > 0) {
                    priceDisplay = `
                        <div style="text-align: center;">
                            <div style="font-size: 10px; color: #999; margin-bottom: 1px;">Cut Price</div>
                            <div style="color: #999; font-size: 11px; text-decoration: line-through; margin-bottom: 2px;">₹${originalPrice}</div>
                            <div style="font-size: 11px; color: #27ae60; font-weight: 600; margin-bottom: 1px;">Special Price</div>
                            <div style="color: #27ae60; font-weight: 700;">₹${itemPrice}</div>
                            <div style="background: #27ae60; color: white; padding: 2px 4px; border-radius: 3px; font-size: 10px; display: inline-block; margin-top: 2px;">${discount}% off</div>
                        </div>
                    `;
                } else {
                    priceDisplay = `₹${itemPrice}`;
                }
                
                itemsHTML += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px;">
                            <div style="display: flex; align-items: center;">
                                ${productImageHTML}
                                <div>
                                    <div>${item.name || item.productName || 'Product'}</div>
                                    ${rating > 0 ? `<div style="color: #fbbf24; font-size: 11px; margin: 1px 0;">${'⭐'.repeat(rating)} (${rating})</div>` : ''}
                                    ${item.productSize ? `<div style="color: #666; font-size: 11px;">Size: ${item.productSize}</div>` : ''}
                                    ${originalPrice > itemPrice && discount > 0 ? `<div style="color: #27ae60; font-size: 10px; font-weight: 600;">💰 Saved: ₹${(originalPrice - itemPrice) * itemQuantity}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px;">₹${itemPrice}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px;">${itemQuantity}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: 600; font-size: 13px; color: #27ae60;">₹${itemTotal}</td>
                    </tr>
                `;
            });
            
            // Fallback to order total if items calculation fails
            if (totalAmount === 0 && order.totalAmount) {
                totalAmount = order.totalAmount;
            }
            
            // Use the same delivery charge field as shown in order card
            let deliveryCharges = 'FREE';
            let deliveryAmount = 0;
            
            // Delivery charge should be applied once per order, not per quantity
            if (order.deliveryCharge && order.deliveryCharge !== 'FREE' && order.deliveryCharge !== 0) {
                deliveryAmount = parseFloat(order.deliveryCharge);
                deliveryCharges = deliveryAmount;
            }
            
            // Calculate total discount and original amount
            let totalDiscount = 0;
            let originalTotal = 0;
            
            orderItems.forEach(item => {
                const itemPrice = item.price || item.productPrice || 0;
                const itemQuantity = item.quantity || 1;
                
                // Try to get product data from the order first, then from productsData
                let productData = null;
                let originalPrice = itemPrice;
                let discount = 0;
                
                // Check if order has the product data stored
                if (order.productId) {
                    productData = productsData.find(p => p.id === order.productId);
                } else if (item.productId || item.id) {
                    productData = productsData.find(p => p.id === (item.productId || item.id));
                }
                
                // Get original price and discount from multiple sources
                if (order.originalPrice && order.discount) {
                    // From order data directly
                    originalPrice = order.originalPrice;
                    discount = order.discount;
                } else if (item.originalPrice && item.discount) {
                    // From item data
                    originalPrice = item.originalPrice;
                    discount = item.discount;
                } else if (productData && productData.originalPrice && productData.discount) {
                    // From product data
                    originalPrice = productData.originalPrice;
                    discount = productData.discount;
                } else if (productData && productData.price && productData.discount) {
                    // Fallback to product price as original
                    originalPrice = productData.price;
                    discount = productData.discount;
                }
                
                if (originalPrice > itemPrice && discount > 0) {
                    totalDiscount += (originalPrice - itemPrice) * itemQuantity;
                    originalTotal += originalPrice * itemQuantity;
                } else {
                    originalTotal += itemPrice * itemQuantity;
                }
            });
            
            const finalTotal = totalAmount + deliveryAmount;
            
            return `
                <div style="background: white; padding: 20px; max-width: 600px; margin: 0 auto;">
                    <!-- Header with Logo -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 15px;">
                        <img src="logo.png" alt="Zupisupi Logo" style="height: 50px; width: auto; margin-bottom: 10px;" onerror="this.style.display='none'">
                        <h1 style="color: #2c3e50; margin: 0; font-size: 24px; font-weight: 700;">INVOICE BILL</h1>
                        <p style="color: #7f8c8d; margin: 5px 0 0 0; font-size: 14px;">Zupisupi E-commerce</p>
                    </div>
                    
                    <!-- Invoice Details -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <h3 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 16px;">Invoice Details</h3>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Invoice #:</strong> INV-${order.id.substring(0, 8).toUpperCase()}</p>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Order ID:</strong> ${order.id}</p>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Date:</strong> ${orderDate}</p>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px; text-align: right;">
                            <h3 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 16px;">Customer Details</h3>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Name:</strong> ${order.userName || 'N/A'}</p>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Email:</strong> ${order.userEmail || 'N/A'}</p>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Phone:</strong> ${order.userPhone || 'N/A'}</p>
                            <p style="margin: 3px 0; color: #555; font-size: 13px;"><strong>Address:</strong> ${order.userAddress || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0; font-size: 16px;">Order Items</h3>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ddd; font-size: 13px;">Item</th>
                                    <th style="padding: 10px; text-align: center; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ddd; font-size: 13px;">Price</th>
                                    <th style="padding: 10px; text-align: center; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ddd; font-size: 13px;">Qty</th>
                                    <th style="padding: 10px; text-align: right; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ddd; font-size: 13px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Total Section -->
                    <div style="text-align: right; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; display: inline-block; min-width: 200px;">
                            ${totalDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #555; font-size: 13px;">Original Total:</span>
                                    <span style="font-weight: 600; color: #999; font-size: 13px; text-decoration: line-through;">₹${originalTotal + deliveryAmount}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #27ae60; font-size: 13px;">Discount:</span>
                                    <span style="font-weight: 600; color: #27ae60; font-size: 13px;">-₹${totalDiscount}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #555; font-size: 13px;">Subtotal:</span>
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">₹${totalAmount}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #555; font-size: 13px;">Delivery Charges:</span>
                                <span style="font-weight: 600; color: #27ae60; font-size: 13px;">${deliveryCharges === 'FREE' ? 'FREE' : '₹' + deliveryCharges}</span>
                            </div>
                            ${totalDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #27ae60;">
                                    <span style="font-size: 12px; font-weight: 600;">💰 You Saved:</span>
                                    <span style="font-size: 12px; font-weight: 600;">₹${totalDiscount}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #3498db;">
                                <span style="font-size: 15px; font-weight: 700; color: #2c3e50;">Grand Total:</span>
                                <span style="font-size: 15px; font-weight: 700; color: #27ae60;">₹${finalTotal}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1; color: #7f8c8d;">
                        <p style="margin: 3px 0; font-size: 12px;">Thank you for shopping with Zupisupi!</p>
                        <p style="margin: 3px 0; font-size: 11px;">For any queries, contact us at support@zupisupi.com</p>
                        <p style="margin: 10px 0 0 0; font-size: 9px; color: #bdc3c7;">This is a computer generated invoice and does not require signature.</p>
                    </div>
                </div>
            `;
        }
    </script>
    
    <!-- Invoice Modal -->
    <div id="invoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 10000; overflow-y: auto;">
        <div style="position: relative; width: 100%; height: 100%; min-height: 100vh;">
            <!-- Modal Header -->
            <div style="position: sticky; top: 0; background: white; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; z-index: 1;">
                <h2 style="margin: 0; color: #2c3e50; font-size: 20px;">Invoice Bill</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Print button - only visible on desktop -->
                    <button id="printInvoiceBtn" onclick="printInvoice()" style="background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; display: none;">
                        🖨️ Print
                    </button>
                    <button onclick="closeInvoice()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease;">
                        ✕
                    </button>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div id="invoiceContent" style="padding: 20px; height: calc(100vh - 70px); overflow-y: auto;">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>
</body>
</html>
